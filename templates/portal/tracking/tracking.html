{% extends "portal/base.html" %}

{% block title %}Rastreio de Assets{% endblock %}
{% block page_title %}Rastreio de Assets{% endblock %}

{% block breadcrumb %}
<span class="breadcrumb-separator">/</span>
<span class="breadcrumb-item">Rastreio</span>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<style>
    .tracking-container {
        display: flex;
        gap: 20px;
        height: calc(100vh - 180px);
    }

    .tracking-sidebar {
        width: 320px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        padding: 20px;
        overflow-y: auto;
    }

    .tracking-map-container {
        flex: 1;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    #map {
        width: 100%;
        height: 100%;
        border-radius: 12px;
    }

    .tracking-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 20px;
    }

    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 15px;
        border-radius: 8px;
        color: white;
    }

    .stat-card.success {
        background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
    }

    .stat-card.warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .stat-card.info {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .stat-value {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .stat-label {
        font-size: 12px;
        opacity: 0.9;
    }

    .device-filter {
        margin-bottom: 15px;
    }

    .device-filter input,
    .device-filter select {
        width: 100%;
        padding: 10px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        background-color: white;
    }

    .device-filter select:focus,
    .device-filter input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
    }

    .device-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .device-item {
        padding: 12px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .device-item:hover {
        border-color: #667eea;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        background-color: #f8f9fa;
    }
    .device-item-disabled {
        cursor: not-allowed;
        opacity: 0.75;
    }
    .device-item-disabled:hover {
        border-color: #e0e0e0;
        box-shadow: none;
        background-color: #fff;
    }

    .device-name {
        font-weight: 600;
        margin-bottom: 5px;
        color: #333;
        font-size: 14px;
    }

    .device-info {
        font-size: 12px;
        color: #666;
        margin-bottom: 3px;
    }

    .leaflet-popup-content {
        margin: 10px;
    }

    .popup-title {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 8px;
        color: #333;
    }

    .popup-info {
        font-size: 12px;
        margin-bottom: 4px;
        color: #666;
    }


    .no-devices {
        text-align: center;
        padding: 40px 20px;
        color: #999;
    }

    .custom-marker .device-marker {
        transition: all 0.3s ease;
    }

    @keyframes pulse {
        0%, 100% {
            box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7);
        }
        50% {
            box-shadow: 0 0 0 15px rgba(255, 215, 0, 0);
        }
    }

    @media (max-width: 768px) {
        .tracking-container {
            flex-direction: column;
            height: auto;
        }

        .tracking-sidebar {
            width: 100%;
            max-height: 400px;
        }

        .tracking-map-container {
            height: 500px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="tracking-container">
    <!-- Sidebar com lista de dispositivos -->
    <div class="tracking-sidebar">
        <div class="tracking-stats">
            <div class="stat-card">
                <div class="stat-value" id="totalDevices">0</div>
                <div class="stat-label">Assets Rastre√°veis</div>
            </div>
        </div>

        <!-- <div class="device-filter">
            <input type="text" id="deviceSearch" placeholder="Buscar por serial, outlet ou localidade...">
        </div> -->

        <div class="device-filter">
            <select id="subclientFilter" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                <option value="">Todos os Subclients</option>
            </select>
        </div>

        <!-- Filtros Avan√ßados (Colaps√°veis) -->
        <div style="margin-bottom: 15px; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
            <button onclick="toggleAdvancedFilters()" style="
                width: 100%;
                padding: 10px;
                background: #f5f5f5;
                border: none;
                text-align: left;
                cursor: pointer;
                font-weight: 600;
                display: flex;
                justify-content: space-between;
                align-items: center;
            ">
                üîß Filtros Avan√ßados
                <span id="filterToggleIcon">‚ñº</span>
            </button>
            <div id="advancedFiltersPanel" style="display: none; padding: 15px; background: white; border-top: 1px solid #e0e0e0;">
                <div class="device-filter">
                    <label style="font-size: 12px; font-weight: 600; color: #333; display: block; margin-bottom: 5px;">N√∫mero de Equipamento</label>
                    <input type="text" id="filterBottlerEquipmentNumber" placeholder="Ex: EQ-12345" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 13px;">
                </div>
                <div class="device-filter">
                    <label style="font-size: 12px; font-weight: 600; color: #333; display: block; margin-bottom: 5px;">Serial OEM</label>
                    <input type="text" id="filterOemSerialNumber" placeholder="Ex: SN-987654" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 13px;">
                </div>
                <div class="device-filter">
                    <label style="font-size: 12px; font-weight: 600; color: #333; display: block; margin-bottom: 5px;">Outlet</label>
                    <input type="text" id="filterOutlet" placeholder="Ex: Loja ABC" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 13px;">
                </div>
                <div class="device-filter">
                    <label style="font-size: 12px; font-weight: 600; color: #333; display: block; margin-bottom: 5px;">Canal de Com√©rcio</label>
                    <input type="text" id="filterSubTradeChannel" placeholder="Ex: Varejo" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 13px;">
                </div>
                <div class="device-filter">
                    <label style="font-size: 12px; font-weight: 600; color: #333; display: block; margin-bottom: 5px;">Cidade</label>
                    <input type="text" id="filterCity" placeholder="Ex: S√£o Paulo" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 13px;">
                </div>
                <div class="device-filter">
                    <label style="font-size: 12px; font-weight: 600; color: #333; display: block; margin-bottom: 5px;">Estado</label>
                    <input type="text" id="filterState" placeholder="Ex: SP" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 13px;">
                </div>
                <div class="device-filter">
                    <label style="font-size: 12px; font-weight: 600; color: #333; display: block; margin-bottom: 5px;">Pa√≠s</label>
                    <input type="text" id="filterCountry" placeholder="Ex: Brasil" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 13px;">
                </div>
                <div class="device-filter">
                    <label style="font-size: 12px; font-weight: 600; color: #333; display: block; margin-bottom: 5px;">Status Online</label>
                    <select id="filterIsOnline" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 13px;">
                        <option value="">Todos</option>
                        <option value="true">üü¢ Online</option>
                        <option value="false">üî¥ Offline</option>
                    </select>
                </div>
                <div class="device-filter">
                    <label style="font-size: 12px; font-weight: 600; color: #333; display: block; margin-bottom: 5px;">Status Perdido</label>
                    <select id="filterIsMissing" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 13px;">
                        <option value="">Todos</option>
                        <option value="true">‚ö†Ô∏è Perdido</option>
                        <option value="false">‚úÖ Normal</option>
                    </select>
                </div>
                <button onclick="clearAdvancedFilters()" style="
                    width: 100%;
                    padding: 8px;
                    background: #e0e0e0;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 13px;
                    font-weight: 600;
                    margin-top: 10px;
                ">üîÑ Limpar Filtros</button>
            </div>
        </div>

        <ul class="device-list" id="deviceList">
            <li class="no-devices">Carregando assets...</li>
        </ul>
    </div>

    <!-- Mapa -->
    <div class="tracking-map-container">
        <div id="map"></div>
    </div>

    <!-- Painel de Detalhes (Sidebar Direita) -->
    <div id="detailsPanel" style="
        position: fixed;
        right: -500px;
        top: 0;
        width: 500px;
        height: 100vh;
        background: white;
        box-shadow: -2px 0 12px rgba(0, 0, 0, 0.15);
        overflow-y: auto;
        transition: right 0.3s ease;
        z-index: 1000;
        border-left: 4px solid #667eea;
    ">
        <!-- Header com fechar -->
        <div style="position: sticky; top: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; color: white; z-index: 10;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2 id="detailsTitle" style="margin: 0; font-size: 20px;">Detalhes do Asset</h2>
                <button onclick="closeDetailsPanel()" style="
                    background: none;
                    border: none;
                    font-size: 28px;
                    cursor: pointer;
                    color: white;
                    padding: 0;
                    width: 32px;
                    height: 32px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    border-radius: 4px;
                ">√ó</button>
            </div>
        </div>

        <!-- Conte√∫do -->
        <div style="padding: 20px;">
            <div id="detailsContent">
                <p style="color: #999; text-align: center;">Carregando...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
    let map;
    let markers = L.markerClusterGroup();
    let allDevices = [];
    let selectedMarker = null;
    let currentSearchTerm = '';
    let currentSubclient = '';
    let searchDebounceHandle = null;
    let availableSubclients = [];

    // Inicializar o mapa
    function initMap() {
        map = L.map('map').setView([0, 0], 2);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        map.addLayer(markers);
    }

    let currentPage = 1;
    let totalPages = 1;
    let itemsPerPage = 20;
    let deviceMap = {}; // Mapa para armazenar devices por serial
    
    // Filtros iniciais da URL (se existirem)
    let initialFilters = {
        bottler_equipment_number: '{{ filters.bottler_equipment_number }}',
        oem_serial_number: '{{ filters.oem_serial_number }}',
        outlet: '{{ filters.outlet }}',
        sub_trade_channel: '{{ filters.sub_trade_channel }}',
        city: '{{ filters.city }}',
        state: '{{ filters.state }}',
        country: '{{ filters.country }}',
        is_online: '{{ filters.is_online }}',
        is_missing: '{{ filters.is_missing }}',
        subclient: '{{ filters.subclient }}'
    };

    // Carregar dispositivos com pagina√ß√£o
    async function loadDevices(page = 1, searchTerm, subclient, useOptimized = true) {
        if (typeof searchTerm === 'undefined') {
            searchTerm = currentSearchTerm;
        } else {
            currentSearchTerm = searchTerm;
        }

        if (typeof subclient === 'undefined') {
            subclient = currentSubclient;
        } else {
            currentSubclient = subclient;
        }

        try {
            let url;
            let params = new URLSearchParams();
            
            // Coletar filtros avan√ßados
            const advancedFilters = {
                bottler_equipment_number: document.getElementById('filterBottlerEquipmentNumber')?.value?.trim() || '',
                oem_serial_number: document.getElementById('filterOemSerialNumber')?.value?.trim() || '',
                outlet: document.getElementById('filterOutlet')?.value?.trim() || '',
                sub_trade_channel: document.getElementById('filterSubTradeChannel')?.value?.trim() || '',
                city: document.getElementById('filterCity')?.value?.trim() || '',
                state: document.getElementById('filterState')?.value?.trim() || '',
                country: document.getElementById('filterCountry')?.value?.trim() || '',
                is_online: document.getElementById('filterIsOnline')?.value?.trim() || '',
                is_missing: document.getElementById('filterIsMissing')?.value?.trim() || ''
            };
            
            // CORRE√á√ÉO: A l√≥gica 'useOptimized' deve ser baseada no estado *atual*
            // Se o usu√°rio limpar o filtro, deve voltar a usar a view
            const hasAdvancedFilters = Object.values(advancedFilters).some(v => v !== '');
            const isFiltering = (searchTerm && searchTerm.trim() !== '') || (subclient && subclient.trim() !== '') || hasAdvancedFilters;

            if (useOptimized && !isFiltering) {
                // Use the ultra-fast MATERIALIZED VIEW endpoint when no filters
                // load_all=true carrega TODOS os assets para o mapa (sem pagina√ß√£o)
                params.append('load_all', 'true');
                url = `/portal_associacao/tracking/devices?${params.toString()}`;
                // console.log('üöÄ Usando API otimizada (MATERIALIZED VIEW) - Carregando TODOS os assets para o mapa');
            } else {
                // Use SAME ENDPOINT but with filters applied
                // load_all=true sempre para carregar TODOS para o mapa
                params.append('load_all', 'true');
                params.append('page', page);
                
                if (searchTerm && searchTerm.trim() !== '') {
                    // Busca por texto - pode ser serial, outlet, etc
                    params.append('search', searchTerm.trim());
                }

                if (subclient && subclient.trim() !== '') {
                    // NOTA: A view n√£o tem filtro de subclient direto, 
                    // ent√£o vamos buscar por outlet que √© relacionado
                    // console.log(`üîç Filtrando por subclient: ${subclient}`);
                }
                
                // Adicionar filtros avan√ßados (estes S√ÉO suportados pela view)
                if (advancedFilters.bottler_equipment_number) {
                    params.append('bottler_equipment_number', advancedFilters.bottler_equipment_number);
                }
                if (advancedFilters.oem_serial_number) {
                    params.append('oem_serial_number', advancedFilters.oem_serial_number);
                }
                if (advancedFilters.outlet) {
                    params.append('outlet', advancedFilters.outlet);
                }
                if (advancedFilters.sub_trade_channel) {
                    params.append('sub_trade_channel', advancedFilters.sub_trade_channel);
                }
                if (advancedFilters.city) {
                    params.append('city', advancedFilters.city);
                }
                if (advancedFilters.state) {
                    params.append('state', advancedFilters.state);
                }
                if (advancedFilters.country) {
                    params.append('country', advancedFilters.country);
                }
                if (advancedFilters.is_online) {
                    params.append('is_online', advancedFilters.is_online);
                }
                if (advancedFilters.is_missing) {
                    params.append('is_missing', advancedFilters.is_missing);
                }
                
                url = `/portal_associacao/tracking/devices?${params.toString()}`;
                // console.log('üîç Usando API com filtros aplicados no backend');
            }

            // console.log('üì° Carregando:', url);
            const startTime = performance.now();

            const response = await fetch(url);

            if (!response.ok) {
                console.error('‚ùå Erro HTTP:', response.status, response.statusText);
                if (response.status === 302) {
                    console.warn('üîê Redirecionado para login - fa√ßa login novamente');
                    window.location.href = '/portal_associacao/auth/login';
                    return;
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            const loadTime = performance.now() - startTime;
            
            if (result.optimized) {
                // console.log(`‚è±Ô∏è API Otimizada carregou ${result.data.length} assets em ${loadTime.toFixed(2)}ms`);
            } else {
                // console.log(`‚è±Ô∏è API padr√£o carregou ${result.data.length} assets em ${loadTime.toFixed(2)}ms`);
            }

            if (!result.data || !result.pagination) {
                console.error('‚ùå Resposta inv√°lida:', result);
                document.getElementById('deviceList').innerHTML = '<li class="no-devices">Resposta inv√°lida do servidor</li>';
                return;
            }

            const devices = result.data;
            const pagination = result.pagination;

            // console.log(`üìä P√°gina ${pagination.page}: ${devices.length} devices`);

            // Atualizar lista de subclients dispon√≠veis
            if (result.available_subclients && result.available_subclients.length > 0) {
                updateSubclientOptions(result.available_subclients);
            }

            // Atualizar informa√ß√µes de pagina√ß√£o
            currentPage = pagination.page;
            totalPages = pagination.pages || 1;

            // Usar map_data para o mapa (todos os assets quando load_all=true)
            const mapDevices = result.map_data || devices;
            
            allDevices = devices;
            updateStats(devices, pagination.total, result.optimized);
            displayDevices(devices, pagination, result.optimized);
            addMarkersToMap(mapDevices);  // Usar map_data aqui!

            // Ajustar zoom do mapa para mostrar todos os marcadores
            if (markers.getLayers().length > 0) {
                map.fitBounds(markers.getBounds(), { padding: [50, 50] });
            }
        } catch (error) {
            console.error('‚ùå Erro ao carregar dispositivos:', error);
            document.getElementById('deviceList').innerHTML = '<li class="no-devices">Erro ao carregar dispositivos: ' + error.message + '</li>';
        }
    }

    // Atualizar estat√≠sticas
    function updateStats(devices, total = null, optimized = false) {
        // Se total for fornecido, use o total geral; sen√£o use o tamanho dos devices
        const displayTotal = total !== null ? total : devices.length;
        const label = 'Assets';
        document.getElementById('totalDevices').textContent = displayTotal;
        document.querySelector('.stat-label').textContent = label;
    }

    // Atualizar op√ß√µes de subclient
    function updateSubclientOptions(subclients) {
        const subclientSelect = document.getElementById('subclientFilter');
        const currentValue = subclientSelect.value;
        
        // Limpar op√ß√µes existentes (exceto a primeira)
        while (subclientSelect.children.length > 1) {
            subclientSelect.removeChild(subclientSelect.lastChild);
        }
        
        // Se n√£o houver subclients, desabilitar o filtro
        if (!subclients || subclients.length === 0) {
            subclientSelect.disabled = true;
            return;
        }
        
        subclientSelect.disabled = false;
        
        // Adicionar novas op√ß√µes
        subclients.forEach(subclient => {
            const option = document.createElement('option');
            // Usar subclient_code como valor e subclient_name como texto
            const code = subclient.subclient_code || subclient.subclient || '';
            const name = subclient.subclient_name || subclient.subclient_name || code;
            
            if (code) {
                option.value = code;
                option.textContent = name;
                subclientSelect.appendChild(option);
            }
        });
        
        // Restaurar valor selecionado se ainda existir
        if (currentValue) {
            const existsOption = Array.from(subclientSelect.options).some(opt => opt.value === currentValue);
            if (existsOption) {
                subclientSelect.value = currentValue;
            }
        }
        
        availableSubclients = subclients;
        // console.log(`‚úÖ ${subclients.length} subclients carregados no filtro`);
    }

    // Exibir dispositivos na lista
    function displayDevices(devices, pagination = null, optimized = false) {
        const deviceList = document.getElementById('deviceList');

        if (!devices || devices.length === 0) {
            deviceList.innerHTML = '<li class="no-devices">Nenhum asset com localiza√ß√£o dispon√≠vel</li>';
            return;
        }

        // Armazenar devices no mapa global para acesso posterior
        devices.forEach(device => {
            if (device.oem_serial_number) {
                deviceMap[device.oem_serial_number] = device;
            }
        });

        let html = devices.map(device => {
            const hasLocation = device.has_location && device.latitude !== null && device.longitude !== null;

            // Temperatura da MATERIALIZED VIEW - formatada corretamente
            let temperatureStatus = '';
            if (device.latest_cabinet_temperature_c !== null && device.latest_cabinet_temperature_c !== undefined) {
                const temp = parseFloat(device.latest_cabinet_temperature_c);
                const tempColor = temp <= 5 ? '#56ab2f' : temp <= 10 ? '#f5576c' : '#e74c3c';
                temperatureStatus = `<div class="device-info" style="color: ${tempColor};">üå°Ô∏è Temperatura: ${temp.toFixed(1)}¬∞C</div>`;
            }

            // Estat√≠sticas de porta da MATERIALIZED VIEW - formatadas corretamente
            let doorStatsStatus = '';
            if (device.door_event_average_morning || device.door_event_average_afternoon || device.door_event_average_night) {
                const morning = parseFloat(device.door_event_average_morning || 0).toFixed(1);
                const afternoon = parseFloat(device.door_event_average_afternoon || 0).toFixed(1);
                const night = parseFloat(device.door_event_average_night || 0).toFixed(1);
                doorStatsStatus = `
                    <div class="device-info" style="font-size: 12px; color: #666; margin-top: 5px;">
                        üö™ Aberturas/dia: Manh√£: ${morning} | Tarde: ${afternoon} | Noite: ${night}
                    </div>
                `;
            }

            // Status Online (CORRIGIDO: Este campo EXISTE na materialized view)
            let onlineStatus = '';
            if (device.is_online !== null && device.is_online !== undefined) {
                const onlineDisplay = device.is_online ? 'üü¢ Online' : 'üî¥ Offline';
                onlineStatus = `<div class="device-info">${onlineDisplay}</div>`;
            } else {
                onlineStatus = `<div class="device-info">‚ö™ Status n√£o dispon√≠vel</div>`;
            }

            // Status Missing (CORRIGIDO: Este campo EXISTE na materialized view)
            let missingStatus = '';
            if (device.is_missing) {
                missingStatus = `<div class="device-info" style="color: #e74c3c;">‚ö†Ô∏è Perdido</div>`;
            } else {
                missingStatus = `<div class="device-info" style="color: #56ab2f;">‚úÖ Normal</div>`;
            }

            return `
                <li class="device-item ${hasLocation ? '' : 'device-item-disabled'}" onclick="event.stopPropagation(); selectAndShowAsset('${device.oem_serial_number}')">
                    <div class="device-name" style="margin-bottom: 8px;">
                        ${device.bottler_equipment_number || 'N/A'}
                    </div>
                    
                    <div class="device-info" style="font-weight: 600; color: #667eea; margin-bottom: 6px;">
                        üìã Serial: ${device.oem_serial_number || 'N/A'}
                    </div>
                    
                    <div class="device-info" style="margin-bottom: 4px;">
                        üè™ Outlet: ${device.outlet || 'N/A'}
                    </div>
                    
                    ${device.sub_trade_channel ? `<div class="device-info" style="margin-bottom: 4px;">üè∑Ô∏è Canal: ${device.sub_trade_channel}</div>` : ''}
                    
                    <div class="device-info" style="margin-bottom: 6px;">
                        üìç Local: ${device.city || 'N/A'}${device.state ? ', ' + device.state : ''}${device.country ? ', ' + device.country : ''}
                    </div>
                    
                    ${temperatureStatus}
                    
                    ${doorStatsStatus}
                    
                    <div style="border-top: 1px solid #e0e0e0; margin: 8px 0; padding-top: 6px;">
                        ${onlineStatus}
                        ${missingStatus}
                    </div>
                </li>
            `;
        }).join('');

        // Adicionar controles de pagina√ß√£o se existir
        if (pagination && pagination.pages > 1) {
            html += `
                <li style="list-style: none; padding: 15px; text-align: center; border-top: 1px solid #e0e0e0; margin-top: 10px;">
                    <div style="display: flex; gap: 10px; justify-content: center; align-items: center;">
                        <button
                            class="btn btn-sm btn-outline"
                            onclick="loadDevices(${pagination.page - 1}, currentSearchTerm, currentSubclient, false)"
                            ${!pagination.has_prev ? 'disabled' : ''}
                            style="padding: 6px 12px; font-size: 12px;">
                            ‚Üê Anterior
                        </button>
                        <span style="font-size: 12px; min-width: 100px; text-align: center;">
                            P√°gina <strong>${pagination.page}</strong> de <strong>${pagination.pages}</strong>
                        </span>
                        <button
                            class="btn btn-sm btn-outline"
                            onclick="loadDevices(${pagination.page + 1}, currentSearchTerm, currentSubclient, false)"
                            ${!pagination.has_next ? 'disabled' : ''}
                            style="padding: 6px 12px; font-size: 12px;">
                            Pr√≥xima ‚Üí
                        </button>
                    </div>
                </li>
            `;
        }

        deviceList.innerHTML = html;
    }

    // Adicionar marcadores ao mapa
    function addMarkersToMap(devices) {
        markers.clearLayers();

        devices.forEach(device => {
            if (!device.has_location || device.latitude === null || device.longitude === null) {
                return;
            }

            // Escolher cor do marcador baseado no status
            // (CORRIGIDO: Adicionadas verifica√ß√µes de 'undefined' para campos que
            // podem n√£o existir na materialized view)
            let markerColor = '#56ab2f'; // Verde padr√£o
            
            if (device.is_missing) {
                markerColor = '#e74c3c'; // Vermelho para perdidos
            } else if (device.is_power_on === false) { // Checa se existe e √© 'false'
                markerColor = '#f39c12'; // Laranja para desligados
            } else if (device.battery_level !== null && device.battery_level !== undefined && device.battery_level < 20) {
                markerColor = '#e74c3c'; // Vermelho para bateria baixa
            } else if (device.battery_level !== null && device.battery_level !== undefined && device.battery_level < 50) {
                markerColor = '#f5576c'; // Rosa para bateria m√©dia
            } else if (device.latest_cabinet_temperature_c !== null && device.latest_cabinet_temperature_c !== undefined && device.latest_cabinet_temperature_c > 10) {
                markerColor = '#e74c3c'; // Vermelho para temperatura alta
            } else if (device.latest_cabinet_temperature_c !== null && device.latest_cabinet_temperature_c !== undefined && device.latest_cabinet_temperature_c > 5) {
                markerColor = '#f5576c'; // Rosa para temperatura moderada
            }

            const icon = L.divIcon({
                html: `<div class="device-marker" style="background-color: ${markerColor}; width: 24px; height: 24px; border-radius: 50%; border: 4px solid white; box-shadow: 0 4px 8px rgba(0,0,0,0.4);"></div>`,
                className: 'custom-marker',
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });

            const marker = L.marker([device.latitude, device.longitude], { icon: icon });

            // --- Popup Content (CORRIGIDO) ---
            // Adicionadas verifica√ß√µes tern√°rias para campos que podem n√£o
            // existir na materialized view.

            const batteryDisplay = (device.battery_level !== null && device.battery_level !== undefined && device.battery_level > 0)
                ? `<div class="popup-info"><strong>Bateria:</strong> ${device.battery_level}% (${device.battery_status || 'N/A'})</div>`
                : '';

            const powerDisplay = (device.is_power_on !== null && device.is_power_on !== undefined)
                ? `<div class="popup-info"><strong>Energia:</strong> ${device.is_power_on ? 'Ligado' : 'Desligado'}</div>`
                : '';

            const missingDisplay = device.is_missing
                ? `<div class="popup-info" style="color: #e74c3c;"><strong>Status:</strong> ‚ö†Ô∏è Perdido</div>`
                : '';

            const distanceDisplay = (device.distance_km !== null && device.distance_km !== undefined)
                ? `<div class="popup-info"><strong>Dist√¢ncia:</strong> ${parseFloat(device.distance_km).toFixed(1)}km</div>`
                : '';

            // Temperatura (Vem da View)
            const temperatureDisplay = (device.latest_cabinet_temperature_c !== null && device.latest_cabinet_temperature_c !== undefined)
                ? `<div class="popup-info"><strong>Temperatura:</strong> ${parseFloat(device.latest_cabinet_temperature_c).toFixed(1)}¬∞C</div>`
                : '';

            // Estat√≠sticas de porta (Vem da View)
            let doorStatsDisplay = '';
            if (device.door_event_average_morning || device.door_event_average_afternoon || device.door_event_average_night) {
                const morning = parseFloat(device.door_event_average_morning || 0).toFixed(1);
                const afternoon = parseFloat(device.door_event_average_afternoon || 0).toFixed(1);
                const night = parseFloat(device.door_event_average_night || 0).toFixed(1);
                doorStatsDisplay = `<div class="popup-info"><strong>Aberturas/dia:</strong> M:${morning} T:${afternoon} N:${night}</div>`;
            }

            const popupContent = `
                <div>
                    <div class="popup-title">${device.asset_type || 'Asset'}</div>
                    <div class="popup-info"><strong>Serial:</strong> ${device.oem_serial_number || 'N/A'}</div>
                    <div class="popup-info"><strong>Outlet:</strong> ${device.outlet || 'N/A'}</div>
                    ${device.outlet_code ? `<div class="popup-info"><strong>C√≥digo Outlet:</strong> ${device.outlet_code}</div>` : ''}
                    <div class="popup-info"><strong>Localidade:</strong> ${device.city || 'N/A'}${device.state ? ', ' + device.state : ''}</div>
                    ${device.street ? `<div class="popup-info"><strong>Endere√ßo:</strong> ${device.street}</div>` : ''}
                    <hr style="margin: 8px 0; border: none; border-top: 1px solid #e0e0e0;">
                    <div class="popup-info"><strong>Coordenadas:</strong> ${parseFloat(device.latitude).toFixed(6)}, ${parseFloat(device.longitude).toFixed(6)}</div>
                    ${distanceDisplay}
                    ${temperatureDisplay}
                    ${batteryDisplay}
                    ${powerDisplay}
                    ${missingDisplay}
                    ${doorStatsDisplay}
                </div>
            `;

            marker.bindPopup(popupContent);
            marker.deviceData = device; // Armazenar dados do device no marker
            markers.addLayer(marker);
        });
    }

    // Zoom para dispositivo espec√≠fico
    function zoomToDevice(lat, lng) {
        // Remover destaque do marker anterior
        if (selectedMarker) {
            try {
                const oldIcon = selectedMarker.getElement();
                if (oldIcon) {
                    const oldMarkerDiv = oldIcon.querySelector('.device-marker');
                    if (oldMarkerDiv) {
                        oldMarkerDiv.style.width = '24px';
                        oldMarkerDiv.style.height = '24px';
                        oldMarkerDiv.style.border = '4px solid white';
                        oldMarkerDiv.style.transform = 'scale(1)';
                        oldMarkerDiv.style.animation = 'none';
                    }
                }
            } catch (e) {
                console.warn("N√£o foi poss√≠vel remover destaque do marcador anterior:", e.message);
            }
        }

        // Encontrar o marker correspondente
        markers.eachLayer((marker) => {
            if (marker.getLatLng().lat === lat && marker.getLatLng().lng === lng) {
                selectedMarker = marker;

                // Destacar o marker selecionado
                try {
                    const markerElement = marker.getElement();
                    if (markerElement) {
                        const markerDiv = markerElement.querySelector('.device-marker');
                        if (markerDiv) {
                            markerDiv.style.width = '40px';
                            markerDiv.style.height = '40px';
                            markerDiv.style.border = '6px solid #FFD700';
                            markerDiv.style.transform = 'scale(1.2)';
                            markerDiv.style.animation = 'pulse 2s infinite';
                        }
                    }
                } catch (e) {
                    console.warn("N√£o foi poss√≠vel destacar o marcador:", e.message);
                }

                // Abrir popup automaticamente
                marker.openPopup();
            }
        });

        // Zoom no mapa
        map.setView([lat, lng], 17);
    }


    // Exibir detalhes do asset
    function displayAssetDetails(data) {
        const asset = data.asset;
        const movement = data.latest_movement;
        const health = data.health_data;
        const doors = data.door_events;
        const alerts = data.alerts;

        document.getElementById('detailsTitle').textContent = `${asset.oem_serial_number}`;

        let html = `
            <div style="border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; margin-bottom: 15px;">
                <h3 style="margin: 0 0 10px 0; color: #333; font-size: 16px;">${asset.asset_type}</h3>
                <div style="color: #666; font-size: 13px;">
                    <p style="margin: 5px 0;"><strong>Outlet:</strong> ${asset.outlet}</p>
                    <p style="margin: 5px 0;"><strong>Tipo:</strong> ${asset.outlet_type}</p>
                    <p style="margin: 5px 0;"><strong>Local:</strong> ${asset.city}${asset.state ? ', ' + asset.state : ''}, ${asset.country}</p>
                    <p style="margin: 5px 0;"><strong>Endere√ßo:</strong> ${asset.street}</p>
                </div>
            </div>
        `;

        // Se√ß√£o de localiza√ß√£o
        if (movement) {
            html += `
                <div style="border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #333; font-size: 14px;">üìç Localiza√ß√£o</h4>
                    <div style="color: #666; font-size: 13px;">
                        <p style="margin: 5px 0;"><strong>Coordenadas:</strong> ${movement.latitude?.toFixed(6)}, ${movement.longitude?.toFixed(6)}</p>
                        <p style="margin: 5px 0;"><strong>Deslocamento:</strong> ${movement.displacement_meter?.toFixed(2) || 'N/A'}m</p>
                        <p style="margin: 5px 0;"><strong>Acur√°cia:</strong> ${movement.accuracy_meter?.toFixed(2) || 'N/A'}m</p>
                        <p style="margin: 5px 0;"><strong>Tipo:</strong> ${movement.movement_type || 'N/A'}</p>
                        <p style="margin: 5px 0; font-size: 12px; color: #999;">Registrado em: ${new Date(movement.start_time).toLocaleString('pt-BR')}</p>
                    </div>
                </div>
            `;
        }

        // Se√ß√£o de bateria e temperatura
        if (health) {
            const batteryColor = health.battery_level > 50 ? '#56ab2f' : health.battery_level > 20 ? '#f5576c' : '#e74c3c';
            html += `
                <div style="border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #333; font-size: 14px;">üîã Sa√∫de do Equipamento</h4>
                    <div style="color: #666; font-size: 13px;">
                        <p style="margin: 5px 0;"><strong style="color: ${batteryColor};">Bateria:</strong> <span style="color: ${batteryColor}; font-weight: bold;">${health.battery_level || 'N/A'}%</span></p>
                        <p style="margin: 5px 0;"><strong>Status Bateria:</strong> ${health.battery_status || 'N/A'}</p>
                        <hr style="border: none; border-top: 1px solid #e0e0e0; margin: 10px 0;">
                        <p style="margin: 5px 0;"><strong>Temperatura C√¢mara:</strong> ${health.temperature_c?.toFixed(1) || 'N/A'}¬∞C / ${health.temperature_f?.toFixed(1) || 'N/A'}¬∞F</p>
                        <p style="margin: 5px 0;"><strong>Evaporador:</strong> ${health.evaporator_temperature_c?.toFixed(1) || 'N/A'}¬∞C</p>
                        <p style="margin: 5px 0;"><strong>Condensador:</strong> ${health.condensor_temperature_c?.toFixed(1) || 'N/A'}¬∞C</p>
                        <p style="margin: 5px 0;"><strong>Ambiente:</strong> ${health.ambient_temperature_c?.toFixed(1) || 'N/A'}¬∞C</p>
                        <p style="margin: 5px 0;"><strong>M√°xima C√¢mara:</strong> ${health.max_cabinet_temperature_c?.toFixed(1) || 'N/A'}¬∞C</p>
                        <p style="margin: 5px 0;"><strong>M√≠nima C√¢mara:</strong> ${health.min_cabinet_temperature_c?.toFixed(1) || 'N/A'}¬∞C</p>
                        <p style="margin: 5px 0; font-size: 12px; color: #999;">Registrado em: ${new Date(health.event_time).toLocaleString('pt-BR')}</p>
                    </div>
                </div>
            `;
        }

        // Se√ß√£o de portas
        html += `
            <div style="border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; margin-bottom: 15px;">
                <h4 style="margin: 0 0 10px 0; color: #333; font-size: 14px;">üö™ Aberturas de Porta</h4>
                <div style="color: #666; font-size: 13px;">
                    <p style="margin: 5px 0;"><strong>Aberturas (√∫ltimos 7 dias):</strong> ${doors.recent_count || 0}</p>
        `;
        
        if (doors.average_duration_sec) {
            html += `<p style="margin: 5px 0;"><strong>Dura√ß√£o m√©dia:</strong> ${parseFloat(doors.average_duration_sec).toFixed(1)}s</p>`;
        }
        
        if (doors.latest) {
            html += `
                <hr style="border: none; border-top: 1px solid #e0e0e0; margin: 10px 0;">
                <p style="margin: 5px 0; font-weight: bold;">√öltima abertura:</p>
                <p style="margin: 5px 0;"><strong>Porta:</strong> ${doors.latest.door || 'N/A'}</p>
                <p style="margin: 5px 0;"><strong>Dura√ß√£o:</strong> ${doors.latest.door_open_duration_sec || 0}s</p>
                <p style="margin: 5px 0;"><strong>Temperatura abertura:</strong> ${doors.latest.door_open_temperature || 'N/A'}¬∞C</p>
                <p style="margin: 5px 0;"><strong>Temperatura fechamento:</strong> ${doors.latest.door_close_temperature || 'N/A'}¬∞C</p>
                <p style="margin: 5px 0; font-size: 12px; color: #999;">Aberta em: ${new Date(doors.latest.open_event_time).toLocaleString('pt-BR')}</p>
            `;
        }
        
        html += `</div></div>`;

        // Se√ß√£o de alertas
        if (alerts.length > 0) {
            html += `
                <div style="border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #e74c3c; font-size: 14px;">‚ö†Ô∏è Alertas Ativos (${alerts.length})</h4>
                    <div style="color: #666; font-size: 13px;">
            `;
            
            alerts.forEach(alert => {
                const priorityColor = alert.priority === 'High' ? '#e74c3c' : alert.priority === 'Medium' ? '#f5576c' : '#f39c12';
                html += `
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid ${priorityColor};">
                        <p style="margin: 0 0 5px 0; font-weight: bold; color: ${priorityColor};">${alert.alert_type}</p>
                        <p style="margin: 0 0 5px 0; font-size: 12px;">${alert.alert_text}</p>
                        <p style="margin: 0 0 3px 0; font-size: 11px;"><strong>Prioridade:</strong> ${alert.priority}</p>
                        <p style="margin: 0 0 3px 0; font-size: 11px;"><strong>Tempo:</strong> ${alert.age || 'N/A'}</p>
                        <p style="margin: 0; font-size: 11px; color: #999;">Desde: ${new Date(alert.alert_at).toLocaleString('pt-BR')}</p>
                    </div>
                `;
            });
            
            html += `</div></div>`;
        } else {
            html += `
                <div style="border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #333; font-size: 14px;">‚úÖ Sem Alertas Ativos</h4>
                </div>
            `;
        }

        document.getElementById('detailsContent').innerHTML = html;
    }

    // Abrir painel de detalhes
    function openDetailsPanel() {
        const panel = document.getElementById('detailsPanel');
        panel.style.right = '0';
    }

    // Fechar painel de detalhes
    function closeDetailsPanel() {
        const panel = document.getElementById('detailsPanel');
        panel.style.right = '-500px';
    }

    // Selecionar asset e mostrar detalhes
    function selectAndShowAsset(serialNumber) {
        if (!serialNumber) {
            console.error("‚ùå Serial number √© inv√°lido.");
            return;
        }
        // console.log(`üîç Carregando detalhes para o serial: ${serialNumber}`);
        
        // Buscar o device no mapa para obter coordenadas
        const device = deviceMap[serialNumber];
        if (device && device.latitude && device.longitude) {
            // Fazer zoom e focar no mapa
            zoomToDevice(device.latitude, device.longitude);
        }
        
        loadAndShowAssetDetails(serialNumber);
    }

    // Carrega e exibe os detalhes do asset
    async function loadAndShowAssetDetails(serialNumber) {
        try {
            const response = await fetch(`/portal_associacao/tracking/asset_details/${serialNumber}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const device = await response.json();
            
            // console.log("‚úÖ Detalhes recebidos:", device);
            showAssetDetails(device);

        } catch (error) {
            console.error('‚ùå Erro ao carregar detalhes do asset:', error);
            document.getElementById('detailsContent').innerHTML = `<p style="color: #e74c3c; text-align: center;">Erro ao carregar dados: ${error.message}</p>`;
            openDetailsPanel();
        }
    }

    // Exibir detalhes do asset no painel lateral
    function showAssetDetails(device) {
        // Primeiro fazer uma requisi√ß√£o para obter detalhes completos
        if (device.oem_serial_number) {
            fetch(`/portal_associacao/tracking/asset-details/${device.oem_serial_number}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' || data.oem_serial_number) {
                        const asset = data.status === 'success' ? data.asset_details : data;
                        displayAssetDetails(asset);
                        // Carregar dados anal√≠ticos em paralelo
                        loadAssetAnalytics(device.oem_serial_number);
                    } else {
                        console.error('Erro ao buscar detalhes do asset:', data.message);
                        displayAssetDetails(device); // Fallback para dados b√°sicos
                    }
                })
                .catch(error => {
                    console.error('Erro na requisi√ß√£o:', error);
                    displayAssetDetails(device); // Fallback para dados b√°sicos
                });
        } else {
            displayAssetDetails(device);
        }
    }

    // Carregar dados anal√≠ticos do asset
    let analyticsChart = null;
    let doorChartInstance = null;
    let temperatureStatusChart = null;

    function loadAssetAnalytics(serial) {
        fetch(`/portal_associacao/tracking/asset-analytics/${serial}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    displayAnalyticsTab(data);
                }
            })
            .catch(error => console.error('Erro ao carregar analytics:', error));
    }

    function displayAnalyticsTab(analytics) {
        const analyticsPanel = document.getElementById('analyticsPanel');
        if (!analyticsPanel) return;

        const temp_min = analytics.temperature_status.temp_min;
        const temp_max = analytics.temperature_status.temp_max;
        const stats = analytics.statistics;
        const hourly = analytics.hourly_data;
        const doors = analytics.door_periods;

        let html = `
            <!-- Gr√°fico de Temperatura e Porta (24h) -->
            <div style="background: #f8f9fa; padding: 18px; border-radius: 12px; margin-bottom: 20px;">
                <div style="font-size: 14px; font-weight: 600; color: #333; margin-bottom: 15px; display: flex; align-items: center;">
                    üìà <span style="margin-left: 8px;">AN√ÅLISE 24 HORAS</span>
                </div>
                
                <!-- Tabs para Gr√°ficos -->
                <div style="display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid #e0e0e0;">
                    <button onclick="showAnalyticsChart('temp')" id="tabTemp" style="
                        padding: 10px 15px;
                        background: none;
                        border: none;
                        cursor: pointer;
                        font-weight: 600;
                        color: #667eea;
                        border-bottom: 3px solid #667eea;
                        font-size: 13px;
                    ">üå°Ô∏è Temperatura</button>
                    <button onclick="showAnalyticsChart('doors')" id="tabDoors" style="
                        padding: 10px 15px;
                        background: none;
                        border: none;
                        cursor: pointer;
                        font-weight: 600;
                        color: #999;
                        border-bottom: 3px solid transparent;
                        font-size: 13px;
                    ">üö™ Aberturas</button>
                    <button onclick="showAnalyticsChart('status')" id="tabStatus" style="
                        padding: 10px 15px;
                        background: none;
                        border: none;
                        cursor: pointer;
                        font-weight: 600;
                        color: #999;
                        border-bottom: 3px solid transparent;
                        font-size: 13px;
                    ">üìä Status Temp</button>
                </div>

                <!-- Container para gr√°ficos -->
                <div style="position: relative; height: 250px; margin-bottom: 15px;">
                    <canvas id="analyticsChartCanvas" style="display: block;"></canvas>
                </div>

                <!-- Estat√≠sticas R√°pidas -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                    <div style="text-align: center; padding: 12px; background: #fff; border-radius: 8px; border-left: 3px solid #667eea;">
                        <div style="font-size: 11px; color: #999; font-weight: 600; margin-bottom: 6px;">TEMP. M√âDIA</div>
                        <div style="font-size: 20px; font-weight: bold; color: #667eea;">
                            ${stats.avg_temperature.toFixed(1)}¬∞C
                        </div>
                        <div style="font-size: 10px; color: #999; margin-top: 4px;">M√°x: ${stats.max_temperature.toFixed(1)}¬∞C</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: #fff; border-radius: 8px; border-left: 3px solid #f39c12;">
                        <div style="font-size: 11px; color: #999; font-weight: 600; margin-bottom: 6px;">CONSUMO M√âD.</div>
                        <div style="font-size: 20px; font-weight: bold; color: #f39c12;">
                            ${stats.avg_power_consumption.toFixed(0)}W
                        </div>
                        <div style="font-size: 10px; color: #999; margin-top: 4px;">Compressor: ${stats.avg_compressor_time.toFixed(0)}%</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: #fff; border-radius: 8px; border-left: 3px solid #56ab2f;">
                        <div style="font-size: 11px; color: #999; font-weight: 600; margin-bottom: 6px;">BAT. M√âDIA</div>
                        <div style="font-size: 20px; font-weight: bold; color: #56ab2f;">
                            ${stats.avg_battery.toFixed(0)}%
                        </div>
                        <div style="font-size: 10px; color: #999; margin-top: 4px;">√öltimos 30 dias</div>
                    </div>
                </div>
            </div>

            <!-- Atividade de Porta por Per√≠odo -->
            <div style="background: #f8f9fa; padding: 18px; border-radius: 12px; margin-bottom: 20px;">
                <div style="font-size: 14px; font-weight: 600; color: #333; margin-bottom: 15px;">
                    üìä Distribui√ß√£o de Aberturas (30 dias)
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                    <div style="text-align: center; padding: 15px; background: #fff; border-radius: 8px; border: 2px solid #f39c12;">
                        <div style="font-size: 11px; color: #999; font-weight: 600; margin-bottom: 8px;">MANH√É</div>
                        <div style="font-size: 28px; font-weight: bold; color: #f39c12; margin: 8px 0;">
                            ${doors.morning}
                        </div>
                        <div style="font-size: 10px; color: #666;">aberturas</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #fff; border-radius: 8px; border: 2px solid #e74c3c;">
                        <div style="font-size: 11px; color: #999; font-weight: 600; margin-bottom: 8px;">TARDE</div>
                        <div style="font-size: 28px; font-weight: bold; color: #e74c3c; margin: 8px 0;">
                            ${doors.afternoon}
                        </div>
                        <div style="font-size: 10px; color: #666;">aberturas</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #fff; border-radius: 8px; border: 2px solid #6c5ce7;">
                        <div style="font-size: 11px; color: #999; font-weight: 600; margin-bottom: 8px;">NOITE</div>
                        <div style="font-size: 28px; font-weight: bold; color: #6c5ce7; margin: 8px 0;">
                            ${doors.night}
                        </div>
                        <div style="font-size: 10px; color: #666;">aberturas</div>
                    </div>
                </div>
            </div>

            <!-- Status de Temperatura -->
            <div style="background: #f8f9fa; padding: 18px; border-radius: 12px;">
                <div style="font-size: 14px; font-weight: 600; color: #333; margin-bottom: 15px;">
                    üå°Ô∏è Status de Temperatura (${temp_min}¬∞C - ${temp_max}¬∞C)
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                    <div style="text-align: center; padding: 15px; background: #fff; border-radius: 8px; border: 2px solid #56ab2f;">
                        <div style="font-size: 11px; color: #999; font-weight: 600; margin-bottom: 6px;">‚úÖ OK</div>
                        <div style="font-size: 24px; font-weight: bold; color: #56ab2f;">
                            ${analytics.temperature_status.ok}
                        </div>
                        <div style="font-size: 10px; color: #666;">Normal</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #fff; border-radius: 8px; border: 2px solid #e74c3c;">
                        <div style="font-size: 11px; color: #999; font-weight: 600; margin-bottom: 6px;">üî• ACIMA</div>
                        <div style="font-size: 24px; font-weight: bold; color: #e74c3c;">
                            ${analytics.temperature_status.above}
                        </div>
                        <div style="font-size: 10px; color: #666;">Acima ${temp_max}¬∞C</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #fff; border-radius: 8px; border: 2px solid #5dade2;">
                        <div style="font-size: 11px; color: #999; font-weight: 600; margin-bottom: 6px;">‚ùÑÔ∏è ABAIXO</div>
                        <div style="font-size: 24px; font-weight: bold; color: #5dade2;">
                            ${analytics.temperature_status.below}
                        </div>
                        <div style="font-size: 10px; color: #666;">Abaixo ${temp_min}¬∞C</div>
                    </div>
                </div>
            </div>
        `;

        analyticsPanel.innerHTML = html;
        
        // Renderizar o gr√°fico inicial (temperatura)
        setTimeout(() => {
            renderAnalyticsChart('temp', hourly, analytics);
        }, 100);
    }

    function showAnalyticsChart(type) {
        // Atualizar tabs
        document.getElementById('tabTemp').style.color = type === 'temp' ? '#667eea' : '#999';
        document.getElementById('tabTemp').style.borderBottomColor = type === 'temp' ? '#667eea' : 'transparent';
        
        document.getElementById('tabDoors').style.color = type === 'doors' ? '#667eea' : '#999';
        document.getElementById('tabDoors').style.borderBottomColor = type === 'doors' ? '#667eea' : 'transparent';
        
        document.getElementById('tabStatus').style.color = type === 'status' ? '#667eea' : '#999';
        document.getElementById('tabStatus').style.borderBottomColor = type === 'status' ? '#667eea' : 'transparent';
        
        // Renderizar gr√°fico baseado no tipo selecionado
        // Os dados j√° foram carregados globalmente
    }

    function renderAnalyticsChart(type, hourly, analytics) {
        const ctx = document.getElementById('analyticsChartCanvas');
        if (!ctx) return;

        // Destruir gr√°fico anterior se existir
        if (analyticsChart) {
            analyticsChart.destroy();
        }

        let chartConfig = {};

        if (type === 'temp') {
            chartConfig = {
                type: 'line',
                data: {
                    labels: hourly.labels,
                    datasets: [{
                        label: 'Temperatura (¬∞C)',
                        data: hourly.temperature,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#666', font: { size: 11 } },
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        x: {
                            ticks: { color: '#666', font: { size: 11 } },
                            grid: { display: false }
                        }
                    }
                }
            };
        } else if (type === 'doors') {
            chartConfig = {
                type: 'bar',
                data: {
                    labels: hourly.labels,
                    datasets: [{
                        label: 'Aberturas de Porta',
                        data: hourly.doors,
                        backgroundColor: '#f39c12',
                        borderColor: '#e67e22',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#666', font: { size: 11 } },
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        x: {
                            ticks: { color: '#666', font: { size: 11 } },
                            grid: { display: false }
                        }
                    }
                }
            };
        } else if (type === 'status') {
            chartConfig = {
                type: 'doughnut',
                data: {
                    labels: ['‚úÖ OK', 'üî• Acima', '‚ùÑÔ∏è Abaixo'],
                    datasets: [{
                        data: [
                            analytics.temperature_status.ok,
                            analytics.temperature_status.above,
                            analytics.temperature_status.below
                        ],
                        backgroundColor: ['#56ab2f', '#e74c3c', '#5dade2'],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { font: { size: 11 }, padding: 15 }
                        }
                    }
                }
            };
        }

        analyticsChart = new Chart(ctx, chartConfig);
    }

    // Fun√ß√£o para exibir os detalhes do asset
    function displayAssetDetails(device) {
        document.getElementById('detailsTitle').textContent = device.bottler_equipment_number || 'Asset';
        
        const statusOnline = device.is_online ? 'üü¢ Online' : 'üî¥ Offline';
        const statusMissing = device.is_missing ? '‚ö†Ô∏è Perdido' : '‚úÖ Normal';
        
        // Temperaturas com valida√ß√£o
        const tempColor = (device.latest_cabinet_temperature_c && (device.latest_cabinet_temperature_c > 20 || device.latest_cabinet_temperature_c < 1)) ? '#e74c3c' : '#56ab2f';
        const ambientTempColor = (device.latest_ambient_temperature_c && (device.latest_ambient_temperature_c > 35 || device.latest_ambient_temperature_c < 0)) ? '#e74c3c' : '#56ab2f';
        
        // Bateria com cor
        const batteryLevel = device.battery_level_percentage || device.latest_battery_level_percentage || device.battery_level || 0;
        const batteryColor = batteryLevel < 20 ? '#e74c3c' : batteryLevel < 50 ? '#f39c12' : '#56ab2f';
        
        let html = `
            <!-- Abas de navega√ß√£o -->
            <div style="display: flex; gap: 5px; margin: -20px -20px 20px -20px; padding: 15px 20px 0 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-bottom: 2px solid rgba(0,0,0,0.1);">
                <button onclick="switchDetailsTab('basic')" id="tabBasic" style="
                    padding: 12px 20px;
                    background: rgba(255,255,255,0.3);
                    color: white;
                    border: none;
                    cursor: pointer;
                    font-weight: 600;
                    font-size: 13px;
                    border-radius: 6px 6px 0 0;
                    transition: all 0.3s;
                ">üìã Detalhes</button>
                <button onclick="switchDetailsTab('analytics')" id="tabAnalytics" style="
                    padding: 12px 20px;
                    background: rgba(255,255,255,0.1);
                    color: rgba(255,255,255,0.7);
                    border: none;
                    cursor: pointer;
                    font-weight: 600;
                    font-size: 13px;
                    border-radius: 6px 6px 0 0;
                    transition: all 0.3s;
                ">üìà Analytics</button>
            </div>

            <!-- Panel de Detalhes -->
            <div id="basicPanel" style="display: block;">
                <!-- Header com Status Principal -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; color: white; position: relative; margin-top: -20px; margin-left: -20px; margin-right: -20px; padding-left: 20px; border-radius: 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="margin: 0; font-size: 18px; font-weight: bold;">${device.bottler_equipment_number || 'N/A'}</h3>
                            <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 14px;">Serial: ${device.oem_serial_number || 'N/A'}</p>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 24px; margin-bottom: 5px;">${statusOnline}</div>
                            <div style="font-size: 12px; opacity: 0.8;">${statusMissing}</div>
                        </div>
                    </div>
                </div>

                <!-- M√©tricas Principais em Grid -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <!-- Bateria -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border: 2px solid ${batteryColor}; position: relative;">
                        <div style="font-size: 11px; color: #666; font-weight: 600; margin-bottom: 8px;">üîã BATERIA</div>
                        <div style="font-size: 24px; font-weight: bold; color: ${batteryColor};">${batteryLevel}%</div>
                        <div style="background: #e0e0e0; height: 6px; border-radius: 3px; margin-top: 8px; overflow: hidden;">
                            <div style="background: ${batteryColor}; height: 100%; width: ${batteryLevel}%; border-radius: 3px; transition: width 0.3s;"></div>
                        </div>
                    </div>

                    <!-- Temperatura Gabinete -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border: 2px solid ${tempColor};">
                        <div style="font-size: 11px; color: #666; font-weight: 600; margin-bottom: 8px;">üå°Ô∏è TEMP. GABINETE</div>
                        <div style="font-size: 24px; font-weight: bold; color: ${tempColor};">
                            ${device.latest_cabinet_temperature_c ? device.latest_cabinet_temperature_c.toFixed(1) : 'N/A'}¬∞C
                        </div>
                        ${device.latest_ambient_temperature_c ? 
                            `<div style="font-size: 12px; color: #666; margin-top: 4px;">
                                Ambiente: <span style="color: ${ambientTempColor}; font-weight: 600;">${device.latest_ambient_temperature_c.toFixed(1)}¬∞C</span>
                            </div>` : ''
                        }
                    </div>
                </div>

                <!-- Informa√ß√µes de Localiza√ß√£o -->
                <div style="background: #f8f9fa; padding: 18px; border-radius: 12px; margin-bottom: 18px; border-left: 4px solid #667eea;">
                    <div style="font-size: 14px; font-weight: 600; color: #333; margin-bottom: 12px; display: flex; align-items: center;">
                        üìç <span style="margin-left: 8px;">LOCALIZA√á√ÉO</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div>
                            <div style="font-size: 11px; color: #999; font-weight: 600; margin-bottom: 4px;">Outlet</div>
                            <div style="font-size: 13px; color: #333; font-weight: 600;">${device.outlet || 'N/A'}</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: #999; font-weight: 600; margin-bottom: 4px;">Sub Cliente</div>
                            <div style="font-size: 13px; color: #333; font-weight: 600;">${device.sub_client || 'N/A'}</div>
                        </div>
                    </div>
                    <div style="margin-top: 12px;">
                        <div style="font-size: 11px; color: #999; font-weight: 600; margin-bottom: 4px;">Canal</div>
                        <div style="font-size: 13px; color: #333; margin-bottom: 8px;">${device.sub_trade_channel || 'N/A'}</div>
                        <div style="font-size: 11px; color: #999; font-weight: 600; margin-bottom: 4px;">Endere√ßo</div>
                        <div style="font-size: 13px; color: #666;">
                            ${[device.city, device.state, device.country].filter(Boolean).join(', ') || 'N/A'}
                        </div>
                    </div>
                </div>

                <!-- Informa√ß√µes T√©cnicas -->
                <div style="background: #f8f9fa; padding: 18px; border-radius: 12px; margin-bottom: 18px; border-left: 4px solid #56ab2f;">
                    <div style="font-size: 14px; font-weight: 600; color: #333; margin-bottom: 12px; display: flex; align-items: center;">
                        üîß <span style="margin-left: 8px;">INFORMA√á√ïES T√âCNICAS</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 10px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div>
                                <div style="font-size: 11px; color: #999; font-weight: 600; margin-bottom: 4px;">MAC Device</div>
                                <div style="font-size: 12px; color: #333; font-family: monospace; background: #e9ecef; padding: 4px 8px; border-radius: 4px;">
                                    ${device.smart_device_mac || 'N/A'}
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #999; font-weight: 600; margin-bottom: 4px;">Status Energia</div>
                                <div style="font-size: 13px; color: #333;">
                                    ${device.power_status || 'N/A'}
                                </div>
                            </div>
                        </div>
                        ${device.asset_type || device.outlet_type ? 
                            `<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #dee2e6;">
                                <div style="font-size: 11px; color: #999; font-weight: 600; margin-bottom: 4px;">Tipo/Modelo</div>
                                <div style="font-size: 13px; color: #333;">
                                    ${[device.asset_type, device.outlet_type].filter(Boolean).join(' - ') || 'N/A'}
                                </div>
                            </div>` : ''
                        }
                    </div>
                </div>

                <!-- Estat√≠sticas de Atividade -->
                ${(device.door_event_average_morning || device.door_event_average_afternoon || device.door_event_average_night) ? 
                    `<div style="background: #f8f9fa; padding: 18px; border-radius: 12px; margin-bottom: 18px; border-left: 4px solid #f39c12;">
                        <div style="font-size: 14px; font-weight: 600; color: #333; margin-bottom: 12px; display: flex; align-items: center;">
                            üìä <span style="margin-left: 8px;">ATIVIDADE DE PORTA</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                            <div style="text-align: center; padding: 10px; background: #fff; border-radius: 8px;">
                                <div style="font-size: 11px; color: #999; font-weight: 600;">MANH√É</div>
                                <div style="font-size: 18px; font-weight: bold; color: #f39c12; margin: 4px 0;">
                                    ${device.door_event_average_morning ? parseFloat(device.door_event_average_morning).toFixed(1) : '0'}
                                </div>
                                <div style="font-size: 10px; color: #666;">aberturas/dia</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: #fff; border-radius: 8px;">
                                <div style="font-size: 11px; color: #999; font-weight: 600;">TARDE</div>
                                <div style="font-size: 18px; font-weight: bold; color: #e74c3c; margin: 4px 0;">
                                    ${device.door_event_average_afternoon ? parseFloat(device.door_event_average_afternoon).toFixed(1) : '0'}
                                </div>
                                <div style="font-size: 10px; color: #666;">aberturas/dia</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: #fff; border-radius: 8px;">
                                <div style="font-size: 11px; color: #999; font-weight: 600;">NOITE</div>
                                <div style="font-size: 18px; font-weight: bold; color: #6c5ce7; margin: 4px 0;">
                                    ${device.door_event_average_night ? parseFloat(device.door_event_average_night).toFixed(1) : '0'}
                                </div>
                                <div style="font-size: 10px; color: #666;">aberturas/dia</div>
                            </div>
                        </div>
                    </div>` : ''
                }

                <!-- Status Detalhado -->
                ${device.total_compressor_on_time_percent || device.avg_power_consumption_watt ? 
                    `<div style="background: #f8f9fa; padding: 18px; border-radius: 12px; margin-bottom: 18px; border-left: 4px solid #e17055;">
                        <div style="font-size: 14px; font-weight: 600; color: #333; margin-bottom: 12px; display: flex; align-items: center;">
                            ‚öôÔ∏è <span style="margin-left: 8px;">OPERA√á√ÉO</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            ${device.total_compressor_on_time_percent ? 
                                `<div style="padding: 12px; background: #fff; border-radius: 6px;">
                                    <div style="font-size: 11px; color: #999; font-weight: 600; margin-bottom: 4px;">Compressor ON</div>
                                    <div style="font-size: 16px; font-weight: bold; color: #e17055;">
                                        ${parseFloat(device.total_compressor_on_time_percent).toFixed(1)}%
                                    </div>
                                </div>` : ''
                            }
                            ${device.avg_power_consumption_watt ? 
                                `<div style="padding: 12px; background: #fff; border-radius: 6px;">
                                    <div style="font-size: 11px; color: #999; font-weight: 600; margin-bottom: 4px;">Consumo M√©dio</div>
                                    <div style="font-size: 16px; font-weight: bold; color: #e17055;">
                                        ${parseFloat(device.avg_power_consumption_watt).toFixed(0)}W
                                    </div>
                                </div>` : ''
                            }
                        </div>
                    </div>` : ''
                }

                <!-- Bot√µes de A√ß√£o -->
                <div style="margin-top: 20px;">
                    <a href="https://www.google.com/maps?q=${device.latest_latitude},${device.latest_longitude}" target="_blank" style="
                        display: block;
                        padding: 12px;
                        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 13px;
                        font-weight: 600;
                        text-align: center;
                        text-decoration: none;
                        transition: transform 0.2s;
                    " onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                        ÔøΩÔ∏è Ver no Google Maps
                    </a>
                </div>
            </div>

            <!-- Panel de Analytics -->
            <div id="analyticsPanel" style="display: none;">
                <div style="text-align: center; padding: 40px 20px; color: #999;">
                    <p>Carregando dados anal√≠ticos...</p>
                </div>
            </div>
        `;
        
        document.getElementById('detailsContent').innerHTML = html;
        openDetailsPanel();
    }

    // Alternar entre abas do painel de detalhes
    function switchDetailsTab(tab) {
        const basicPanel = document.getElementById('basicPanel');
        const analyticsPanel = document.getElementById('analyticsPanel');
        const tabBasic = document.getElementById('tabBasic');
        const tabAnalytics = document.getElementById('tabAnalytics');

        if (tab === 'basic') {
            basicPanel.style.display = 'block';
            analyticsPanel.style.display = 'none';
            tabBasic.style.background = 'rgba(255,255,255,0.3)';
            tabBasic.style.color = 'white';
            tabAnalytics.style.background = 'rgba(255,255,255,0.1)';
            tabAnalytics.style.color = 'rgba(255,255,255,0.7)';
        } else {
            basicPanel.style.display = 'none';
            analyticsPanel.style.display = 'block';
            tabBasic.style.background = 'rgba(255,255,255,0.1)';
            tabBasic.style.color = 'rgba(255,255,255,0.7)';
            tabAnalytics.style.background = 'rgba(255,255,255,0.3)';
            tabAnalytics.style.color = 'white';
        }
    }


    // Exibir detalhes do asset no painel lateral
    function showAssetDetails(device) {
        document.getElementById('detailsTitle').textContent = device.bottler_equipment_number || 'Asset';
        
        const statusOnline = device.is_online ? 'üü¢ Online' : 'üî¥ Offline';
        const statusMissing = device.is_missing ? '‚ö†Ô∏è Perdido' : '‚úÖ Normal';
        
        const tempColor = (device.latest_cabinet_temperature_c > 20 || device.latest_cabinet_temperature_c < 1) ? '#e74c3c' : '#56ab2f';
        
        let html = `
            <!-- Informa√ß√µes Principais -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                    <div>
                        <div style="font-size: 11px; color: #999; font-weight: 600; margin-bottom: 3px;">Serial OEM</div>
                        <div style="font-size: 14px; font-weight: 600; color: #333;">${device.oem_serial_number || 'N/A'}</div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: #999; font-weight: 600; margin-bottom: 3px;">Status</div>
                        <div style="font-size: 14px; font-weight: 600;">${statusOnline}</div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr; gap: 10px;">
                    <div>
                        <div style="font-size: 11px; color: #999; font-weight: 600; margin-bottom: 3px;">Temperatura</div>
                        <div style="font-size: 14px; font-weight: 600; color: ${tempColor};">${device.latest_cabinet_temperature_c ? device.latest_cabinet_temperature_c.toFixed(1) : 'N/A'}¬∞C</div>
                    </div>
                </div>
            </div>

            <!-- Status -->
            <div style="display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 15px;">
                <div style="background: #f0f3ff; padding: 12px; border-radius: 8px; border-left: 3px solid #667eea;">
                    <div style="font-size: 11px; color: #667eea; font-weight: 600; margin-bottom: 5px;">üîå Status Operacional</div>
                    <div style="font-size: 12px; color: #333;">${statusMissing}</div>
                </div>
            </div>

            <!-- Localiza√ß√£o -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <div style="font-size: 12px; font-weight: 600; color: #333; margin-bottom: 10px;">üìç Localiza√ß√£o</div>
                <div style="font-size: 13px; color: #666; margin-bottom: 5px;">
                    <strong>Outlet:</strong> ${device.outlet || 'N/A'}
                </div>
                <div style="font-size: 13px; color: #666; margin-bottom: 5px;">
                    <strong>Canal:</strong> ${device.sub_trade_channel || 'N/A'}
                </div>
                <div style="font-size: 13px; color: #666;">
                    <strong>Local:</strong> ${device.city || 'N/A'}${device.state ? ', ' + device.state : ''}${device.country ? ', ' + device.country : ''}
                </div>
            </div>

            <!-- Informa√ß√µes T√©cnicas -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <div style="font-size: 12px; font-weight: 600; color: #333; margin-bottom: 10px;">üîß Informa√ß√µes T√©cnicas</div>
                <div style="font-size: 13px; color: #666; margin-bottom: 5px;">
                    <strong>Equipamento:</strong> ${device.bottler_equipment_number || 'N/A'}
                </div>
                <div style="font-size: 13px; color: #666; margin-bottom: 5px;">
                    <strong>MAC Device:</strong> ${device.smart_device_mac || 'N/A'}
                </div>
                <div style="font-size: 13px; color: #666;">
                    <strong>Sub Client:</strong> ${device.sub_client || 'N/A'}
                </div>
            </div>

            <!-- Estat√≠sticas de Porta -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <div style="font-size: 12px; font-weight: 600; color: #333; margin-bottom: 10px;">üö™ Aberturas de Porta (M√©dias)</div>
                <div style="font-size: 13px; color: #666; margin-bottom: 5px;">
                    <strong>Manh√£:</strong> ${device.door_event_average_morning ? parseFloat(device.door_event_average_morning).toFixed(1) : '0'} por dia
                </div>
                <div style="font-size: 13px; color: #666; margin-bottom: 5px;">
                    <strong>Tarde:</strong> ${device.door_event_average_afternoon ? parseFloat(device.door_event_average_afternoon).toFixed(1) : '0'} por dia
                </div>
                <div style="font-size: 13px; color: #666;">
                    <strong>Noite:</strong> ${device.door_event_average_night ? parseFloat(device.door_event_average_night).toFixed(1) : '0'} por dia
                </div>
            </div>

            <!-- Bot√£o Google Maps -->
            <div style="margin-bottom: 15px;">
                <a href="https://www.google.com/maps?q=${device.latest_latitude},${device.latest_longitude}" target="_blank" style="
                    display: block;
                    padding: 10px;
                    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                    color: white;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 13px;
                    font-weight: 600;
                    text-align: center;
                    text-decoration: none;
                ">üó∫Ô∏è Ver no Google Maps</a>
            </div>

        `;
        
        document.getElementById('detailsContent').innerHTML = html;
        openDetailsPanel();
    }

    // Calcular tempo desde a √∫ltima atualiza√ß√£o
    function calculateTimeAgo(timestamp) {
        if (!timestamp) return 'N/A';
        const date = new Date(timestamp);
        const now = new Date();
        const seconds = Math.floor((now - date) / 1000);
        
        if (seconds < 60) return 'Agora';
        if (seconds < 3600) return Math.floor(seconds / 60) + 'm atr√°s';
        if (seconds < 86400) return Math.floor(seconds / 3600) + 'h atr√°s';
        return Math.floor(seconds / 86400) + 'd atr√°s';
    }

    // Renderizar gr√°fico de bateria
    function renderBatteryChart(batteryLevel) {
        const canvas = document.getElementById('batteryChart');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;
        const padding = 10;
        const barWidth = width - (padding * 2);
        const barHeight = 30;
        
        ctx.clearRect(0, 0, width, height);
        
        // Background da barra
        ctx.fillStyle = '#e0e0e0';
        ctx.fillRect(padding, height / 2 - barHeight / 2, barWidth, barHeight);
        
        // Cor baseada no n√≠vel
        let color = '#56ab2f'; // Verde
        if (batteryLevel < 20) color = '#e74c3c'; // Vermelho
        else if (batteryLevel < 50) color = '#f5576c'; // Rosa
        
        // Barra de bateria
        ctx.fillStyle = color;
        ctx.fillRect(padding, height / 2 - barHeight / 2, barWidth * (batteryLevel / 100), barHeight);
        
        // Texto
        ctx.fillStyle = '#333';
        ctx.font = 'bold 14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(batteryLevel + '%', width / 2, height / 2 + 5);
    }

    // Zoom para o device no mapa
    function zoomToDeviceOnMap(lat, lon) {
        if (lat && lon) {
            map.setView([lat, lon], 16);
            closeDetailsPanel();
        }
    }

    // Buscar dispositivos
    // Alternar painel de filtros avan√ßados
    function toggleAdvancedFilters() {
        const panel = document.getElementById('advancedFiltersPanel');
        const icon = document.getElementById('filterToggleIcon');
        
        if (panel.style.display === 'none') {
            panel.style.display = 'block';
            icon.textContent = '‚ñ≤';
        } else {
            panel.style.display = 'none';
            icon.textContent = '‚ñº';
        }
    }

    // Limpar todos os filtros avan√ßados
    function clearAdvancedFilters() {
        document.getElementById('filterBottlerEquipmentNumber').value = '';
        document.getElementById('filterOemSerialNumber').value = '';
        document.getElementById('filterOutlet').value = '';
        document.getElementById('filterSubTradeChannel').value = '';
        document.getElementById('filterCity').value = '';
        document.getElementById('filterState').value = '';
        document.getElementById('filterCountry').value = '';
        document.getElementById('filterIsOnline').value = '';
        document.getElementById('filterIsMissing').value = '';
        
        // Limpar tamb√©m o subclient
        document.getElementById('subclientFilter').value = '';
        currentSubclient = '';
        
        // console.log('üîÑ Filtros avan√ßados limpos');
        
        // Limpar a URL
        window.history.replaceState({}, '', window.location.pathname);
        
        // Recarregar com filtros limpos
        const useOptimized = (currentSearchTerm.trim() === '' && currentSubclient.trim() === '');
        loadDevices(1, currentSearchTerm, currentSubclient, useOptimized);
    }

    // Event listeners para filtros avan√ßados
    function setupAdvancedFilterListeners() {
        const advancedFilterInputs = [
            'filterBottlerEquipmentNumber',
            'filterOemSerialNumber',
            'filterOutlet',
            'filterSubTradeChannel',
            'filterCity',
            'filterState',
            'filterCountry',
            'filterIsOnline',
            'filterIsMissing'
        ];
        
        advancedFilterInputs.forEach(inputId => {
            const element = document.getElementById(inputId);
            if (element) {
                element.addEventListener('input', () => {
                    if (searchDebounceHandle) {
                        clearTimeout(searchDebounceHandle);
                    }
                    searchDebounceHandle = setTimeout(() => {
                        // console.log('üîß Filtros avan√ßados alterados, recarregando...');
                        const useOptimized = false; // Sempre usar filtros se h√° filtro avan√ßado
                        loadDevices(1, currentSearchTerm, currentSubclient, useOptimized);
                        // Atualizar a URL com os filtros
                        updateUrlWithFilters();
                    }, 500);
                });
                
                element.addEventListener('change', () => {
                    if (searchDebounceHandle) {
                        clearTimeout(searchDebounceHandle);
                    }
                    searchDebounceHandle = setTimeout(() => {
                        // console.log('üîß Filtros avan√ßados alterados, recarregando...');
                        const useOptimized = false; // Sempre usar filtros se h√° filtro avan√ßado
                        loadDevices(1, currentSearchTerm, currentSubclient, useOptimized);
                        // Atualizar a URL com os filtros
                        updateUrlWithFilters();
                    }, 500);
                });
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        // const searchInput = document.getElementById('deviceSearch');
        const subclientSelect = document.getElementById('subclientFilter');

        // Aplicar filtros iniciais da URL (se existirem)
        let hasUrlFilters = false;
        
        if (initialFilters.bottler_equipment_number) {
            document.getElementById('filterBottlerEquipmentNumber').value = initialFilters.bottler_equipment_number;
            hasUrlFilters = true;
        }
        if (initialFilters.oem_serial_number) {
            document.getElementById('filterOemSerialNumber').value = initialFilters.oem_serial_number;
            hasUrlFilters = true;
        }
        if (initialFilters.outlet) {
            document.getElementById('filterOutlet').value = initialFilters.outlet;
            hasUrlFilters = true;
        }
        if (initialFilters.sub_trade_channel) {
            document.getElementById('filterSubTradeChannel').value = initialFilters.sub_trade_channel;
            hasUrlFilters = true;
        }
        if (initialFilters.city) {
            document.getElementById('filterCity').value = initialFilters.city;
            hasUrlFilters = true;
        }
        if (initialFilters.state) {
            document.getElementById('filterState').value = initialFilters.state;
            hasUrlFilters = true;
        }
        if (initialFilters.country) {
            document.getElementById('filterCountry').value = initialFilters.country;
            hasUrlFilters = true;
        }
        if (initialFilters.is_online) {
            document.getElementById('filterIsOnline').value = initialFilters.is_online;
            hasUrlFilters = true;
        }
        if (initialFilters.is_missing) {
            document.getElementById('filterIsMissing').value = initialFilters.is_missing;
            hasUrlFilters = true;
        }
        if (initialFilters.subclient) {
            // O subclient ser√° preenchido ap√≥s carregar a lista
            currentSubclient = initialFilters.subclient;
            hasUrlFilters = true;
        }
        
        // Se houver filtros na URL, abrir o painel de filtros avan√ßados
        if (hasUrlFilters) {
            const panel = document.getElementById('advancedFiltersPanel');
            const icon = document.getElementById('filterToggleIcon');
            panel.style.display = 'block';
            icon.textContent = '‚ñ≤';
            console.log('üîç Filtros aplicados da URL');
        }

        // // Event listener para busca por texto
        // searchInput.addEventListener('input', (e) => {
        //     const rawTerm = e.target.value;
        //     if (searchDebounceHandle) {
        //         clearTimeout(searchDebounceHandle);
        //     }
        //     searchDebounceHandle = setTimeout(() => {
        //         console.log(`üîé Buscando por: "${rawTerm}"`);
        //         // Se o termo de busca for limpo, volte a usar a view otimizada
        //         const useOptimized = (rawTerm.trim() === '' && currentSubclient.trim() === '');
        //         loadDevices(1, rawTerm, currentSubclient, useOptimized);
        //     }, 300);
        // });

        // Event listener para filtro de subclient
        subclientSelect.addEventListener('change', (e) => {
            const selectedSubclient = e.target.value;
            // console.log(`üè∑Ô∏è Subclient selecionado: "${selectedSubclient || 'Todos'}"`);
            
            // Se o filtro for limpo, volte a usar a view otimizada
            const useOptimized = (currentSearchTerm.trim() === '' && selectedSubclient.trim() === '');
            
            // Recarregar na p√°gina 1 com o novo filtro
            loadDevices(1, currentSearchTerm, selectedSubclient, useOptimized);
            
            // Atualizar a URL com o filtro
            updateUrlWithFilters();
        });
        
        // Configurar listeners para filtros avan√ßados
        setupAdvancedFilterListeners();
        
        // console.log('‚úÖ Event listeners inicializados');
    });

    // Fun√ß√£o para atualizar a URL com os filtros atuais
    function updateUrlWithFilters() {
        const params = new URLSearchParams();
        
        const filters = {
            bottler_equipment_number: document.getElementById('filterBottlerEquipmentNumber')?.value?.trim() || '',
            oem_serial_number: document.getElementById('filterOemSerialNumber')?.value?.trim() || '',
            outlet: document.getElementById('filterOutlet')?.value?.trim() || '',
            sub_trade_channel: document.getElementById('filterSubTradeChannel')?.value?.trim() || '',
            city: document.getElementById('filterCity')?.value?.trim() || '',
            state: document.getElementById('filterState')?.value?.trim() || '',
            country: document.getElementById('filterCountry')?.value?.trim() || '',
            is_online: document.getElementById('filterIsOnline')?.value?.trim() || '',
            is_missing: document.getElementById('filterIsMissing')?.value?.trim() || '',
            subclient: currentSubclient
        };
        
        // Adicionar apenas filtros n√£o vazios aos par√¢metros
        Object.keys(filters).forEach(key => {
            if (filters[key]) {
                params.append(key, filters[key]);
            }
        });
        
        // Atualizar a URL sem recarregar a p√°gina
        const newUrl = params.toString() ? `${window.location.pathname}?${params.toString()}` : window.location.pathname;
        window.history.replaceState({}, '', newUrl);
    }

    // Inicializar
    // console.log('üó∫Ô∏è Inicializando mapa...');
    initMap();
    
    // console.log('üì• Carregando assets iniciais...');
    loadDevices(1, '', '', true); // Carga inicial sempre otimizada
    
    // console.log('‚úÖ Sistema de rastreio inicializado');

    // Recarregar dispositivos a cada 60 segundos (mant√©m na p√°gina atual)
    // Descomente se quiser auto-refresh:
    // setInterval(() => {
    //     const isFiltering = (currentSearchTerm.trim() !== '' || currentSubclient.trim() !== '');
    //     loadDevices(currentPage, currentSearchTerm, currentSubclient, !isFiltering);
    // }, 60000);
</script>
{% endblock %}