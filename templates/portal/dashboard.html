{% extends "portal/base.html" %}
{% block title %}Dashboard{% endblock %}
{% block page_title %}Dashboard de Monitoramento{% endblock %}

{% block breadcrumb %}
    <i class="fas fa-home"></i>
    <span>Dashboard</span>
{% endblock %}

{% block styles %}
    {{ super() }} 
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}?v={{ range(1, 9999) | random }}">
    <!-- <link rel="stylesheet" href="/static/css/dashboard.css"> -->
{% endblock %}

{% block content %}

<!-- Timezone Selector -->
<div class="timezone-selector-container">
    <label for="timezoneSelect" class="timezone-label">
        <i class="fas fa-clock"></i> Fuso Hor√°rio:
    </label>
    <select id="timezoneSelect" class="timezone-select">
        <option value="America/Sao_Paulo" selected>Brasil (UTC-3)</option>
        <option value="UTC">UTC (UTC+0)</option>
        <option value="America/New_York">New York (UTC-5/-4)</option>
        <option value="Europe/London">London (UTC+0/+1)</option>
        <option value="Europe/Madrid">Madrid (UTC+1/+2)</option>
        <option value="Asia/Shanghai">Shanghai (UTC+8)</option>
        <option value="Asia/Tokyo">Tokyo (UTC+9)</option>
    </select>
    <div id="timezoneIndicator" class="timezone-indicator">
        Exibindo hor√°rios em: BRT
    </div>
</div>

<!-- Period Toggle Button -->
<div class="period-selector-container">
    <div class="period-toggle">
        <button class="period-btn active" data-period="30">
            <i class="fas fa-calendar"></i> 30 Dias
        </button>
        <button class="period-btn" data-period="7">
            <i class="fas fa-calendar-week"></i> 7 Dias
        </button>
    </div>
    <div class="period-indicator">
        <span id="periodLabel">√öltimos 30 dias</span>
        <span id="periodDates" class="period-dates"></span>
    </div>
</div>

<div class="stats-grid">
    
    <a href="{{url_for('portal_tracking.render_tracking')}}" class="stat-card clickable">
        <div class="stat-icon bg-indigo">
            <i class="fas fa-boxes"></i>
        </div>
        <div class="stat-content">
            <p class="stat-label">Total de Ativos</p>
            <h4 class="stat-value" id="kpiTotalAssets">{{ stats.total_assets }}</h4>
        </div>
    </a>

    <a href="{{url_for('portal_tracking.render_tracking')}}?is_active=true" class="stat-card clickable">
        <div class="stat-icon bg-green">
            <i class="fas fa-heartbeat"></i>
        </div>
        <div class="stat-content">
            <p class="stat-label">Ativos (24h)</p>
            <h4 class="stat-value" id="kpiAssets24h">{{ stats.assets_health_last_24h_count }}</h4>
        </div>
    </a>

    <div class="stat-card temp-card">
        <div class="stat-icon bg-blue">
            <i class="fas fa-thermometer-half"></i>
        </div>
        
        <div class="stat-content">
            <p class="stat-label">Temperatura <small class="click-hint"></small></p>
            
            <div class="split-values">
                <a href="{{url_for('portal_tracking.render_tracking')}}?temp_is_ok=true" class="split-item clickable-split">
                    <span class="dot green"></span>
                    <span class="split-text">OK:</span>
                    <span class="split-val" id="tempOkPercentage">0%</span>
                </a>
                <div class="split-divider"></div>
                <a href="{{url_for('portal_tracking.render_tracking')}}?temp_is_ok=false" class="split-item clickable-split">
                    <span class="dot red"></span>
                    <span class="split-text">Ruim:</span>
                    <span class="split-val" id="tempNotOkPercentage">0%</span>
                </a>
            </div>
        </div>
    </div>

    <div class="stat-card battery-card">
        <div class="stat-icon bg-teal">
            <i class="fas fa-battery-full"></i>
        </div>

        <div class="stat-content">
            <p class="stat-label">Bateria <small class="click-hint"></small></p>

            <div class="split-values">
                <a href="{{url_for('portal_tracking.render_tracking')}}?battery_is_ok=good" class="split-item clickable-split">
                    <span class="dot green"></span>
                    <span class="split-text">OK:</span>
                    <span class="split-val" id="batteryOkPercentage">0%</span>
                </a>
                <div class="split-divider"></div>
                <a href="{{url_for('portal_tracking.render_tracking')}}?battery_is_ok=low" class="split-item clickable-split">
                    <span class="dot red"></span>
                    <span class="split-text">Baixa:</span>
                    <span class="split-val" id="batteryNotOkPercentage">0%</span>
                </a>
            </div>
        </div>
    </div>

    <a href="{{url_for('portal_alerts.render_alerts')}}?period=30" class="stat-card clickable" data-alerts-card>
        <div class="stat-icon bg-red">
            <i class="fas fa-bell"></i>
        </div>
        <div class="stat-content">
            <p class="stat-label">Alertas</p>
            <h4 class="stat-value" id="kpiAlerts">{{ stats.alerts_period_count }}</h4>
        </div>
        <span class="period-badge">30d</span>
    </a>

    <a href="{{url_for('portal_tracking.render_tracking')}}?is_missing=true" class="stat-card clickable" data-missing-card>
        <div class="stat-icon bg-red">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="stat-content">
            <p class="stat-label">Assets Missing</p>
            <h4 class="stat-value" id="kpiMissing">{{ stats.assets_missing_count }}</h4>
        </div>
        <span class="period-badge">30d</span>
    </a>

    <a href="{{url_for('portal_tracking.render_tracking')}}?overheated=true" class="stat-card clickable" data-overheated-card>
        <div class="stat-icon bg-orange">
            <i class="fas fa-fire"></i>
        </div>
        <div class="stat-content">
            <p class="stat-label">Potencialmente Desligados</p>
            <h4 class="stat-value" id="kpiOverheated">{{ stats.overheated_assets_count }}</h4>
        </div>
        <span class="temp-alert-badge">üî• >100¬∞C</span>
    </a>

    <a href="{{url_for('dashboard.render_quality_dashboard')}}?section=compressor" class="stat-card clickable" id="cardCompressor" style="display: {{ 'flex' if stats.avg_compressor_on_time and stats.avg_compressor_on_time > 0 else 'none' }};">
        <div class="stat-icon bg-cyan">
            <i class="fas fa-cogs"></i>
        </div>
        <div class="stat-content">
            <p class="stat-label">Compressor</p>
            <h4 class="stat-value" id="kpiCompressor">{{ stats.avg_compressor_on_time }}%</h4>
        </div>
        <span class="period-badge">30d</span>
    </a>

    <a href="{{url_for('dashboard.render_quality_dashboard')}}?section=consumption" class="stat-card clickable" id="cardConsumption" style="display: {{ 'flex' if stats.avg_power_consumption and stats.avg_power_consumption > 0 else 'none' }};">
        <div class="stat-icon bg-orange">
            <i class="fas fa-bolt"></i>
        </div>
        <div class="stat-content">
            <p class="stat-label">Consumo</p>
            <h4 class="stat-value" id="kpiConsumption">{{ stats.avg_power_consumption }} kW</h4>
        </div>
        <span class="period-badge">30d</span>
    </a>

</div>

<!-- Charts Section - 2x2 Grid -->
<div class="charts-grid">
    <!-- Temperatura por Hora (30d) - Line Chart -->
    <div class="chart-card">
        <div class="chart-header">
            <h3 id="temp_per_hour_label">üå°Ô∏è Temperatura por Hora (30d)</h3>
        </div>
        <div class="chart-body">
            <canvas id="tempLineChart" height="300"></canvas>
        </div>
    </div>

    <!-- Aberturas de Porta (30d) - Line Chart -->
    <div class="chart-card">
        <div class="chart-header">
            <h3 id="door_open_hour_label">üö™ Aberturas de Porta (30d)</h3>
        </div>
        <div class="chart-body">
            <canvas id="doorLineChart" height="300"></canvas>
        </div>
    </div>

    <!-- Distribui√ß√£o de Sa√∫de de Bateria - Pie Chart -->
    <div class="chart-card">
        <div class="chart-header">
            <h3>üîã Distribui√ß√£o de Sa√∫de de Bateria</h3>
        </div>
        <div class="chart-body">
            <canvas id="batteryChart" height="300"></canvas>
        </div>
    </div>

    <!-- Status de Temperatura das Geladeiras - Pie Chart -->
    <div class="chart-card">
        <div class="chart-header">
            <h3>‚ùÑÔ∏è Status de Temperatura das Geladeiras</h3>
        </div>
        <div class="chart-body">
            <canvas id="temperatureChart" height="300"></canvas>
        </div>
    </div>
</div>

<!-- Top 10 Ativos por Displacement Section -->
<div class="top10-container">
    <div class="top10-header">
        <div class="top10-header-content">
            <h2 class="top10-title">Ativos com Maior Deslocamento</h2>
            <p class="top10-subtitle">√öltimas 24 horas</p>
        </div>
        <div class="top10-badge">üöö Top 10</div>
    </div>
    <div class="top10-body" id="top10Container">
        <div class="top10-empty-state">
            <svg class="top10-empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M12 6v6m0 4v.01"></path>
            </svg>
            <p>Carregando dados...</p>
        </div>
    </div>
</div>

<!-- Navigation Cards -->
<div class="card" style="margin-top: 2rem;">
    <div class="card-header">
        <h3 class="card-title">üîó Acesso R√°pido</h3>
    </div>
    <div class="card-body">
        <div class="dashboard-cards" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
            <!-- Users Card -->
            <a href="{{url_for('portal_users.list_and_create_users')}}" class="dashboard-card">
                <div class="dashboard-card-icon primary">
                    <i class="fas fa-users"></i>
                </div>
                <h3 class="dashboard-card-title">Usu√°rios</h3>
                <p class="dashboard-card-subtitle">Gerencie usu√°rios</p>
            </a>

            <!-- Outlets Card -->
            <a href="{{url_for('portal_outlets.list_and_create_outlets')}}" class="dashboard-card">
                <div class="dashboard-card-icon success">
                    <i class="fas fa-store"></i>
                </div>
                <h3 class="dashboard-card-title">Outlets</h3>
                <p class="dashboard-card-subtitle">Pontos de venda</p>
            </a>

            <!-- Assets Card -->
            <a href="{{url_for('portal_assets.list_and_create_assets')}}" class="dashboard-card">
                <div class="dashboard-card-icon warning">
                    <i class="fas fa-boxes"></i>
                </div>
                <h3 class="dashboard-card-title">Assets</h3>
                <p class="dashboard-card-subtitle">Controle de ativos</p>
            </a>

            <!-- Smart Devices Card -->
            <a href="{{url_for('portal_smartdevices.list_and_create_smartdevices')}}" class="dashboard-card">
                <div class="dashboard-card-icon danger">
                    <i class="fas fa-mobile-alt"></i>
                </div>
                <h3 class="dashboard-card-title">Smart Devices</h3>
                <p class="dashboard-card-subtitle">Dispositivos conectados</p>
            </a>

            <!-- Tracking Card -->
            <a href="{{url_for('portal_tracking.render_tracking')}}" class="dashboard-card">
                <div class="dashboard-card-icon info">
                    <i class="fas fa-location-dot"></i>
                </div>
                <h3 class="dashboard-card-title">Rastreio</h3>
                <p class="dashboard-card-subtitle">Localiza√ß√£o em mapa</p>
            </a>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    /**
     * ============================================================================
     * 1. CONFIGURA√á√ÉO E DADOS (SERVER-SIDE DATA)
     * Centraliza todas as vari√°veis do Jinja2 aqui. Facilita a manuten√ß√£o.
     * ============================================================================
     */
    const APP_CONFIG = {
        urls: {
            stats: "{{ url_for('dashboard.get_dashboard_stats') }}"
        },
        stats: {
            assets: {
                total: {{ stats.total_assets }},
                temp_ok: {{ stats.ok_temperatures_count }},
                temp_total: {{ stats.total_with_temperature }},
                bat_good: {{ stats.good_battery_assets_count }},
                bat_low: {{ stats.low_battery_assets_count }},
                bat_crit: {{ stats.critical_battery_assets_count }}
            }
        },
        charts: {
            temp: {
                labels: {{ stats.hourly_temp_chart.labels | tojson }},
                data: {{ stats.hourly_temp_chart.data | tojson }}
            },
            door: {
                labels: {{ stats.hourly_door_chart.labels | tojson }},
                data: {{ stats.hourly_door_chart.data | tojson }}
            },
            status_temp: {
                labels: {{ stats.temperature_status_chart.labels | tojson }},
                data: {{ stats.temperature_status_chart.data | tojson }}
            }
        }
    };

    /**
     * ============================================================================
     * 2. CLASSES DO SISTEMA
     * ============================================================================
     */

    // --- Gerenciador de Prefer√™ncias do Usu√°rio ---
    class PreferencesManager {
        constructor() {
            this.storageKey = 'dashboard_preferences';
            this.defaults = {
                timezone: 'America/Sao_Paulo',
                period: 30
            };
            this.loadPreferences();
        }

        loadPreferences() {
            try {
                const stored = localStorage.getItem(this.storageKey);
                if (stored) {
                    this.preferences = { ...this.defaults, ...JSON.parse(stored) };
                } else {
                    this.preferences = { ...this.defaults };
                }
            } catch (e) {
                console.warn('Erro ao carregar prefer√™ncias:', e);
                this.preferences = { ...this.defaults };
            }
        }

        savePreferences() {
            try {
                localStorage.setItem(this.storageKey, JSON.stringify(this.preferences));
            } catch (e) {
                console.warn('Erro ao salvar prefer√™ncias:', e);
            }
        }

        setTimezone(timezone) {
            this.preferences.timezone = timezone;
            this.savePreferences();
        }

        setPeriod(period) {
            this.preferences.period = period;
            this.savePreferences();
        }

        getTimezone() {
            return this.preferences.timezone;
        }

        getPeriod() {
            return this.preferences.period;
        }
    }

    // --- Renderizador do Top 10 Ativos (Premium Design) ---
    class Top10AssetRenderer {
        static render(top10Data) {
            const container = document.getElementById('top10Container');
            if (!container || !top10Data || top10Data.length === 0) {
                if (container) {
                    container.innerHTML = `
                        <div class="top10-empty-state">
                            <svg class="top10-empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M9 12h6m-6 4h6M7.5 3h9a2.5 2.5 0 0 1 2.5 2.5v13A2.5 2.5 0 0 1 16.5 21h-9A2.5 2.5 0 0 1 5 18.5v-13A2.5 2.5 0 0 1 7.5 3z"></path>
                            </svg>
                            <p>Nenhum dado dispon√≠vel</p>
                            <span>Aguarde dados de deslocamento nas pr√≥ximas 24 horas</span>
                        </div>
                    `;
                }
                return;
            }

            let html = '';

            // Itera sobre cada escrit√≥rio de vendas
            top10Data.forEach((officeGroup, groupIndex) => {
                const office = officeGroup.office;
                const assets = officeGroup.assets;

                html += `
                    <div class="top10-office-group" data-office-index="${groupIndex}">
                        <div class="top10-office-header-modern">
                            <div class="top10-office-info">
                                <h3 class="top10-office-name">${office}</h3>
                                <span class="top10-assets-count">${assets.length}</span>
                            </div>
                        </div>
                        <div class="top10-assets-grid">
                `;

                // Renderiza cada ativo
                assets.forEach((asset) => {
                    const displacementColor = this.getDisplacementColor(asset.displacement_meter);
                    const displacementPercent = Math.min((asset.displacement_meter / 1000) * 100, 100);
                    const formattedTime = asset.start_time
                        ? new Date(asset.start_time).toLocaleString('pt-BR', {
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        })
                        : 'N/A';

                    const getRankBadgeClass = (rank) => {
                        if (rank === 1) return 'rank-gold';
                        if (rank === 2) return 'rank-silver';
                        if (rank === 3) return 'rank-bronze';
                        return 'rank-default';
                    };

                    html += `
                        <div class="top10-asset-card">
                            <div class="top10-card-rank ${getRankBadgeClass(asset.rank)}">
                                <span class="rank-number">#${asset.rank}</span>
                            </div>
                            <div class="top10-card-content">
                                <div class="top10-asset-serial">
                                    <span class="serial-label">Serial</span>
                                    <span class="serial-value" title="${asset.asset_serial_number}">${asset.asset_serial_number}</span>
                                </div>
                                <div class="top10-asset-time">
                                    <span class="time-label">√öltimo movimento</span>
                                    <span class="time-value">${formattedTime}</span>
                                </div>
                            </div>
                            <div class="top10-displacement-section">
                                <div class="displacement-bar-container">
                                    <div class="displacement-bar">
                                        <div class="displacement-bar-fill" style="width: ${displacementPercent}%; background: linear-gradient(90deg, ${displacementColor}, ${this.getLighterColor(displacementColor)});"></div>
                                    </div>
                                </div>
                                <span class="displacement-value" style="color: ${displacementColor};">
                                    ${asset.displacement_meter >= 1000 ? (asset.displacement_meter / 1000).toLocaleString('pt-BR', { maximumFractionDigits: 2 }) + ' km' : asset.displacement_meter.toLocaleString('pt-BR', { maximumFractionDigits: 1 }) + ' m'}
                                </span>
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        static getDisplacementColor(displacement) {
            if (displacement >= 500) return '#ef4444';  // Red
            if (displacement >= 300) return '#f97316';  // Orange
            if (displacement >= 100) return '#eab308';  // Amber
            return '#10b981';  // Green
        }

        static getLighterColor(hexColor) {
            // Retorna uma vers√£o mais clara da cor
            const colorMap = {
                '#ef4444': 'rgba(239, 68, 68, 0.3)',
                '#f97316': 'rgba(249, 115, 22, 0.3)',
                '#eab308': 'rgba(234, 179, 8, 0.3)',
                '#10b981': 'rgba(16, 185, 129, 0.3)'
            };
            return colorMap[hexColor] || hexColor;
        }
    }

    // --- Gerenciador de Timezone ---
    // --- Gerenciador de Timezone (Vers√£o Corrigida) ---
    class TimezoneConverter {
        constructor(preferencesManager) {
            this.preferencesManager = preferencesManager;
            this.currentTimezone = preferencesManager.getTimezone(); // Carrega da prefer√™ncia salva
            // Armazena uma c√≥pia profunda dos dados originais (UTC) vindos do servidor
            this.originalData = {
                temp: [...APP_CONFIG.charts.temp.data],
                door: [...APP_CONFIG.charts.door.data]
            };
            this.init();
        }
        
        init() {
            const selector = document.getElementById('timezoneSelect');
            if (selector) {
                // Define o valor inicial do select com a prefer√™ncia salva
                selector.value = this.currentTimezone;
                selector.addEventListener('change', (e) => this.changeTimezone(e.target.value));
            }
            
            // Aplica a convers√£o inicial com o fuso hor√°rio salvo
            this.changeTimezone(this.currentTimezone);
        }

        // Chamado quando novos dados chegam via Seletor de Per√≠odo
        updateOriginalData(newTempData, newDoorData) {
            this.originalData.temp = [...newTempData];
            this.originalData.door = [...newDoorData];
            // Re-aplica o timezone atual nos novos dados
            this.changeTimezone(this.currentTimezone);
        }
        
        changeTimezone(timezone) {
            this.currentTimezone = timezone;
            
            // Salva a prefer√™ncia
            this.preferencesManager.setTimezone(timezone);
            
            // 1. Calcula o Offset
            const offset = this.calculateOffset(timezone);
            
            // 2. Rotaciona os dados
            const newTempData = this.shiftDataArray(this.originalData.temp, offset);
            const newDoorData = this.shiftDataArray(this.originalData.door, offset);
            
            // 3. Atualiza os gr√°ficos COM ANIMA√á√ÉO
            if (window.hourlyTempChart) {
                window.hourlyTempChart.data.datasets[0].data = newTempData;
                window.hourlyTempChart.update(); // Removido o 'none' para animar
            }
            if (window.hourlyDoorChart) {
                window.hourlyDoorChart.data.datasets[0].data = newDoorData;
                window.hourlyDoorChart.update(); // Removido o 'none' para animar
            }

            // 4. Atualiza textos
            this.updateDisplayedTimestamps();
            
            // 5. Feedback visual no indicador
            this.showAnimation(timezone, offset);
        }
        
        calculateOffset(timezone) {
            // Cria duas datas iguais, uma em UTC e outra no Fuso destino
            const now = new Date();
            
            // Formata para string para extrair a hora "local" daquele fuso
            const utcStr = now.toLocaleString('en-US', { timeZone: 'UTC', hour12: false });
            const targetStr = now.toLocaleString('en-US', { timeZone: timezone, hour12: false });
            
            const utcDate = new Date(utcStr);
            const targetDate = new Date(targetStr);
            
            // Calcula diferen√ßa em horas (pode ser -3, +1, etc)
            const diffMs = targetDate - utcDate;
            const diffHours = Math.round(diffMs / (1000 * 60 * 60));
            
            return diffHours;
        }

        shiftDataArray(data, offset) {
            if (!data || data.length === 0) return [];
            
            const len = data.length;
            // Normaliza o offset (ex: -3 vira um shift positivo equivalente para rota√ß√£o)
            // Se offset √© -3 (BRT), significa que 03:00 UTC √© 00:00 BRT.
            // Precisamos mover o √≠ndice 3 para o √≠ndice 0. (Shift para esquerda)
            
            let shift = offset % len;
            if (shift < 0) shift += len; // Garante √≠ndice positivo

            // Se o fuso est√° ATR√ÅS do UTC (ex: -3), giramos para a esquerda (dados "futuros" do UTC viram "presente" do Local)
            // Mas espera: Se s√£o 03:00 UTC, s√£o 00:00 Brasil.
            // O dado que estava na posi√ß√£o 3 (03:00) deve ir para posi√ß√£o 0 (00:00).
            // Isso √© rotacionar o array para a esquerda em 3 posi√ß√µes.
            
            // L√≥gica de rota√ß√£o de array:
            // Data: [0h, 1h, 2h, 3h, 4h...] (UTC)
            // Queremos: [3h, 4h, 5h...] (BRT) -> O valor que era 3h vira o primeiro (0h local)
            
            // slice(3) pega do 3 em diante. slice(0, 3) pega o come√ßo.
            // [3h...].concat([0h, 1h, 2h])
            
            // Se offset calculado for negativo (ex: -3):
            // offset real para slice deve ser positivo 3.
            
            let sliceIndex = 0;
            
            // A l√≥gica do Date compare acima retorna -3 para Brasil.
            // Se diffHours √© -3. Queremos slice(3).
            // Se diffHours √© +1 (Londres ver√£o). Queremos slice(-1) ou slice(23).
            
            if (offset < 0) {
                sliceIndex = Math.abs(offset);
            } else if (offset > 0) {
                sliceIndex = len - offset;
            } else {
                return data; // Offset 0, n√£o faz nada
            }
            
            return data.slice(sliceIndex).concat(data.slice(0, sliceIndex));
        }
        
        updateDisplayedTimestamps() {
            // Atualiza qualquer elemento com data-timestamp="..."
            document.querySelectorAll('[data-timestamp]').forEach(el => {
                try {
                    const date = new Date(el.getAttribute('data-timestamp'));
                    el.textContent = date.toLocaleString('pt-BR', {
                        timeZone: this.currentTimezone,
                        year: 'numeric', month: '2-digit', day: '2-digit',
                        hour: '2-digit', minute: '2-digit'
                    });
                } catch (e) { console.warn(e); }
            });
        }
        
        showAnimation(timezone, offset) {
            const indicator = document.getElementById('timezoneIndicator');
            if (indicator) {
                // Formata nome amig√°vel: "America/Sao_Paulo" -> "Sao Paulo (UTC-3)"
                const city = timezone.split('/').pop().replace(/_/g, ' ');
                const sign = offset >= 0 ? '+' : '';
                indicator.textContent = `Exibindo: ${city} (UTC${sign}${offset})`;
                
                indicator.classList.add('timezone-updated');
                setTimeout(() => indicator.classList.remove('timezone-updated'), 500);
            }
        }
    }

    // --- Seletor de Per√≠odo (7/30 Dias) ---
    class PeriodSelector {
        constructor(preferencesManager) {
            this.preferencesManager = preferencesManager;
            this.currentPeriod = preferencesManager.getPeriod(); // Carrega da prefer√™ncia salva
            this.init();
        }
        
        init() {
            // Adiciona Click nos bot√µes
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const btnEl = e.currentTarget; // Garante pegar o bot√£o, n√£o o √≠cone
                    const days = parseInt(btnEl.dataset.period);
                    this.changePeriod(days);
                });
            });
            this.updateUI();
            this.updateBadges();
        }
        
        changePeriod(days) {
            if (this.currentPeriod === days) return; // Evita recarregar se j√° estiver ativo

            this.currentPeriod = days;
            // Salva a prefer√™ncia
            this.preferencesManager.setPeriod(days);
            
            this.updateUI();
            this.updateBadges();
            this.toggleLoading(true); // Liga loading
            this.loadStats();         // Busca dados
        }
        
        updateUI() {
            // Atualiza estilo dos bot√µes (Active/Inactive)
            document.querySelectorAll('.period-btn').forEach(btn => {
                const isActive = parseInt(btn.dataset.period) === this.currentPeriod;
                btn.classList.toggle('active', isActive);
            });
            
            // Atualiza label de texto
            const label = document.getElementById('periodLabel');
            if(label) label.textContent = `√öltimos ${this.currentPeriod} dias`;

            const labelTemp = document.getElementById('temp_per_hour_label');
            if(labelTemp) labelTemp.textContent = `üå°Ô∏è Temperatura por Hora (${this.currentPeriod}d)`;
            
            const labelDoor = document.getElementById('door_open_hour_label');
            if(labelDoor) labelDoor.textContent = `üö™ Aberturas de Porta (${this.currentPeriod}d)`;

            // Atualiza link do card de alertas
            const alertsCard = document.querySelector('[data-alerts-card]');
            if(alertsCard) {
                const alertsUrl = `{{ url_for('portal_alerts.render_alerts') }}?period=${this.currentPeriod}`;
                alertsCard.setAttribute('href', alertsUrl);
            }

            // Atualiza badge do card de missing
            const missingCard = document.querySelector('[data-missing-card]');
            if(missingCard) {
                const badge = missingCard.querySelector('.period-badge');
                if(badge) badge.textContent = `${this.currentPeriod}d`;
            }

            // Atualiza as datas no par√™nteses (ex: 01 Nov - 30 Nov)
            const dates = document.getElementById('periodDates');
            if(dates) {
                const now = new Date();
                const start = new Date();
                start.setDate(start.getDate() - this.currentPeriod);
                const fmt = new Intl.DateTimeFormat('pt-BR', { month: 'short', day: '2-digit' });
                dates.textContent = `(${fmt.format(start)} - ${fmt.format(now)})`;
            }
        }
        
        loadStats() {
            // Faz a requisi√ß√£o ao Flask enviando ?period=7 ou 30
            fetch(`${APP_CONFIG.urls.stats}?period=${this.currentPeriod}`)
                .then(res => {
                    if (!res.ok) throw new Error('Erro na rede');
                    return res.json();
                })
                .then(response => {
                    if (response.status === 'ok') {
                        this.updateDashboard(response.data);
                    } else {
                        console.error('Erro do servidor:', response.message);
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar stats:', error);
                })
                .finally(() => {
                    this.toggleLoading(false); // Desliga loading
                });
        }
        updateBadges() {
            // Pode adicionar um √≠cone de rel√≥gio para ficar mais bonito
            const icon = '<i class="far fa-clock" style="margin-right:4px;"></i>'; 
            const text = `${this.currentPeriod}d`;
            
            const badges = document.querySelectorAll('.period-badge');
            
            badges.forEach(badge => {
                badge.style.opacity = '0';
                setTimeout(() => {
                    // Injeta HTML para suportar o √≠cones
                    badge.innerHTML = icon + text;
                    badge.style.opacity = '1';
                }, 150);
            });
        }
        
        updateDashboard(stats) {
            // ============================================================
            // 1. ATUALIZA√á√ÉO DE TEXTOS (KPIs SIMPLES)
            // ============================================================
            const setText = (id, value) => {
                const el = document.getElementById(id);
                if(el) el.textContent = value;
            };

            setText('kpiTotalAssets', stats.total_assets);
            setText('kpiAssets24h', stats.assets_health_last_24h_count);
            setText('kpiAlerts', stats.alerts_period_count);
            setText('kpiMissing', stats.assets_missing_count);

            // Cards Opcionais (Verifica se o valor existe antes de tentar atualizar)
            if(stats.avg_compressor_on_time !== undefined) {
                setText('kpiCompressor', stats.avg_compressor_on_time + '%');
            }
            if(stats.avg_power_consumption !== undefined) {
                setText('kpiConsumption', stats.avg_power_consumption + ' W');
            }

            // ============================================================
            // 2. ATUALIZA√á√ÉO DE PORCENTAGENS (USANDO DADOS DO BACKEND)
            // ============================================================
            // Usar os percentuais j√° calculados corretamente no backend
            const tempOkEl = document.getElementById('tempOkPercentage');
            const tempNotOkEl = document.getElementById('tempNotOkPercentage');
            if(tempOkEl) tempOkEl.textContent = stats.temp_ok_percentage + '%';
            if(tempNotOkEl) tempNotOkEl.textContent = stats.temp_not_ok_percentage + '%';

            // Bateria (OK e NOT OK)
            const totalBat = stats.good_battery_assets_count + stats.low_battery_assets_count + stats.critical_battery_assets_count;
            const batOkPct = totalBat > 0 ? Math.round((stats.good_battery_assets_count / totalBat) * 100) : 0;
            const batNotOkPct = totalBat > 0 ? Math.round(((stats.low_battery_assets_count + stats.critical_battery_assets_count) / totalBat) * 100) : 0;
            const batteryOkEl = document.getElementById('batteryOkPercentage');
            const batteryNotOkEl = document.getElementById('batteryNotOkPercentage');
            if(batteryOkEl) batteryOkEl.textContent = batOkPct + '%';
            if(batteryNotOkEl) batteryNotOkEl.textContent = batNotOkPct + '%';

            // ============================================================
            // 3. ATUALIZA√á√ÉO DE GR√ÅFICOS DE LINHA (COM TIMEZONE)
            // ============================================================

            // A. Envia os DADOS NOVOS (UTC) para o TimezoneConverter
            if (window.timezoneConverter) {
                window.timezoneConverter.updateOriginalData(
                    stats.hourly_temp_chart.data, // Array de Temperatura
                    stats.hourly_door_chart.data  // Array de Porta
                );
            }

            // B. Re-renderiza ou esconde gr√°ficos usando DashboardManager
            DashboardManager.updateChartState(
                'hourlyTempChart', 
                'tempLineChart', 
                stats.hourly_temp_chart.data, 
                stats.hourly_temp_chart.labels,
                (ctx, data, labels) => {
                    const chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Temp M√©dia (¬∞C)',
                                data: data,
                                borderColor: '#00C3FF',
                                backgroundColor: 'rgba(0, 195, 255, 0.1)',
                                borderWidth: 3, fill: true, tension: 0.4,
                                pointBackgroundColor: '#00C3FF', pointRadius: 4
                            }]
                        },
                        options: DashboardManager._getChartOptions()
                    });
                    // Apply timezone shift immediately
                    if (window.timezoneConverter) {
                        window.timezoneConverter.changeTimezone(window.timezoneConverter.currentTimezone);
                    }
                    return chart;
                },
                'Sem dados de temperatura'
            );

            DashboardManager.updateChartState(
                'hourlyDoorChart', 
                'doorLineChart', 
                stats.hourly_door_chart.data, 
                stats.hourly_door_chart.labels,
                (ctx, data, labels) => {
                    const chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Aberturas',
                                data: data,
                                borderColor: '#00F5B5',
                                backgroundColor: 'rgba(0, 245, 181, 0.1)',
                                borderWidth: 3, fill: true, tension: 0.4,
                                pointBackgroundColor: '#00F5B5', pointRadius: 4
                            }]
                        },
                        options: DashboardManager._getChartOptions()
                    });
                    if (window.timezoneConverter) {
                        window.timezoneConverter.changeTimezone(window.timezoneConverter.currentTimezone);
                    }
                    return chart;
                },
                'Sem dados de abertura de porta'
            );

            // ============================================================
            // 4. ATUALIZA√á√ÉO DE GR√ÅFICOS DE PIZZA
            // ============================================================

            // Gr√°fico de Bateria
            const batData = [
                stats.good_battery_assets_count,
                stats.low_battery_assets_count,
                stats.critical_battery_assets_count
            ];
            DashboardManager.updateChartState(
                'batteryChart', 
                'batteryChart', 
                batData, 
                ['Boa (>50%)', 'Baixa (25-50%)', 'Cr√≠tica (<25%)'],
                (ctx, data, labels) => new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: ['#00F5B5', '#FFC93C', '#FF5A5F'],
                            borderWidth: 0,
                            borderColor: 'transparent'
                        }]
                    },
                    options: DashboardManager._getPieOptions()
                }),
                'Sem dados de bateria'
            );

            // Gr√°fico de Status de Temperatura
            DashboardManager.updateChartState(
                'temperatureChart', 
                'temperatureChart', 
                stats.temperature_status_chart.data, 
                stats.temperature_status_chart.labels,
                (ctx, data, labels) => new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: ['#00F5B5', '#FF5A5F', '#00C3FF'],
                            borderWidth: 0,
                            borderColor: 'transparent'
                        }]
                    },
                    options: DashboardManager._getPieOptions()
                }),
                'Sem dados de status'
            );

            // ============================================================
            // 5. ATUALIZA√á√ÉO DO TOP 10 ATIVOS
            // ============================================================
            if(stats.top10_assets) {
                Top10AssetRenderer.render(stats.top10_assets);
            }
        }
        
        // Helper para atualizar gr√°ficos de linha Chart.js
        updateLineChart(chartInstance, newDataObj) {
            if (chartInstance && newDataObj) {
                chartInstance.data.labels = newDataObj.labels;
                chartInstance.data.datasets[0].data = newDataObj.data;
                
                // Atualiza t√≠tulo do gr√°fico se necess√°rio (ex: "Temperatura (7d)")
                // chartInstance.options.plugins.title.text = ...
                
                chartInstance.update();
            }
        }

        // Helper para atualizar gr√°ficos de pizza Chart.js
        updatePieChart(chartInstance, newDataArray) {
            if (chartInstance && newDataArray) {
                chartInstance.data.datasets[0].data = newDataArray;
                chartInstance.update();
            }
        }
        
        toggleLoading(isLoading) {
            // Adiciona um efeito visual de "Carregando..." sobre a grade de gr√°ficos
            const grid = document.querySelector('.charts-grid');
            if(!grid) return;
            
            if(isLoading) {
                // Se j√° existe overlay, n√£o cria outro
                if (grid.querySelector('.loading-overlay')) return;
                
                const overlay = document.createElement('div');
                overlay.className = 'loading-overlay';
                overlay.innerHTML = '<div class="spinner"></div>';
                
                // Garante que o pai tenha position relative para o absolute funcionar
                grid.style.position = 'relative';
                grid.appendChild(overlay);
                
                // Opcional: Diminuir opacidade dos KPIs tamb√©m
                document.querySelector('.stats-grid').style.opacity = '0.6';
            } else {
                const overlay = grid.querySelector('.loading-overlay');
                if(overlay) overlay.remove();
                document.querySelector('.stats-grid').style.opacity = '1';
            }
        }
    }

    /**
     * ============================================================================
     * 3. GERENCIADOR CENTRAL DO DASHBOARD (FUN√á√ïES STATICAS)
     * ============================================================================
     */
    const DashboardManager = {
        init: function() {
            this.initCharts();
            this.initPercentages();
            this.initTop10();

            // Inicializa o gerenciador de prefer√™ncias
            window.preferencesManager = new PreferencesManager();

            // Inicializa classes auxiliares com as prefer√™ncias
            window.timezoneConverter = new TimezoneConverter(window.preferencesManager);
            window.periodSelector = new PeriodSelector(window.preferencesManager);
        },

        // --- Inicializa√ß√£o do Top 10 Ativos ---
        initTop10: function() {
            const backendStats = {{ stats | tojson }};
            if(backendStats.top10_assets) {
                Top10AssetRenderer.render(backendStats.top10_assets);
            }
        },

        // --- Inicializa√ß√£o dos Gr√°ficos ---
        initCharts: function() {
            try {
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js not loaded');
                    return;
                }

                // 1. Temp Line Chart
                this.updateChartState(
                    'hourlyTempChart', 
                    'tempLineChart', 
                    APP_CONFIG.charts.temp.data, 
                    APP_CONFIG.charts.temp.labels,
                    (ctx, data, labels) => new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Temp M√©dia (¬∞C)',
                                data: data,
                                borderColor: '#00C3FF',
                                backgroundColor: 'rgba(0, 195, 255, 0.1)',
                                borderWidth: 3, fill: true, tension: 0.4,
                                pointBackgroundColor: '#00C3FF', pointRadius: 4
                            }]
                        },
                        options: this._getChartOptions()
                    }),
                    'Sem dados de temperatura'
                );

                // 2. Door Line Chart
                this.updateChartState(
                    'hourlyDoorChart', 
                    'doorLineChart', 
                    APP_CONFIG.charts.door.data, 
                    APP_CONFIG.charts.door.labels,
                    (ctx, data, labels) => new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Aberturas',
                                data: data,
                                borderColor: '#00F5B5',
                                backgroundColor: 'rgba(0, 245, 181, 0.1)',
                                borderWidth: 3, fill: true, tension: 0.4,
                                pointBackgroundColor: '#00F5B5', pointRadius: 4
                            }]
                        },
                        options: this._getChartOptions()
                    }),
                    'Sem dados de abertura de porta'
                );

                // 3. Battery Pie Chart
                const s = APP_CONFIG.stats.assets;
                const batData = [s.bat_good, s.bat_low, s.bat_crit];
                this.updateChartState(
                    'batteryChart', 
                    'batteryChart', 
                    batData, 
                    ['Boa (>50%)', 'Baixa (25-50%)', 'Cr√≠tica (<25%)'],
                    (ctx, data, labels) => new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: ['#00F5B5', '#FFC93C', '#FF5A5F'],
                                borderWidth: 0,
                                borderColor: 'transparent'
                            }]
                        },
                        options: this._getPieOptions()
                    }),
                    'Sem dados de bateria'
                );

                // 4. Temperature Status Pie Chart
                this.updateChartState(
                    'temperatureChart', 
                    'temperatureChart', 
                    APP_CONFIG.charts.status_temp.data, 
                    APP_CONFIG.charts.status_temp.labels,
                    (ctx, data, labels) => new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: ['#00F5B5', '#FF5A5F', '#00C3FF'],
                                borderWidth: 0,
                                borderColor: 'transparent'
                            }]
                        },
                        options: this._getPieOptions()
                    }),
                    'Sem dados de status'
                );
            } catch (e) {
                console.error('Error initializing charts:', e);
            }
        },

        updateChartState: function(chartId, canvasId, data, labels, createChartFn, noDataMsg) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const parent = canvas.parentElement;
            const hasData = data && data.some(v => v !== 0 && v !== null);

            // Check if window[chartId] is actually a Chart instance (has .data property)
            // This prevents conflict with DOM elements having the same ID
            let chartInstance = window[chartId];
            if (chartInstance && !chartInstance.data) {
                chartInstance = null;
            }

            if (hasData) {
                // Remove no-data message
                const msg = parent.querySelector('.chart-no-data');
                if (msg) msg.remove();
                canvas.style.display = 'block';

                if (chartInstance) {
                    // Update existing chart
                    chartInstance.data.labels = labels;
                    chartInstance.data.datasets[0].data = data;
                    chartInstance.update();
                } else {
                    // Create new chart
                    const ctx = canvas.getContext('2d');
                    window[chartId] = createChartFn(ctx, data, labels);
                }
            } else {
                // Destroy existing chart if any
                if (chartInstance) {
                    chartInstance.destroy();
                    window[chartId] = null;
                }
                canvas.style.display = 'none';
                
                // Show no-data message
                if (!parent.querySelector('.chart-no-data')) {
                    const div = document.createElement('div');
                    div.className = 'chart-no-data';
                    div.innerHTML = `
                        <i class="fas fa-chart-pie" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p>${noDataMsg}</p>
                    `;
                    parent.appendChild(div);
                }
            }
        },

        // --- Inicializa√ß√£o de Percentuais (Dados do Backend) ---
        initPercentages: function() {
            // Temperatura - usar percentuais j√° calculados no backend
            const backendStats = {{ stats | tojson }};
            const tempOkEl = document.getElementById('tempOkPercentage');
            const tempNotOkEl = document.getElementById('tempNotOkPercentage');
            if(tempOkEl) tempOkEl.textContent = backendStats.temp_ok_percentage + '%';
            if(tempNotOkEl) tempNotOkEl.textContent = backendStats.temp_not_ok_percentage + '%';

            // Bateria (OK e NOT OK)
            const totalBat = backendStats.good_battery_assets_count + backendStats.low_battery_assets_count + backendStats.critical_battery_assets_count;
            const batOkPct = totalBat > 0 ? Math.round((backendStats.good_battery_assets_count / totalBat) * 100) : 0;
            const batNotOkPct = totalBat > 0 ? Math.round(((backendStats.low_battery_assets_count + backendStats.critical_battery_assets_count) / totalBat) * 100) : 0;
            const batteryOkEl = document.getElementById('batteryOkPercentage');
            const batteryNotOkEl = document.getElementById('batteryNotOkPercentage');
            if(batteryOkEl) batteryOkEl.textContent = batOkPct + '%';
            if(batteryNotOkEl) batteryNotOkEl.textContent = batNotOkPct + '%';
        },

        // --- C√°lculo de KPIs (Para auto-refresh) ---
        calculateKPIs: function(s) {
            // Temperatura - usar dados j√° calculados no backend
            const tempOkEl = document.getElementById('tempOkPercentage');
            const tempNotOkEl = document.getElementById('tempNotOkPercentage');
            if(tempOkEl) tempOkEl.textContent = (s.temp_ok_percentage || 0) + '%';
            if(tempNotOkEl) tempNotOkEl.textContent = (s.temp_not_ok_percentage || 0) + '%';

            // Bateria (OK e NOT OK)
            const totalBat = (s.good_battery_assets_count || 0) + (s.low_battery_assets_count || 0) + (s.critical_battery_assets_count || 0);
            const batOkPct = totalBat > 0 ? Math.round(((s.good_battery_assets_count || 0) / totalBat) * 100) : 0;
            const batNotOkPct = totalBat > 0 ? Math.round((((s.low_battery_assets_count || 0) + (s.critical_battery_assets_count || 0)) / totalBat) * 100) : 0;
            const batteryOkEl = document.getElementById('batteryOkPercentage');
            const batteryNotOkEl = document.getElementById('batteryNotOkPercentage');
            if(batteryOkEl) batteryOkEl.textContent = batOkPct + '%';
            if(batteryNotOkEl) batteryNotOkEl.textContent = batNotOkPct + '%';
        },

        // Helpers de Op√ß√µes de Gr√°fico
        _getChartOptions: () => ({
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(31, 31, 35, 0.95)',
                    titleColor: '#FFFFFF',
                    bodyColor: '#FFFFFF',
                    borderColor: 'rgba(0, 195, 255, 0.3)',
                    borderWidth: 1,
                    padding: 12,
                    cornerRadius: 8
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { 
                        color: 'rgba(0, 195, 255, 0.08)',
                        drawBorder: false
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)',
                        font: { weight: '600' }
                    }
                },
                x: {
                    grid: { display: false },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)',
                        font: { weight: '600' }
                    }
                }
            }
        }),

        _getPieOptions: () => ({
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        pointStyle: 'circle',
                        color: 'rgba(255, 255, 255, 0.9)',
                        font: { 
                            weight: '600',
                            size: 12
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(31, 31, 35, 0.95)',
                    titleColor: '#FFFFFF',
                    bodyColor: '#FFFFFF',
                    borderColor: 'rgba(0, 195, 255, 0.3)',
                    borderWidth: 1,
                    padding: 12,
                    cornerRadius: 8
                }
            }
        })
    };

    /**
     * ============================================================================
     * 4. START + AUTO-REFRESH
     * ============================================================================
     */
    document.addEventListener('DOMContentLoaded', () => {
        DashboardManager.init();
        
        // Auto-refresh do dashboard a cada 60 segundos
        setInterval(() => {
            // Buscar stats com o per√≠odo atual
            const periodSelector = document.querySelector('.period-btn.active');
            const currentPeriod = periodSelector ? parseInt(periodSelector.dataset.period) : 30;
            
            fetch(`{{ url_for('dashboard.get_dashboard_stats') }}?period=${currentPeriod}`)
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'ok') {
                        DashboardManager.updateDashboard(data.data);
                    }
                })
                .catch(error => {
                    console.warn('Erro no auto-refresh do dashboard:', error);
                });
        }, 60000); // 60 segundos
    });
</script>


{% endblock %}