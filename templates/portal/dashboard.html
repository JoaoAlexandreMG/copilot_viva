{% extends "portal/base.html" %}
{% block title %}Dashboard{% endblock %}
{% block page_title %}Dashboard de Monitoramento{% endblock %}

{% block breadcrumb %}
    <i class="fas fa-home"></i>
    <span>Dashboard</span>
{% endblock %}

{% block styles %}
    {{ super() }} 
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}

<!-- Timezone Selector -->
<div class="timezone-selector-container">
    <label for="timezoneSelect" class="timezone-label">
        <i class="fas fa-clock"></i> Fuso Hor√°rio:
    </label>
    <select id="timezoneSelect" class="timezone-select">
        <option value="America/Sao_Paulo" selected>Brasil (UTC-3)</option>
        <option value="UTC">UTC (UTC+0)</option>
        <option value="America/New_York">New York (UTC-5/-4)</option>
        <option value="Europe/London">London (UTC+0/+1)</option>
        <option value="Europe/Madrid">Madrid (UTC+1/+2)</option>
        <option value="Asia/Shanghai">Shanghai (UTC+8)</option>
        <option value="Asia/Tokyo">Tokyo (UTC+9)</option>
    </select>
    <div id="timezoneIndicator" class="timezone-indicator">
        Exibindo hor√°rios em: BRT
    </div>
</div>

<!-- Period Toggle Button -->
<div class="period-selector-container">
    <div class="period-toggle">
        <button class="period-btn active" data-period="30">
            <i class="fas fa-calendar"></i> 30 Dias
        </button>
        <button class="period-btn" data-period="7">
            <i class="fas fa-calendar-week"></i> 7 Dias
        </button>
    </div>
    <div class="period-indicator">
        <span id="periodLabel">√öltimos 30 dias</span>
        <span id="periodDates" class="period-dates"></span>
    </div>
</div>

<div class="stats-grid">
    
    <div class="stat-card">
        <div class="stat-icon bg-indigo">
            <i class="fas fa-boxes"></i>
        </div>
        <div class="stat-content">
            <p class="stat-label">Total de Ativos</p>
            <h4 class="stat-value" id="kpiTotalAssets">{{ stats.total_assets }}</h4>
        </div>
    </div>

    <a href="{{url_for('portal_tracking.render_tracking')}}?is_active=true" class="stat-card clickable">
        <div class="stat-icon bg-green">
            <i class="fas fa-heartbeat"></i>
        </div>
        <div class="stat-content">
            <p class="stat-label">Ativos (24h)</p>
            <h4 class="stat-value" id="kpiAssets24h">{{ stats.assets_health_last_24h_count }}</h4>
        </div>
        <div class="stat-arrow">
            <i class="fas fa-chevron-right"></i>
        </div>
    </a>

    <div class="stat-card temp-card">
        <div class="stat-icon bg-blue">
            <i class="fas fa-thermometer-half"></i>
        </div>
        
        <div class="stat-content">
            <p class="stat-label">Temperatura <small class="click-hint"></small></p>
            
            <div class="split-values">
                <a href="{{url_for('portal_tracking.render_tracking')}}?temp_is_ok=true" class="split-item clickable-split">
                    <span class="dot green"></span>
                    <span class="split-text">OK:</span>
                    <span class="split-val" id="tempOkPercentage">0%</span>
                </a>
                <div class="split-divider"></div>
                <a href="{{url_for('portal_tracking.render_tracking')}}?temp_is_ok=false" class="split-item clickable-split">
                    <span class="dot red"></span>
                    <span class="split-text">Ruim:</span>
                    <span class="split-val" id="tempNotOkPercentage">0%</span>
                </a>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon bg-teal">
            <i class="fas fa-battery-full"></i>
        </div>
        <div class="stat-content">
            <p class="stat-label">Bateria >50%</p>
            <h4 class="stat-value" id="batteryPercentage">0%</h4>
        </div>
    </div>

    <div class="stat-card" data-alerts-card>
        <div class="stat-icon bg-red">
            <i class="fas fa-bell"></i>
        </div>
        <div class="stat-content">
            <p class="stat-label">Alertas</p>
            <h4 class="stat-value" id="kpiAlerts">{{ stats.alerts_period_count }}</h4>
        </div>
        <span class="period-badge">30d</span>
    </div>

    <div class="stat-card" id="cardCompressor" style="display: {{ 'flex' if stats.avg_compressor_on_time and stats.avg_compressor_on_time > 0 else 'none' }};">
        <div class="stat-icon bg-cyan">
            <i class="fas fa-cogs"></i>
        </div>
        <div class="stat-content">
            <p class="stat-label">Compressor</p>
            <h4 class="stat-value" id="kpiCompressor">{{ stats.avg_compressor_on_time }}%</h4>
        </div>
        <span class="period-badge">30d</span>
    </div>

    <div class="stat-card" id="cardConsumption" style="display: {{ 'flex' if stats.avg_power_consumption and stats.avg_power_consumption > 0 else 'none' }};">
        <div class="stat-icon bg-orange">
            <i class="fas fa-bolt"></i>
        </div>
        <div class="stat-content">
            <p class="stat-label">Consumo</p>
            <h4 class="stat-value" id="kpiConsumption">{{ stats.avg_power_consumption }} W</h4>
        </div>
        <span class="period-badge">30d</span>
    </div>

</div>

<!-- Import Section with Button -->
<div class="import-section">
    <div class="import-section-header">
        <h3 class="import-section-title">
            <i class="fas fa-upload"></i> Gerenciamento de Dados
        </h3>
        <p class="import-section-desc">Importe arquivos de dados para atualizar informa√ß√µes da plataforma</p>
    </div>
    <button id="openImportModal" class="btn-import-primary">
        <i class="fas fa-upload"></i> Importar Arquivo
    </button>
</div>

<!-- Import Modal -->
<div id="importModal" class="import-modal" style="display:none;">
    <div class="import-modal-overlay"></div>
    <div class="import-modal-content">
        <div class="import-modal-header">
            <h2>Importar Arquivo de Dados</h2>
            <button id="closeImportX" class="import-modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="import-modal-body">
            <div class="import-file-zone">
                <div class="import-file-icon">
                    <i class="fas fa-file-upload"></i>
                </div>
                <p class="import-file-title">Selecione um arquivo para importar</p>
                <p class="import-file-desc">Arquivos suportados: CSV, XLSX</p>
                <label for="importFileInput" class="import-file-input-label">
                    <input type="file" id="importFileInput" accept=".csv,.xlsx" class="import-file-input" />
                    <span class="import-file-input-text">Clique ou arraste um arquivo</span>
                </label>
                <p id="importFileName" class="import-file-name" style="display:none;"></p>
            </div>

            <div id="importFeedback" class="import-feedback" style="display:none;"></div>
        </div>

        <div class="import-modal-footer">
            <button id="startImport" class="import-btn-start" disabled>
                <i class="fas fa-play"></i> Iniciar Importa√ß√£o
            </button>
            <button id="closeImport" class="import-btn-cancel">
                <i class="fas fa-times"></i> Fechar
            </button>
        </div>
    </div>
</div>

<!-- Charts Section - 2x2 Grid -->
<div class="charts-grid">
    <!-- Temperatura por Hora (30d) - Line Chart -->
    <div class="chart-card">
        <div class="chart-header">
            <h3>üå°Ô∏è Temperatura por Hora (30d)</h3>
        </div>
        <div class="chart-body">
            <canvas id="tempLineChart" height="300"></canvas>
        </div>
    </div>

    <!-- Aberturas de Porta (30d) - Line Chart -->
    <div class="chart-card">
        <div class="chart-header">
            <h3>üö™ Aberturas de Porta (30d)</h3>
        </div>
        <div class="chart-body">
            <canvas id="doorLineChart" height="300"></canvas>
        </div>
    </div>

    <!-- Distribui√ß√£o de Sa√∫de de Bateria - Pie Chart -->
    <div class="chart-card">
        <div class="chart-header">
            <h3>üîã Distribui√ß√£o de Sa√∫de de Bateria</h3>
        </div>
        <div class="chart-body">
            <canvas id="batteryChart" height="300"></canvas>
        </div>
    </div>

    <!-- Status de Temperatura das Geladeiras - Pie Chart -->
    <div class="chart-card">
        <div class="chart-header">
            <h3>‚ùÑÔ∏è Status de Temperatura das Geladeiras</h3>
        </div>
        <div class="chart-body">
            <canvas id="temperatureChart" height="300"></canvas>
        </div>
    </div>
</div>

<!-- Navigation Cards -->
<div class="card" style="margin-top: 2rem;">
    <div class="card-header">
        <h3 class="card-title">üîó Acesso R√°pido</h3>
    </div>
    <div class="card-body">
        <div class="dashboard-cards" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
            <!-- Users Card -->
            <a href="{{url_for('portal_users.list_and_create_users')}}" class="dashboard-card">
                <div class="dashboard-card-icon primary">
                    <i class="fas fa-users"></i>
                </div>
                <h3 class="dashboard-card-title">Usu√°rios</h3>
                <p class="dashboard-card-subtitle">Gerencie usu√°rios</p>
            </a>

            <!-- Outlets Card -->
            <a href="{{url_for('portal_outlets.list_and_create_outlets')}}" class="dashboard-card">
                <div class="dashboard-card-icon success">
                    <i class="fas fa-store"></i>
                </div>
                <h3 class="dashboard-card-title">Outlets</h3>
                <p class="dashboard-card-subtitle">Pontos de venda</p>
            </a>

            <!-- Assets Card -->
            <a href="{{url_for('portal_assets.list_and_create_assets')}}" class="dashboard-card">
                <div class="dashboard-card-icon warning">
                    <i class="fas fa-boxes"></i>
                </div>
                <h3 class="dashboard-card-title">Assets</h3>
                <p class="dashboard-card-subtitle">Controle de ativos</p>
            </a>

            <!-- Smart Devices Card -->
            <a href="{{url_for('portal_smartdevices.list_and_create_smartdevices')}}" class="dashboard-card">
                <div class="dashboard-card-icon danger">
                    <i class="fas fa-mobile-alt"></i>
                </div>
                <h3 class="dashboard-card-title">Smart Devices</h3>
                <p class="dashboard-card-subtitle">Dispositivos conectados</p>
            </a>

            <!-- Tracking Card -->
            <a href="{{url_for('portal_tracking.render_tracking')}}" class="dashboard-card">
                <div class="dashboard-card-icon info">
                    <i class="fas fa-location-dot"></i>
                </div>
                <h3 class="dashboard-card-title">Rastreio</h3>
                <p class="dashboard-card-subtitle">Localiza√ß√£o em mapa</p>
            </a>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    /**
     * ============================================================================
     * 1. CONFIGURA√á√ÉO E DADOS (SERVER-SIDE DATA)
     * Centraliza todas as vari√°veis do Jinja2 aqui. Facilita a manuten√ß√£o.
     * ============================================================================
     */
    const APP_CONFIG = {
        urls: {
            import: "{{ url_for('dashboard.import_file') }}",
            stats: "{{ url_for('dashboard.get_dashboard_stats') }}"
        },
        stats: {
            assets: {
                total: {{ stats.total_assets }},
                temp_ok: {{ stats.ok_temperatures_count }},
                temp_total: {{ stats.total_with_temperature }},
                bat_good: {{ stats.good_battery_assets_count }},
                bat_low: {{ stats.low_battery_assets_count }},
                bat_crit: {{ stats.critical_battery_assets_count }}
            }
        },
        charts: {
            temp: {
                labels: {{ stats.hourly_temp_chart.labels | tojson }},
                data: {{ stats.hourly_temp_chart.data | tojson }}
            },
            door: {
                labels: {{ stats.hourly_door_chart.labels | tojson }},
                data: {{ stats.hourly_door_chart.data | tojson }}
            },
            status_temp: {
                labels: {{ stats.temperature_status_chart.labels | tojson }},
                data: {{ stats.temperature_status_chart.data | tojson }}
            }
        }
    };

    /**
     * ============================================================================
     * 2. CLASSES DO SISTEMA
     * ============================================================================
     */

    // --- Gerenciador de Timezone ---
    // --- Gerenciador de Timezone (Vers√£o Corrigida) ---
    class TimezoneConverter {
        constructor() {
            this.currentTimezone = 'America/Sao_Paulo'; // Padr√£o inicial
            // Armazena uma c√≥pia profunda dos dados originais (UTC) vindos do servidor
            this.originalData = {
                temp: [...APP_CONFIG.charts.temp.data],
                door: [...APP_CONFIG.charts.door.data]
            };
            this.init();
        }
        
        init() {
            const selector = document.getElementById('timezoneSelect');
            if (selector) {
                // Define o valor inicial do select se necess√°rio
                selector.value = this.currentTimezone;
                selector.addEventListener('change', (e) => this.changeTimezone(e.target.value));
            }
            
            // Aplica a convers√£o inicial (caso o servidor mande UTC e a gente queira BRT logo de cara)
            this.changeTimezone(this.currentTimezone);
        }

        // Chamado quando novos dados chegam via Seletor de Per√≠odo
        updateOriginalData(newTempData, newDoorData) {
            this.originalData.temp = [...newTempData];
            this.originalData.door = [...newDoorData];
            // Re-aplica o timezone atual nos novos dados
            this.changeTimezone(this.currentTimezone);
        }
        
        changeTimezone(timezone) {
            this.currentTimezone = timezone;
            
            // 1. Calcula o Offset
            const offset = this.calculateOffset(timezone);
            
            // 2. Rotaciona os dados
            const newTempData = this.shiftDataArray(this.originalData.temp, offset);
            const newDoorData = this.shiftDataArray(this.originalData.door, offset);
            
            // 3. Atualiza os gr√°ficos COM ANIMA√á√ÉO
            if (window.hourlyTempChart) {
                window.hourlyTempChart.data.datasets[0].data = newTempData;
                window.hourlyTempChart.update(); // Removido o 'none' para animar
            }
            if (window.hourlyDoorChart) {
                window.hourlyDoorChart.data.datasets[0].data = newDoorData;
                window.hourlyDoorChart.update(); // Removido o 'none' para animar
            }

            // 4. Atualiza textos
            this.updateDisplayedTimestamps();
            
            // 5. Feedback visual no indicador
            this.showAnimation(timezone, offset);
        }
        
        calculateOffset(timezone) {
            // Cria duas datas iguais, uma em UTC e outra no Fuso destino
            const now = new Date();
            
            // Formata para string para extrair a hora "local" daquele fuso
            const utcStr = now.toLocaleString('en-US', { timeZone: 'UTC', hour12: false });
            const targetStr = now.toLocaleString('en-US', { timeZone: timezone, hour12: false });
            
            const utcDate = new Date(utcStr);
            const targetDate = new Date(targetStr);
            
            // Calcula diferen√ßa em horas (pode ser -3, +1, etc)
            const diffMs = targetDate - utcDate;
            const diffHours = Math.round(diffMs / (1000 * 60 * 60));
            
            return diffHours;
        }

        shiftDataArray(data, offset) {
            if (!data || data.length === 0) return [];
            
            const len = data.length;
            // Normaliza o offset (ex: -3 vira um shift positivo equivalente para rota√ß√£o)
            // Se offset √© -3 (BRT), significa que 03:00 UTC √© 00:00 BRT.
            // Precisamos mover o √≠ndice 3 para o √≠ndice 0. (Shift para esquerda)
            
            let shift = offset % len;
            if (shift < 0) shift += len; // Garante √≠ndice positivo

            // Se o fuso est√° ATR√ÅS do UTC (ex: -3), giramos para a esquerda (dados "futuros" do UTC viram "presente" do Local)
            // Mas espera: Se s√£o 03:00 UTC, s√£o 00:00 Brasil.
            // O dado que estava na posi√ß√£o 3 (03:00) deve ir para posi√ß√£o 0 (00:00).
            // Isso √© rotacionar o array para a esquerda em 3 posi√ß√µes.
            
            // L√≥gica de rota√ß√£o de array:
            // Data: [0h, 1h, 2h, 3h, 4h...] (UTC)
            // Queremos: [3h, 4h, 5h...] (BRT) -> O valor que era 3h vira o primeiro (0h local)
            
            // slice(3) pega do 3 em diante. slice(0, 3) pega o come√ßo.
            // [3h...].concat([0h, 1h, 2h])
            
            // Se offset calculado for negativo (ex: -3):
            // offset real para slice deve ser positivo 3.
            
            let sliceIndex = 0;
            
            // A l√≥gica do Date compare acima retorna -3 para Brasil.
            // Se diffHours √© -3. Queremos slice(3).
            // Se diffHours √© +1 (Londres ver√£o). Queremos slice(-1) ou slice(23).
            
            if (offset < 0) {
                sliceIndex = Math.abs(offset);
            } else if (offset > 0) {
                sliceIndex = len - offset;
            } else {
                return data; // Offset 0, n√£o faz nada
            }
            
            return data.slice(sliceIndex).concat(data.slice(0, sliceIndex));
        }
        
        updateDisplayedTimestamps() {
            // Atualiza qualquer elemento com data-timestamp="..."
            document.querySelectorAll('[data-timestamp]').forEach(el => {
                try {
                    const date = new Date(el.getAttribute('data-timestamp'));
                    el.textContent = date.toLocaleString('pt-BR', {
                        timeZone: this.currentTimezone,
                        year: 'numeric', month: '2-digit', day: '2-digit',
                        hour: '2-digit', minute: '2-digit'
                    });
                } catch (e) { console.warn(e); }
            });
        }
        
        showAnimation(timezone, offset) {
            const indicator = document.getElementById('timezoneIndicator');
            if (indicator) {
                // Formata nome amig√°vel: "America/Sao_Paulo" -> "Sao Paulo (UTC-3)"
                const city = timezone.split('/').pop().replace(/_/g, ' ');
                const sign = offset >= 0 ? '+' : '';
                indicator.textContent = `Exibindo: ${city} (UTC${sign}${offset})`;
                
                indicator.classList.add('timezone-updated');
                setTimeout(() => indicator.classList.remove('timezone-updated'), 500);
            }
        }
    }

    // --- Seletor de Per√≠odo (7/30 Dias) ---
    // --- Seletor de Per√≠odo (7/30 Dias) ---
    class PeriodSelector {
        constructor() {
            this.currentPeriod = 30;
            this.init();
        }
        
        init() {
            // Adiciona Click nos bot√µes
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const btnEl = e.currentTarget; // Garante pegar o bot√£o, n√£o o √≠cone
                    const days = parseInt(btnEl.dataset.period);
                    this.changePeriod(days);
                });
            });
            this.updateUI();
            this.updateBadges();
        }
        
        changePeriod(days) {
            if (this.currentPeriod === days) return; // Evita recarregar se j√° estiver ativo

            this.currentPeriod = days;
            this.updateUI();
            this.updateBadges();
            this.toggleLoading(true); // Liga loading
            this.loadStats();         // Busca dados
        }
        
        updateUI() {
            // Atualiza estilo dos bot√µes (Active/Inactive)
            document.querySelectorAll('.period-btn').forEach(btn => {
                const isActive = parseInt(btn.dataset.period) === this.currentPeriod;
                btn.classList.toggle('active', isActive);
            });
            
            // Atualiza label de texto
            const label = document.getElementById('periodLabel');
            if(label) label.textContent = `√öltimos ${this.currentPeriod} dias`;
            
            // Atualiza as datas no par√™nteses (ex: 01 Nov - 30 Nov)
            const dates = document.getElementById('periodDates');
            if(dates) {
                const now = new Date();
                const start = new Date();
                start.setDate(start.getDate() - this.currentPeriod);
                const fmt = new Intl.DateTimeFormat('pt-BR', { month: 'short', day: '2-digit' });
                dates.textContent = `(${fmt.format(start)} - ${fmt.format(now)})`;
            }
        }
        
        loadStats() {
            // Faz a requisi√ß√£o ao Flask enviando ?period=7 ou 30
            fetch(`${APP_CONFIG.urls.stats}?period=${this.currentPeriod}`)
                .then(res => {
                    if (!res.ok) throw new Error('Erro na rede');
                    return res.json();
                })
                .then(response => {
                    if (response.status === 'ok') {
                        this.updateDashboard(response.data);
                    } else {
                        console.error('Erro do servidor:', response.message);
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar stats:', error);
                })
                .finally(() => {
                    this.toggleLoading(false); // Desliga loading
                });
        }
        updateBadges() {
            // Pode adicionar um √≠cone de rel√≥gio para ficar mais bonito
            const icon = '<i class="far fa-clock" style="margin-right:4px;"></i>'; 
            const text = `${this.currentPeriod}d`;
            
            const badges = document.querySelectorAll('.period-badge');
            
            badges.forEach(badge => {
                badge.style.opacity = '0';
                setTimeout(() => {
                    // Injeta HTML para suportar o √≠cones
                    badge.innerHTML = icon + text;
                    badge.style.opacity = '1';
                }, 150);
            });
        }
        
        updateDashboard(stats) {
            // ============================================================
            // 1. ATUALIZA√á√ÉO DE TEXTOS (KPIs SIMPLES)
            // ============================================================
            const setText = (id, value) => {
                const el = document.getElementById(id);
                if(el) el.textContent = value;
            };

            setText('kpiTotalAssets', stats.total_assets);
            setText('kpiAssets24h', stats.assets_health_last_24h_count);
            setText('kpiAlerts', stats.alerts_period_count);
            
            // Cards Opcionais (Verifica se o valor existe antes de tentar atualizar)
            if(stats.avg_compressor_on_time !== undefined) {
                setText('kpiCompressor', stats.avg_compressor_on_time + '%');
            }
            if(stats.avg_power_consumption !== undefined) {
                setText('kpiConsumption', stats.avg_power_consumption + ' W');
            }

            // ============================================================
            // 2. ATUALIZA√á√ÉO DE PORCENTAGENS (USANDO DADOS DO BACKEND)
            // ============================================================
            // Usar os percentuais j√° calculados corretamente no backend
            const tempOkEl = document.getElementById('tempOkPercentage');
            const tempNotOkEl = document.getElementById('tempNotOkPercentage');
            if(tempOkEl) tempOkEl.textContent = stats.temp_ok_percentage + '%';
            if(tempNotOkEl) tempNotOkEl.textContent = stats.temp_not_ok_percentage + '%';

            // Bateria (manter c√°lculo local pois funciona corretamente)
            const totalBat = stats.good_battery_assets_count + stats.low_battery_assets_count + stats.critical_battery_assets_count;
            const batPct = totalBat > 0 ? Math.round((stats.good_battery_assets_count / totalBat) * 100) : 0;
            const batteryEl = document.getElementById('batteryPercentage');
            if(batteryEl) batteryEl.textContent = batPct + '%';

            // ============================================================
            // 3. ATUALIZA√á√ÉO DE GR√ÅFICOS DE LINHA (COM TIMEZONE)
            // ============================================================
            
            // A. Atualiza os Labels (Eixo X) dos gr√°ficos globais
            if (window.hourlyTempChart) window.hourlyTempChart.data.labels = stats.hourly_temp_chart.labels;
            if (window.hourlyDoorChart) window.hourlyDoorChart.data.labels = stats.hourly_door_chart.labels;

            // B. Envia os DADOS NOVOS (UTC) para o TimezoneConverter
            // O Converter vai guardar esses dados, aplicar o offset do fuso hor√°rio atual
            // e atualizar visualmente os gr√°ficos de linha.
            if (window.timezoneConverter) {
                window.timezoneConverter.updateOriginalData(
                    stats.hourly_temp_chart.data, // Array de Temperatura
                    stats.hourly_door_chart.data  // Array de Porta
                );
            }

            // ============================================================
            // 4. ATUALIZA√á√ÉO DE GR√ÅFICOS DE PIZZA
            // ============================================================
            
            // Gr√°fico de Bateria
            this.updatePieChart(window.batteryChart, [
                stats.good_battery_assets_count, 
                stats.low_battery_assets_count, 
                stats.critical_battery_assets_count
            ]);

            // Gr√°fico de Status de Temperatura
            this.updatePieChart(window.temperatureChart, stats.temperature_status_chart.data);
        }
        
        // Helper para atualizar gr√°ficos de linha Chart.js
        updateLineChart(chartInstance, newDataObj) {
            if (chartInstance && newDataObj) {
                chartInstance.data.labels = newDataObj.labels;
                chartInstance.data.datasets[0].data = newDataObj.data;
                
                // Atualiza t√≠tulo do gr√°fico se necess√°rio (ex: "Temperatura (7d)")
                // chartInstance.options.plugins.title.text = ...
                
                chartInstance.update();
            }
        }

        // Helper para atualizar gr√°ficos de pizza Chart.js
        updatePieChart(chartInstance, newDataArray) {
            if (chartInstance && newDataArray) {
                chartInstance.data.datasets[0].data = newDataArray;
                chartInstance.update();
            }
        }
        
        toggleLoading(isLoading) {
            // Adiciona um efeito visual de "Carregando..." sobre a grade de gr√°ficos
            const grid = document.querySelector('.charts-grid');
            if(!grid) return;
            
            if(isLoading) {
                // Se j√° existe overlay, n√£o cria outro
                if (grid.querySelector('.loading-overlay')) return;
                
                const overlay = document.createElement('div');
                overlay.className = 'loading-overlay';
                overlay.innerHTML = '<div class="spinner"></div>';
                
                // Garante que o pai tenha position relative para o absolute funcionar
                grid.style.position = 'relative';
                grid.appendChild(overlay);
                
                // Opcional: Diminuir opacidade dos KPIs tamb√©m
                document.querySelector('.stats-grid').style.opacity = '0.6';
            } else {
                const overlay = grid.querySelector('.loading-overlay');
                if(overlay) overlay.remove();
                document.querySelector('.stats-grid').style.opacity = '1';
            }
        }
    }

    /**
     * ============================================================================
     * 3. GERENCIADOR CENTRAL DO DASHBOARD (FUN√á√ïES STATICAS)
     * ============================================================================
     */
    const DashboardManager = {
        init: function() {
            this.initImportModal();
            this.initCharts();
            this.initPercentages();
            
            // Inicializa classes auxiliares
            window.timezoneConverter = new TimezoneConverter();
            window.periodSelector = new PeriodSelector();
        },

        // --- L√≥gica do Modal de Importa√ß√£o ---
        initImportModal: function() {
            const modal = document.getElementById('importModal');
            const input = document.getElementById('importFileInput');
            const btnStart = document.getElementById('startImport');
            const feedback = document.getElementById('importFeedback');
            const fileNameDisplay = document.getElementById('importFileName');
            const zone = document.querySelector('.import-file-zone');

            if (!modal) return;

            const closeModal = () => {
                modal.style.display = 'none';
                input.value = '';
                fileNameDisplay.style.display = 'none';
                feedback.style.display = 'none';
                btnStart.disabled = true;
            };

            // Event Listeners
            document.getElementById('openImportModal').onclick = () => {
                modal.style.display = 'flex';
                closeModal(); // Reset visual state but keep display flex
                modal.style.display = 'flex';
            };
            document.getElementById('closeImport').onclick = closeModal;
            document.getElementById('closeImportX').onclick = closeModal;
            document.querySelector('.import-modal-overlay').onclick = closeModal;

            // File Handling
            const handleFile = (file) => {
                if (file) {
                    fileNameDisplay.textContent = `üìÑ ${file.name}`;
                    fileNameDisplay.style.display = 'block';
                    btnStart.disabled = false;
                }
            };

            input.onchange = (e) => handleFile(e.target.files[0]);

            // Drag & Drop
            zone.ondragover = (e) => { e.preventDefault(); zone.classList.add('dragover'); };
            zone.ondragleave = () => zone.classList.remove('dragover');
            zone.ondrop = (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
                if (e.dataTransfer.files.length) {
                    input.files = e.dataTransfer.files;
                    handleFile(e.dataTransfer.files[0]);
                }
            };

            // Upload Action
            btnStart.onclick = async () => {
                const file = input.files[0];
                if (!file) return;

                btnStart.disabled = true;
                feedback.innerHTML = '<div class="import-feedback-loading">‚è≥ Processando...</div>';
                feedback.style.display = 'block';

                const formData = new FormData();
                formData.append('file', file);

                try {
                    const res = await fetch(APP_CONFIG.urls.import, { method: 'POST', body: formData });
                    const data = await res.json();

                    if (res.ok && data.status === 'ok') {
                        const { inserted = 0, updated = 0 } = data.result || {};
                        feedback.innerHTML = `
                            <div class="import-feedback-success">
                                <strong>‚úÖ Sucesso!</strong>
                                <div class="import-stats">
                                    <p><span class="stat-label">Novos:</span> <span class="stat-value">${inserted}</span></p>
                                    <p><span class="stat-label">Atualizados:</span> <span class="stat-value">${updated}</span></p>
                                </div>
                            </div>`;
                        setTimeout(closeModal, 4000);
                    } else {
                        throw new Error(data.message || 'Erro desconhecido');
                    }
                } catch (err) {
                    feedback.innerHTML = `<div class="import-feedback-error">‚ùå ${err.message}</div>`;
                    btnStart.disabled = false;
                }
            };
        },

        // --- Inicializa√ß√£o dos Gr√°ficos ---
        initCharts: function() {
            // 1. Temp Line Chart
            const tempCtx = document.getElementById('tempLineChart')?.getContext('2d');
            if (tempCtx) {
                window.hourlyTempChart = new Chart(tempCtx, {
                    type: 'line',
                    data: {
                        labels: APP_CONFIG.charts.temp.labels,
                        datasets: [{
                            label: 'Temp M√©dia (¬∞C)',
                            data: APP_CONFIG.charts.temp.data,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3, fill: true, tension: 0.4,
                            pointBackgroundColor: '#667eea', pointRadius: 4
                        }]
                    },
                    options: this._getChartOptions()
                });
            }

            // 2. Door Line Chart
            const doorCtx = document.getElementById('doorLineChart')?.getContext('2d');
            if (doorCtx) {
                window.hourlyDoorChart = new Chart(doorCtx, {
                    type: 'line',
                    data: {
                        labels: APP_CONFIG.charts.door.labels,
                        datasets: [{
                            label: 'Aberturas',
                            data: APP_CONFIG.charts.door.data,
                            borderColor: '#f6ad55',
                            backgroundColor: 'rgba(246, 173, 85, 0.1)',
                            borderWidth: 3, fill: true, tension: 0.4,
                            pointBackgroundColor: '#f6ad55', pointRadius: 4
                        }]
                    },
                    options: this._getChartOptions()
                });
            }

            // 3. Battery Pie Chart
            const batCtx = document.getElementById('batteryChart')?.getContext('2d');
            if (batCtx) {
                const s = APP_CONFIG.stats.assets;
                window.batteryChart = new Chart(batCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Boa (>50%)', 'Baixa (25-50%)', 'Cr√≠tica (<25%)'],
                        datasets: [{
                            data: [s.bat_good, s.bat_low, s.bat_crit],
                            backgroundColor: ['#48bb78', '#f6ad55', '#f56565'],
                            borderWidth: 2
                        }]
                    },
                    options: this._getPieOptions()
                });
            }

            // 4. Temperature Status Pie Chart
            const statusCtx = document.getElementById('temperatureChart')?.getContext('2d');
            if (statusCtx) {
                window.temperatureChart = new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: APP_CONFIG.charts.status_temp.labels,
                        datasets: [{
                            data: APP_CONFIG.charts.status_temp.data,
                            backgroundColor: ['#48bb78', '#f56565', '#667eea'],
                            borderWidth: 2
                        }]
                    },
                    options: this._getPieOptions()
                });
            }
        },

        // --- Inicializa√ß√£o de Percentuais (Dados do Backend) ---
        initPercentages: function() {
            // Temperatura - usar percentuais j√° calculados no backend
            const backendStats = {{ stats | tojson }};
            const tempOkEl = document.getElementById('tempOkPercentage');
            const tempNotOkEl = document.getElementById('tempNotOkPercentage');
            if(tempOkEl) tempOkEl.textContent = backendStats.temp_ok_percentage + '%';
            if(tempNotOkEl) tempNotOkEl.textContent = backendStats.temp_not_ok_percentage + '%';

            // Bateria
            const totalBat = backendStats.good_battery_assets_count + backendStats.low_battery_assets_count + backendStats.critical_battery_assets_count;
            const batPct = totalBat > 0 ? Math.round((backendStats.good_battery_assets_count / totalBat) * 100) : 0;
            const batteryEl = document.getElementById('batteryPercentage');
            if(batteryEl) batteryEl.textContent = batPct + '%';
        },

        // --- C√°lculo de KPIs (Para auto-refresh) ---
        calculateKPIs: function(s) {
            // Temperatura - usar dados j√° calculados no backend
            const tempOkEl = document.getElementById('tempOkPercentage');
            const tempNotOkEl = document.getElementById('tempNotOkPercentage');
            if(tempOkEl) tempOkEl.textContent = (s.temp_ok_percentage || 0) + '%';
            if(tempNotOkEl) tempNotOkEl.textContent = (s.temp_not_ok_percentage || 0) + '%';

            // Bateria
            const totalBat = (s.good_battery_assets_count || 0) + (s.low_battery_assets_count || 0) + (s.critical_battery_assets_count || 0);
            const batPct = totalBat > 0 ? Math.round(((s.good_battery_assets_count || 0) / totalBat) * 100) : 0;
            const batteryEl = document.getElementById('batteryPercentage');
            if(batteryEl) batteryEl.textContent = batPct + '%';
        },

        // Helpers de Op√ß√µes de Gr√°fico
        _getChartOptions: () => ({
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } }, // Legenda oculta para visual limpo
            scales: {
                y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
                x: { grid: { display: false } }
            }
        }),

        _getPieOptions: () => ({
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true } } }
        })
    };

    /**
     * ============================================================================
     * 4. START + AUTO-REFRESH
     * ============================================================================
     */
    document.addEventListener('DOMContentLoaded', () => {
        DashboardManager.init();
        
        // Auto-refresh do dashboard a cada 60 segundos
        setInterval(() => {
            // Buscar stats com o per√≠odo atual
            const periodSelector = document.querySelector('.period-btn.active');
            const currentPeriod = periodSelector ? parseInt(periodSelector.dataset.period) : 30;
            
            fetch(`{{ url_for('dashboard.get_dashboard_stats') }}?period=${currentPeriod}`)
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'ok') {
                        DashboardManager.updateDashboard(data.data);
                        console.log('Dashboard atualizado automaticamente');
                    }
                })
                .catch(error => {
                    console.warn('Erro no auto-refresh do dashboard:', error);
                });
        }, 60000); // 60 segundos
    });
</script>


{% endblock %}