{% extends "portal/base.html" %}

{% block title %}Gerenciar Usuários{% endblock %}
{% block page_title %}Usuários{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/form-validation.css') }}">
{% endblock %}

{% block breadcrumb %}
    <i class="fas fa-home"></i>
    <span>/</span>
    <span>Usuários</span>
{% endblock %}

{% block header_actions %}
    <button class="btn btn-primary" onclick="showCreateForm()">
        <i class="fas fa-plus"></i>
        <span>Novo Usuário</span>
    </button>
{% endblock %}

{% block content %}
{% if page_type == 'list' %}

<!-- Search and Filters -->
<div class="card mb-lg">
    <div class="card-body">
        <div class="search-bar" style="position: relative;">
            <i class="fas fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--color-gray-400);"></i>
            <input
                type="text"
                id="searchBar"
                class="form-control"
                placeholder="Buscar por nome, email, UPN..."
                autocomplete="off"
                style="padding-left: 36px;">
            <div id="searchIndicator" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); display: none;">
                <i class="fas fa-spinner fa-spin" style="color: var(--color-primary);"></i>
            </div>
        </div>
    </div>
</div>

<!-- Users Table -->
<div class="table-container">
    <table class="table">
        <thead>
            <tr>
                <th style="width: 120px;">UPN</th>
                <th>Nome</th>
                <th>Email</th>
                <th>Função</th>
                <th>País</th>
                <th>Telefone</th>
                <th style="width: 140px; text-align: center;">Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users.items %}
            <tr>
                <td><span class="badge badge-secondary">{{ user.upn }}</span></td>
                <td style="font-weight: 500;">{{ user.first_name }} {{ user.last_name }}</td>
                <td style="color: var(--color-gray-600);">{{ user.email }}</td>
                <td>{{ user.role or '-' }}</td>
                <td>{{ user.country or '-' }}</td>
                <td>{{ user.phone or '-' }}</td>
                <td>
                    <div style="display: flex; gap: 0.5rem; justify-content: center;">
                        <button class="btn btn-info btn-icon-sm" data-upn="{{ user.upn | urlencode }}" onclick="showViewDetails(decodeURIComponent(this.dataset.upn))" title="Visualizar">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-warning btn-icon-sm" data-upn="{{ user.upn | urlencode }}" onclick="showEditForm(decodeURIComponent(this.dataset.upn))" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-icon-sm" data-upn="{{ user.upn | urlencode }}" onclick="deleteUser(decodeURIComponent(this.dataset.upn))" title="Deletar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
{% if users.pages > 1 %}
<ul class="pagination">
    {% if users.has_prev %}
    <li class="pagination-item">
        <a class="pagination-link" href="{{ url_for('portal_users.list_and_create_users', page=users.prev_num) }}">
            <i class="fas fa-chevron-left"></i>
        </a>
    </li>
    {% endif %}

    {% for page_num in users.iter_pages() %}
        {% if page_num %}
            <li class="pagination-item {% if page_num == users.page %}active{% endif %}">
                <a class="pagination-link" href="{{ url_for('portal_users.list_and_create_users', page=page_num) }}">{{ page_num }}</a>
            </li>
        {% endif %}
    {% endfor %}

    {% if users.has_next %}
    <li class="pagination-item">
        <a class="pagination-link" href="{{ url_for('portal_users.list_and_create_users', page=users.next_num) }}">
            <i class="fas fa-chevron-right"></i>
        </a>
    </li>
    {% endif %}
</ul>
{% endif %}

<!-- View Modal -->
<div class="modal-backdrop" id="viewModalBackdrop" style="display: none;" onclick="closeViewModal()"></div>
<div class="modal" id="viewModal" style="display: none;">
    <div class="modal-dialog modal-dialog-xl">
        <div class="modal-header">
            <h3 class="modal-title">Detalhes do Usuário</h3>
            <button type="button" class="btn btn-icon-sm btn-outline" onclick="closeViewModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="viewContent">
            <!-- Content loaded via JavaScript -->
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeViewModal()">Fechar</button>
        </div>
    </div>
</div>

<!-- Create/Edit Modal -->
<div class="modal-backdrop" id="formModalBackdrop" style="display: none;" onclick="closeFormModal()"></div>
<div class="modal" id="formModal" style="display: none;">
    <div class="modal-dialog modal-dialog-lg">
        <div class="modal-header">
            <h3 class="modal-title" id="formTitle">Criar Novo Usuário</h3>
            <button type="button" class="btn btn-icon-sm btn-outline" onclick="closeFormModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <form id="userForm" method="POST">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <!-- Basic Info -->
                    <div class="form-group">
                        <label for="first_name" class="form-label">Nome <span style="color: var(--color-red-500);">*</span></label>
                        <input type="text" class="form-control" id="first_name" name="first_name" required>
                    </div>
                    <div class="form-group">
                        <label for="last_name" class="form-label">Sobrenome <span style="color: var(--color-red-500);">*</span></label>
                        <input type="text" class="form-control" id="last_name" name="last_name" required>
                    </div>
                    <div class="form-group">
                        <label for="user_name" class="form-label">Nome de Usuário <span style="color: var(--color-red-500);">*</span></label>
                        <input type="text" class="form-control" id="user_name" name="user_name" required>
                    </div>
                    <div class="form-group">
                        <label for="email" class="form-label">Email</label>
                        <input type="text" class="form-control" id="email" name="email">
                    </div>
                    <div class="form-group">
                        <label for="upn" class="form-label">UPN <span style="color: var(--color-red-500);">*</span></label>
                        <input type="text" class="form-control" id="upn" name="upn" required>
                    </div>
                    <div class="form-group">
                        <label for="phone" class="form-label">Telefone</label>
                        <input type="text" class="form-control" id="phone" name="phone">
                    </div>
                    <div class="form-group">
                        <label for="role" class="form-label">Função <span style="color: var(--color-red-500);">*</span></label>
                        <input type="text" class="form-control" id="role" name="role" required>
                    </div>
                    <div class="form-group">
                        <label for="reporting_manager" class="form-label">Gerente</label>
                        <input type="text" class="form-control" id="reporting_manager" name="reporting_manager">
                    </div>
                    <div class="form-group">
                        <label for="country" class="form-label">País</label>
                        <input type="text" class="form-control" id="country" name="country">
                    </div>
                    <div class="form-group">
                        <label for="responsible_country" class="form-label">País Responsável</label>
                        <input type="text" class="form-control" id="responsible_country" name="responsible_country">
                    </div>
                    <div class="form-group">
                        <label for="sales_organization" class="form-label">Org. Vendas</label>
                        <input type="text" class="form-control" id="sales_organization" name="sales_organization">
                    </div>
                    <div class="form-group">
                        <label for="sales_office" class="form-label">Escritório</label>
                        <input type="text" class="form-control" id="sales_office" name="sales_office">
                    </div>
                    <div class="form-group">
                        <label for="preferred_notification_type" class="form-label">Notificação</label>
                        <select class="form-control" id="preferred_notification_type" name="preferred_notification_type">
                            <option value="">Selecione...</option>
                            <option value="DnD">DnD</option>
                            <option value="Email">Email</option>
                            <option value="Text">Text</option>
                            <option value="Mobile Notification">Mobile Notification</option>
                        </select>
                    </div>
                </div>

                <!-- Collapsible Advanced Fields -->
                <div style="margin-top: 1.5rem;">
                    <button type="button" class="btn btn-outline btn-sm" onclick="toggleAdvancedFields()">
                        <i class="fas fa-chevron-down" id="advancedToggleIcon"></i>
                        <span>Campos Avançados</span>
                    </button>
                </div>

                <div id="advancedFields" style="display: none; margin-top: 1rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="sales_group" class="form-label">Grupo Vendas</label>
                            <input type="text" class="form-control" id="sales_group" name="sales_group">
                        </div>
                        <div class="form-group">
                            <label for="sales_territory" class="form-label">Território</label>
                            <input type="text" class="form-control" id="sales_territory" name="sales_territory">
                        </div>
                        <div class="form-group">
                            <label for="teleselling_territory" class="form-label">Território de Televendas</label>
                            <input type="text" class="form-control" id="teleselling_territory" name="teleselling_territory">
                        </div>
                        <div class="form-group">
                            <label for="bd_territory_name" class="form-label">BD</label>
                            <input type="text" class="form-control" id="bd_territory_name" name="bd_territory_name">
                        </div>
                        <div class="form-group">
                            <label for="ca_territory_name" class="form-label">CA</label>
                            <input type="text" class="form-control" id="ca_territory_name" name="ca_territory_name">
                        </div>
                        <div class="form-group">
                            <label for="mc_territory_name" class="form-label">MC</label>
                            <input type="text" class="form-control" id="mc_territory_name" name="mc_territory_name">
                        </div>
                        <div class="form-group">
                            <label for="p1_territory_name" class="form-label">P1</label>
                            <input type="text" class="form-control" id="p1_territory_name" name="p1_territory_name">
                        </div>
                        <div class="form-group">
                            <label for="p2_territory_name" class="form-label">P2</label>
                            <input type="text" class="form-control" id="p2_territory_name" name="p2_territory_name">
                        </div>
                        <div class="form-group">
                            <label for="p3_territory_name" class="form-label">P3</label>
                            <input type="text" class="form-control" id="p3_territory_name" name="p3_territory_name">
                        </div>
                        <div class="form-group">
                            <label for="p4_territory_name" class="form-label">P4</label>
                            <input type="text" class="form-control" id="p4_territory_name" name="p4_territory_name">
                        </div>
                        <div class="form-group">
                            <label for="p5_territory_name" class="form-label">P5</label>
                            <input type="text" class="form-control" id="p5_territory_name" name="p5_territory_name">
                        </div>
                        <div class="form-group">
                            <label for="ncb_territory_name" class="form-label">NCB</label>
                            <input type="text" class="form-control" id="ncb_territory_name" name="ncb_territory_name">
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeFormModal()">Cancelar</button>
            <button type="button" class="btn btn-primary" onclick="submitForm()">
                <i class="fas fa-save"></i>
                Salvar
            </button>
        </div>
    </div>
</div>

{% endif %}
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/form-validation.js') }}"></script>
<script>
// Setup live validation when form modal is shown
function showFormModalFunc() {
    document.getElementById('formModal').style.display = 'flex';
    document.getElementById('formModalBackdrop').style.display = 'block';
    document.body.style.overflow = 'hidden';
    
    // Setup live validation
    const form = document.getElementById('userForm');
    FormValidator.setupLiveValidation(form, 'users');
}

// State management
let searchState = {
    originalTableHTML: null,
    isSearching: false,
    searchTimeout: null
};

// Save original table for reset
window.addEventListener('DOMContentLoaded', () => {
    searchState.originalTableHTML = document.querySelector('table tbody').innerHTML;
});

// Modal Management
function showViewModal() {
    document.getElementById('viewModal').style.display = 'flex';
    document.getElementById('viewModalBackdrop').style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeViewModal() {
    document.getElementById('viewModal').style.display = 'none';
    document.getElementById('viewModalBackdrop').style.display = 'none';
    document.body.style.overflow = 'auto';
}

function showFormModalFunc() {
    document.getElementById('formModal').style.display = 'flex';
    document.getElementById('formModalBackdrop').style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeFormModal() {
    document.getElementById('formModal').style.display = 'none';
    document.getElementById('formModalBackdrop').style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Toggle Advanced Fields
function toggleAdvancedFields() {
    const fields = document.getElementById('advancedFields');
    const icon = document.getElementById('advancedToggleIcon');
    if (fields.style.display === 'none') {
        fields.style.display = 'block';
        icon.className = 'fas fa-chevron-up';
    } else {
        fields.style.display = 'none';
        icon.className = 'fas fa-chevron-down';
    }
}

// CRUD Operations
function showCreateForm() {
    document.getElementById('formTitle').textContent = 'Criar Novo Usuário';
    document.getElementById('userForm').reset();
    document.getElementById('userForm').action = '/portal_associacao/users/';
    document.getElementById('userForm').method = 'POST';
    document.getElementById('advancedFields').style.display = 'none';
    document.getElementById('advancedToggleIcon').className = 'fas fa-chevron-down';
    showFormModalFunc();
}

function showEditForm(userUpn) {
    const encodedUpn = encodeURIComponent(userUpn);
    fetch(`/portal_associacao/users/${encodedUpn}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('formTitle').textContent = 'Editar Usuário';

            const fields = ['first_name', 'last_name', 'user_name', 'email', 'upn', 'phone', 'role',
                          'reporting_manager', 'country', 'responsible_country', 'sales_organization',
                          'sales_office', 'sales_group', 'sales_territory', 'teleselling_territory',
                          'bd_territory_name', 'ca_territory_name', 'mc_territory_name', 'p1_territory_name',
                          'p2_territory_name', 'p3_territory_name', 'p4_territory_name', 'p5_territory_name',
                          'ncb_territory_name', 'preferred_notification_type', 'client'];

            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) element.value = data[field] || '';
            });

            document.getElementById('userForm').action = `/portal_associacao/users/${encodedUpn}`;
            document.getElementById('userForm').method = 'POST';
            showFormModalFunc();
        })
        .catch(error => {
            alert('Erro ao carregar dados do usuário.');
            console.error(error);
        });
}

function showViewDetails(userUpn) {
    const encodedUpn = encodeURIComponent(userUpn);
    fetch(`/portal_associacao/users/${encodedUpn}`)
        .then(response => response.json())
        .then(data => {
            const fields = [
                { label: 'UPN', value: data.upn },
                { label: 'Nome', value: data.first_name },
                { label: 'Sobrenome', value: data.last_name },
                { label: 'Usuário', value: data.user_name },
                { label: 'Email', value: data.email },
                { label: 'Telefone', value: data.phone },
                { label: 'Função', value: data.role },
                { label: 'Gerente', value: data.reporting_manager },
                { label: 'Tipo Notificação', value: data.preferred_notification_type },
                { label: 'País', value: data.country },
                { label: 'País Responsável', value: data.responsible_country },
                { label: 'Org. Vendas', value: data.sales_organization },
                { label: 'Escritório Vendas', value: data.sales_office },
                { label: 'Grupo Vendas', value: data.sales_group },
                { label: 'Território Vendas', value: data.sales_territory },
                { label: 'Território de Televendas', value: data.teleselling_territory },
                { label: 'Território BD', value: data.bd_territory_name },
                { label: 'Território CA', value: data.ca_territory_name },
                { label: 'Território MC', value: data.mc_territory_name },
                { label: 'Território P1', value: data.p1_territory_name },
                { label: 'Território P2', value: data.p2_territory_name },
                { label: 'Território P3', value: data.p3_territory_name },
                { label: 'Território P4', value: data.p4_territory_name },
                { label: 'Território P5', value: data.p5_territory_name },
                { label: 'Território NCB', value: data.ncb_territory_name },
                { label: 'Último Login', value: data.last_login_on ? new Date(data.last_login_on).toLocaleString('pt-BR') : null },
                // { label: 'Cliente', value: data.client },
                { label: 'Pontos Recompensa', value: data.reward_point },
                { label: 'Criado em', value: data.created_on ? new Date(data.created_on).toLocaleString('pt-BR') : null },
                { label: 'Criado por', value: data.created_by },
                { label: 'Modificado em', value: data.modified_on ? new Date(data.modified_on).toLocaleString('pt-BR') : null },
                { label: 'Modificado por', value: data.modified_by }
            ];

            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem;">';
            fields.forEach(field => {
                html += `
                    <div>
                        <div style="font-size: 0.75rem; font-weight: 600; color: var(--color-gray-500); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem;">${field.label}</div>
                        <div style="font-size: 0.9375rem; color: var(--color-gray-900);">${field.value || '-'}</div>
                    </div>
                `;
            });
            html += '</div>';

            document.getElementById('viewContent').innerHTML = html;
            showViewModal();
        })
        .catch(error => {
            alert('Erro ao carregar detalhes do usuário.');
            console.error(error);
        });
}
function submitForm() {
    const form = document.getElementById('userForm');
    
    // Validar usando o novo FormValidator (preserva dados do formulário)
    if (!FormValidator.validate('users', form)) {
        return;
    }
    
    const action = form.action;
    const lastSegment = action.split('/').pop();
    const userIdentifier = lastSegment ? decodeURIComponent(lastSegment) : '';

    if (action.includes('/portal_associacao/users/') && userIdentifier && userIdentifier !== 'users') {
        updateUser(userIdentifier);
    } else {
        createUser();
    }
}

function createUser() {
    const form = document.getElementById('userForm');
    form.action = '/portal_associacao/users';
    form.method = 'POST';
    form.submit();
}

function updateUser(userUpn) {
    const form = document.getElementById('userForm');
    const encodedUpn = encodeURIComponent(userUpn);

    let methodInput = form.querySelector('input[name="_method"]');
    if (!methodInput) {
        methodInput = document.createElement('input');
        methodInput.type = 'hidden';
        methodInput.name = '_method';
        form.appendChild(methodInput);
    }
    methodInput.value = 'PUT';

    form.action = `/portal_associacao/users/${encodedUpn}`;
    form.method = 'POST';
    form.submit();
}

function deleteUser(userUpn) {
    if (confirm('Tem certeza que deseja deletar este usuário?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/portal_associacao/users/${encodeURIComponent(userUpn)}`;

        const methodInput = document.createElement('input');
        methodInput.type = 'hidden';
        methodInput.name = '_method';
        methodInput.value = 'DELETE';
        form.appendChild(methodInput);

        document.body.appendChild(form);
        form.submit();
    }
}

// Optimized Search Function
function performSearch(query) {
    if (!query || query.length < 2) {
        resetSearch();
        return;
    }

    searchState.isSearching = true;
    document.getElementById('searchIndicator').style.display = 'block';

    fetch(`/portal_associacao/users/search?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            const tbody = document.querySelector('table tbody');

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--color-gray-500);">Nenhum usuário encontrado.</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(user => {
                const encodedUpn = encodeURIComponent(user.upn || '');
                return `
                    <tr>
                        <td><span class="badge badge-secondary">${user.upn || '-'}</span></td>
                        <td style="font-weight: 500;">${escapeHtml(user.first_name)} ${escapeHtml(user.last_name)}</td>
                        <td style="color: var(--color-gray-600);">${escapeHtml(user.email)}</td>
                        <td>${escapeHtml(user.role || '-')}</td>
                        <td>${escapeHtml(user.country || '-')}</td>
                        <td>${escapeHtml(user.phone || '-')}</td>
                        <td>
                            <div style="display: flex; gap: 0.5rem; justify-content: center;">
                                <button class="btn btn-info btn-icon-sm" data-upn="${encodedUpn}" onclick="showViewDetails(decodeURIComponent(this.dataset.upn))" title="Visualizar">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-warning btn-icon-sm" data-upn="${encodedUpn}" onclick="showEditForm(decodeURIComponent(this.dataset.upn))" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger btn-icon-sm" data-upn="${encodedUpn}" onclick="deleteUser(decodeURIComponent(this.dataset.upn))" title="Deletar">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        })
        .catch(error => {
            console.error('Erro na busca:', error);
            document.querySelector('table tbody').innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--color-red-500);">Erro ao buscar usuários.</td></tr>';
        })
        .finally(() => {
            searchState.isSearching = false;
            document.getElementById('searchIndicator').style.display = 'none';
        });
}

// Reset to original table
function resetSearch() {
    if (searchState.originalTableHTML) {
        document.querySelector('table tbody').innerHTML = searchState.originalTableHTML;
    }
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

// Attach debounced search listener
document.getElementById('searchBar')?.addEventListener('input', (e) => {
    const query = e.target.value.trim();

    clearTimeout(searchState.searchTimeout);

    if (!query) {
        resetSearch();
        return;
    }

    searchState.searchTimeout = setTimeout(() => {
        performSearch(query);
    }, 400);
});
</script>
{% endblock %}
