{% extends 'portal/base.html' %}

{% block title %}Operação - Inventário{% endblock %}

{% block page_title %}Operação (Inventário){% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<style>
    /* Tamanho fixo para o mapa sem interferir nos demais cards */
    #operation-map {
        height: 360px;
        border-radius: var(--radius-md, 12px);
        overflow: hidden;
        background: #f7f9fc;
    }

    .map-wrapper {
        position: relative;
    }

    .map-legend {
        position: absolute;
        right: 12px;
        top: 12px;
        background: rgba(12, 20, 36, 0.88);
        color: #f4f7ff;
        padding: 10px 12px;
        border-radius: 10px;
        box-shadow: var(--shadow-md, 0 4px 16px rgba(0, 0, 0, 0.18));
        font-size: 12px;
        max-width: 260px;
        max-height: 180px;
        overflow-y: auto;
        border: 1px solid rgba(255, 255, 255, 0.12);
        z-index: 500;
        pointer-events: auto;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 6px;
    }

    .legend-swatch {
        width: 12px;
        height: 12px;
        border-radius: 4px;
        flex-shrink: 0;
        border: 1px solid rgba(255, 255, 255, 0.35);
    }

    .legend-swatch.current {
        border-radius: 50%;
        background: radial-gradient(circle at 50% 50%, #fff 0%, #00c3ff 55%, #00c3ff 100%);
        border: 1px solid #fff;
    }

    .legend-swatch.asset {
        width: 0;
        height: 0;
        border-left: 7px solid transparent;
        border-right: 7px solid transparent;
        border-bottom: 10px solid var(--color, #00c3ff);
        border-radius: 0;
    }

    .current-location-icon {
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: radial-gradient(circle at 50% 50%, #ffffff 0%, #ffffff 35%, #00c3ff 65%, #0075ff 100%);
        border: 2px solid #ffffff;
        box-shadow: 0 0 14px rgba(0, 195, 255, 0.9);
    }

    .asset-marker-icon {
        width: 0;
        height: 0;
        border-left: 9px solid transparent;
        border-right: 9px solid transparent;
        border-bottom: 14px solid var(--color, #00c3ff);
        filter: drop-shadow(0 0 4px rgba(0, 0, 0, 0.25));
        transform: translateY(-2px);
    }

    .asset-marker-wrapper {
        width: 18px;
        height: 18px;
    }

    #operation-map .map-status {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #6c757d;
        font-size: 14px;
    }

    /* Centraliza o botão de ação logo abaixo do mapa */
    .operation-actions {
        margin-top: 1rem;
        display: flex;
        justify-content: center;
    }

    /* Modais alinhados com a paleta do portal */
    .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(10, 31, 68, 0.55);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        padding: 16px;
    }

    .modal-backdrop.active {
        display: flex;
    }

    .modal-card {
        background: linear-gradient(160deg, #0c1424 0%, #0c1424 45%, #10203c 100%);
        color: #f4f7ff;
        border-radius: 14px;
        padding: 20px;
        width: 100%;
        max-width: 540px;
        box-shadow: var(--shadow-lg, 0 8px 32px rgba(0, 195, 255, 0.18));
        border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
        gap: 12px;
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.06);
        border-radius: 12px;
    }

    .modal-header h4 {
        margin: 0;
        font-size: 18px;
        font-weight: 700;
    }

    .modal-close {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: rgba(0, 0, 0, 0.32);
        color: #f4f7ff;
        border: 1px solid rgba(255, 255, 255, 0.16);
        border-radius: 10px;
        font-weight: 600;
        transition: background var(--transition-base, 0.2s ease), border-color var(--transition-base, 0.2s ease);
    }

    .modal-close:hover {
        background: rgba(0, 0, 0, 0.5);
        border-color: rgba(255, 255, 255, 0.26);
    }

    .modal-body {
        max-height: 70vh;
        overflow-y: auto;
    }

    .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 16px;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 12px;
    }

    .form-grid label {
        font-weight: 600;
        font-size: 14px;
    }

    .form-grid input,
    .form-grid textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(12, 20, 36, 0.75);
        color: #f4f7ff;
        border-radius: 10px;
        font-size: 14px;
    }

    .form-grid input:focus,
    .form-grid textarea:focus {
        outline: 2px solid var(--primary, #00c3ff);
        border-color: var(--primary, #00c3ff);
        background: rgba(15, 26, 45, 0.95);
    }

    .form-grid textarea {
        min-height: 80px;
    }

    #qr-reader {
        width: 100%;
        min-height: 320px;
        background: rgba(0, 0, 0, 0.35);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .pill-option {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 12px 16px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        cursor: pointer;
        gap: 10px;
        width: 100%;
        background: rgba(14, 22, 38, 0.9);
        color: #f4f7ff;
        font-weight: 600;
        transition: background var(--transition-base, 0.2s ease), transform 120ms ease;
    }

    .method-divider {
        text-align: center;
        color: #c6cedd;
        margin: 8px 0;
        font-weight: 600;
        letter-spacing: 0.02em;
    }

    .pill-option:hover {
        background: rgba(0, 195, 255, 0.16);
        transform: translateY(-1px);
    }

    .status-text {
        font-size: 13px;
        color: #d0d7e3;
        margin-top: 6px;
    }

    .location-status {
        margin-top: 8px;
    }

    /* Mini cards (assets mais antigos) */
    .stale-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 240px));
        gap: 12px;
        justify-content: center;
    }

    .stale-card {
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        padding: 12px;
        background: rgba(12, 20, 36, 0.75);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        color: #eef2fb;
        min-width: 210px;
        max-width: 260px;
        font-size: 14px;
        word-break: break-word;
    }

    .stale-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        gap: 8px;
    }

    .stale-serial {
        font-weight: 700;
        font-size: 16px;
        line-height: 1.2;
        max-width: 70%;
        word-break: break-word;
    }

    .stale-outlet {
        padding: 4px 8px;
        border-radius: 10px;
        background: rgba(0, 195, 255, 0.14);
        border: 1px solid rgba(0, 195, 255, 0.3);
        font-size: 12px;
        color: #9be7ff;
        max-width: 90px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .stale-meta {
        display: flex;
        gap: 4px;
        font-size: 13px;
        color: #cfd6e6;
        margin-bottom: 4px;
    }

    .stale-meta .label {
        opacity: 0.75;
        min-width: 100px;
    }

    .toast {
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        background: rgba(12, 20, 36, 0.95);
        color: #f4f7ff;
        padding: 16px 18px;
        border-radius: 12px;
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.35);
        border: 1px solid rgba(0, 195, 255, 0.35);
        min-width: 280px;
        z-index: 12000;
        display: none;
        text-align: center;
    }

    .toast.show {
        display: block;
        animation: fadeInUp 200ms ease;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translate(-50%, -46%);
        }

        to {
            opacity: 1;
            transform: translate(-50%, -50%);
        }
    }

    .btn-light {
        background: rgba(255, 255, 255, 0.12);
        color: #f4f7ff;
        border: 1px solid rgba(0, 0, 0, 0.25);
    }

    .btn-light:hover {
        background: rgba(255, 255, 255, 0.22);
        color: #fff;
    }

    .operation-actions {
        margin-top: 12px;
        flex-direction: column;
        gap: 16px;
    }

    .filter-control {
        display: flex;
        flex-direction: column;
        gap: 4px;
        min-width: 180px;
    }

    .filter-card {
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.04), rgba(0, 0, 0, 0.15));
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        padding: 14px 14px 16px;
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.25);
    }

    .filter-card-header {
        display: flex;
        justify-content: flex-start;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 12px;
    }

    .filter-card-header h4 {
        margin: 0;
        font-size: 16px;
        color: #e8f0ff;
    }

    .filter-card-header p {
        margin: 2px 0 0;
        color: #b9c6df;
        font-size: 13px;
    }

    .filter-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
    }

    .filter-actions {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
        margin-top: 6px;
    }

    .filter-actions .btn {
        width: 100%;
    }

    @media (min-width: 640px) {
        .filter-grid {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
    }

    @media (min-width: 960px) {
        .filter-grid {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }
    }

    .filter-control label {
        font-weight: 600;
        font-size: 13px;
    }

    .filter-control select,
    .filter-control input {
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid rgba(0, 0, 0, 0.18);
        background: #f5f8ff;
        font-size: 14px;
    }

    .filter-control small {
        color: #6c7a93;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h2>Operações do Inventário</h2>
    <p>Atualize e adicione localização dos seus ativos.</p>

    <div class="card" style="margin-top: 1rem;">
        <div class="card-header">
            <strong>Mapa de Operações</strong>
        </div>
        <div class="card-body map-wrapper" style="padding: 0;">
            <div id="operation-map"></div>
            <div id="map-legend" class="map-legend"></div>
        </div>
    </div>

    <div class="status-text" id="location-status"></div>

    <div class="filter-card">
        <div class="filter-card-header">
            <div>
                <h4>Filtros rápidos</h4>
                <p>Refine o mapa antes de escanear</p>
            </div>
        </div>
        <div class="filter-grid">
            <div class="filter-control">
                <label for="filter-outlet">Outlet</label>
                <select id="filter-outlet">
                    <option value="all">Todos</option>
                </select>
            </div>
            <div class="filter-control">
                <label for="filter-radius">Raio (km)</label>
                <input type="number" min="0" step="0.1" id="filter-radius" placeholder="ex: 5">
                <small>Use 0 para desativar raio.</small>
            </div>
            <div class="filter-control">
                <label for="filter-order">Ordenar</label>
                <select id="filter-order">
                    <option value="oldest">Mais desatualizados</option>
                    <option value="newest">Mais atualizados</option>
                </select>
            </div>
        </div>
        <div class="filter-actions">
            <button type="button" class="btn btn-primary" id="open-scan-btn">Scan</button>
        </div>
    </div>

    <div class="toast" id="scan-toast"></div>

    <div class="card" style="margin-top: 1.25rem;">
        <div class="card-header">
            <strong>Assets</strong>
        </div>
        <div class="card-body" style="padding: 12px;">
            {% if stale_assets %}
            <div class="stale-grid" id="stale-grid" style="margin: 0; width: 100%;">
                {% for asset in stale_assets %}
                <div class="stale-card">
                    <div class="stale-header">
                        <div class="stale-serial">{{ asset.serial_number }}</div>
                        <div class="stale-outlet">{{ asset.outlet_name or 'Sem outlet' }}</div>
                    </div>
                    <div class="stale-meta">
                        <span class="label">Última visita:</span>
                        <span class="value">{{ asset.last_visit_at or 'Sem registro' }}</span>
                    </div>
                    <div class="stale-meta">
                        <span class="label">Lat/Lng:</span>
                        <span class="value">{{ asset.last_latitude or '-' }}, {{ asset.last_longitude or '-' }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div style="padding: 8px;">Nenhuma visita registrada ainda.</div>
            {% endif %}
        </div>
    </div>

    <!-- Modal: Escolher método -->
    <div class="modal-backdrop" id="method-modal">
        <div class="modal-card">
            <div class="modal-header">
                <h4>Adicionar asset</h4>
                <button type="button" class="modal-close" data-close-modal="method-modal"><i class="fas fa-times"></i>
                    Fechar</button>
            </div>
            <div class="modal-body">
                <div class="form-grid">
                    <button type="button" class="pill-option" id="choose-qr" style="grid-column: 1 / -1;">
                        <i class="fas fa-qrcode"></i> Scanear QR Code
                    </button>
                    <div class="method-divider" style="grid-column: 1 / -1;">ou</div>
                    <div style="grid-column: 1 / -1;">
                        <label for="method-serial">Serial Number *</label>
                        <input id="method-serial" placeholder="Informe o serial" />
                    </div>
                    <button type="button" class="pill-option" id="choose-manual" style="grid-column: 1 / -1;">
                        <i class="fas fa-keyboard"></i> Inserir manualmente
                    </button>
                </div>
                <div class="status-text" id="method-status"></div>
            </div>
        </div>
    </div>

    <!-- Modal: QR Scanner -->
    <div class="modal-backdrop" id="qr-modal">
        <div class="modal-card">
            <div class="modal-header">
                <h4>Scanear QR Code</h4>
                <button type="button" class="modal-close" data-close-modal="qr-modal"><i class="fas fa-times"></i>
                    Fechar</button>
            </div>
            <div class="modal-body">
                <div id="qr-reader"></div>
                <div class="qr-zoom-controls" style="margin-top: 12px; display: none;">
                    <label for="qr-zoom-slider" style="display: block; font-size: 0.85rem; margin-bottom: 4px;">
                        Zoom da câmera (se suportado)
                    </label>
                    <input id="qr-zoom-slider" type="range" min="1" max="3" step="0.1" value="1"
                           style="width: 100%;">
                </div>
                <p class="status-text">Aponte a câmera para o QR Code. Mantenha o código centralizado, aproxime se necessário e garanta boa iluminação. Após ler, os dados serão preenchidos
                    automaticamente.</p>
            </div>
        </div>
    </div>

    <!-- Modal: Formulário -->
    <div class="modal-backdrop" id="form-modal">
        <div class="modal-card">
            <div class="modal-header">
                <h4>Cadastro de Asset</h4>
                <button type="button" class="modal-close" data-close-modal="form-modal"><i class="fas fa-times"></i>
                    Fechar</button>
            </div>
            <form id="inventory-form">
                <div class="modal-body">
                    <div class="form-grid">
                        <div>
                            <label for="serial_number">Serial Number *</label>
                            <input id="serial_number" name="serial_number" required />
                        </div>
                        <div>
                            <label for="asset_type">Tipo</label>
                            <input id="asset_type" name="asset_type" />
                        </div>
                        <div>
                            <label for="material">Material</label>
                            <input id="material" name="material" />
                        </div>
                        <div>
                            <label for="outlet_name">Ponto/Outlet</label>
                            <input id="outlet_name" name="outlet_name" />
                        </div>
                        <div>
                            <label for="street">Rua *</label>
                            <input id="street" name="street" required />
                        </div>
                        <div>
                            <label for="city">Cidade *</label>
                            <input id="city" name="city" required />
                        </div>
                        <div>
                            <label for="last_latitude">Latitude</label>
                            <input id="last_latitude" name="last_latitude" />
                        </div>
                        <div>
                            <label for="last_longitude">Longitude</label>
                            <input id="last_longitude" name="last_longitude" />
                        </div>
                        <div style="grid-column: 1 / -1;">
                            <label for="notes">Notas</label>
                            <textarea id="notes" name="notes"></textarea>
                        </div>
                    </div>
                    <div class="status-text" id="form-status"></div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-light" data-close-modal="form-modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const mapContainer = document.getElementById('operation-map');
        const assetsData = {{ operation_assets | default ([]) | tojson
    }};
    let staleAssetsData = {{ stale_assets | default ([]) | tojson }};
    if (!staleAssetsData.length) staleAssetsData = [...assetsData];
        let map;
        let markers = [];
        const markersBySerial = {};
        let clusterGroup = null;
        let qrScanner = null;
        let mapStatusEl = null;

    const formModal = document.getElementById('form-modal');
    const methodModal = document.getElementById('method-modal');
    const qrModal = document.getElementById('qr-modal');
    const openScanBtn = document.getElementById('open-scan-btn');
    const formElement = document.getElementById('inventory-form');
    const statusText = document.getElementById('form-status');
    const locationStatus = document.getElementById('location-status');
    const serialInput = document.getElementById('method-serial');
    const methodStatus = document.getElementById('method-status');

    const fieldSerial = document.getElementById('serial_number');
    const fieldType = document.getElementById('asset_type');
    const fieldMaterial = document.getElementById('material');
    const fieldOutlet = document.getElementById('outlet_name');
    const fieldStreet = document.getElementById('street');
    const fieldCity = document.getElementById('city');
    const fieldLat = document.getElementById('last_latitude');
    const fieldLng = document.getElementById('last_longitude');
    const fieldNotes = document.getElementById('notes');
    let currentLocationMarker = null;
    let userLat = null;
    let userLng = null;
    let geoWatchId = null;
    const outletColorMap = {};
    const outletColorPalette = ['#00C3FF', '#4C3AFF', '#FFC93C', '#00F5B5', '#FF6B6B', '#1F8EF1', '#7C4DFF', '#FF8A65'];
    const legendContainer = document.getElementById('map-legend');
    const currentIcon = L.divIcon({ className: 'current-location-icon' });
    const toastEl = document.getElementById('scan-toast');
    const staleGridEl = document.getElementById('stale-grid');
    const qrInfoText = document.querySelector('#qr-modal .status-text');
    const defaultQrMessage = 'Aponte a câmera para o QR Code. Após ler, os dados serão preenchidos automaticamente.';
    const filterOutlet = document.getElementById('filter-outlet');
    const filterRadius = document.getElementById('filter-radius');
    const filterOrder = document.getElementById('filter-order');

    function setModal(modal, isOpen) {
        if (!modal) return;
        if (isOpen) modal.classList.add('active');
        else modal.classList.remove('active');
    }

    function fillLocationFields(prefill = {}) {
        const latValue = prefill.last_latitude ?? userLat;
        const lngValue = prefill.last_longitude ?? userLng;
        if (fieldLat && latValue !== null && latValue !== undefined) fieldLat.value = latValue;
        if (fieldLng && lngValue !== null && lngValue !== undefined) fieldLng.value = lngValue;
    }

    function resetForm() {
        formElement.reset();
        statusText.textContent = '';
        fillLocationFields();
    }

    function isSecureForCamera() {
        if (window.isSecureContext) return true;
        const host = window.location.hostname;
        return host === 'localhost' || host === '127.0.0.1';
    }

    function computeQrBoxSize(el) {
        const width = el?.clientWidth || window.innerWidth || 320;
        // Aumenta um pouco a área real de leitura para facilitar QR menores/mais distantes
        return Math.max(200, Math.min(380, Math.floor(width * 0.85)));
    }

    function loadScriptIfNeeded(checkFn, primaryUrl, fallbackUrl) {
            return new Promise((resolve) => {
                if (checkFn()) return resolve(true);
                const script = document.createElement('script');
                script.src = primaryUrl;
                script.onload = () => resolve(true);
            script.onerror = () => {
                if (!fallbackUrl) return resolve(false);
                const fallback = document.createElement('script');
                fallback.src = fallbackUrl;
                fallback.onload = () => resolve(true);
                fallback.onerror = () => resolve(false);
                document.body.appendChild(fallback);
            };
            document.body.appendChild(script);
        });
    }

        async function initMap() {
            const leafletLoaded = await loadScriptIfNeeded(
                () => window.L,
                'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js',
                'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js'
            );

            if (!leafletLoaded || !window.L) {
                mapContainer.innerHTML = '<div class="map-status">Não foi possível carregar o mapa (biblioteca não carregada).</div>';
                return;
            }

            const clusterLoaded = await loadScriptIfNeeded(
                () => window.L && !!L.MarkerClusterGroup,
                'https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js',
                'https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js'
            );

            if (!clusterLoaded || !L.MarkerClusterGroup) {
                mapContainer.innerHTML = '<div class="map-status">Não foi possível carregar o mapa (cluster não carregado).</div>';
                return;
            }

            map = L.map('operation-map').setView([-15.7801, -47.9292], 4);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            clusterGroup = L.markerClusterGroup({
                showCoverageOnHover: false,
                zoomToBoundsOnClick: false,
                spiderfyOnMaxZoom: true,
                spiderfyOnEveryZoom: true,
                spiderfyDistanceMultiplier: 1.6,
                disableClusteringAtZoom: null
            });
            clusterGroup.on('clusterclick', (e) => {
                // Ao clicar em clusters, sempre abra o spiderfy para ver todos os pontos sobrepostos
                e.layer.spiderfy();
            });
            map.addLayer(clusterGroup);

            // Após inicializar o mapa, tente capturar localização atual
            requestCurrentLocation();
            applyFilters();
        }

        function addAssetMarker(asset, { skipFit = false } = {}) {
            if (!map || !clusterGroup) return;
            const lat = parseFloat(asset.last_latitude);
            const lng = parseFloat(asset.last_longitude);
            if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;

        const title = asset.serial_number || 'Asset sem serial';
        const popupLines = [
            `<strong>${title}</strong>`,
            asset.asset_type ? `Tipo: ${asset.asset_type}` : null,
            asset.outlet_name ? `Ponto: ${asset.outlet_name}` : null,
            asset.city || asset.street ? `${asset.street || ''} ${asset.city || ''}`.trim() : null
        ].filter(Boolean);

        const outletKey = (asset.outlet_name || 'Sem outlet').trim() || 'Sem outlet';
        const color = getOutletColor(outletKey);

        const markerKey = asset.serial_number || `${lat},${lng}`;
        if (markersBySerial[markerKey]) {
            map.removeLayer(markersBySerial[markerKey]);
            markers = markers.filter(m => m !== markersBySerial[markerKey]);
        }

            const marker = L.marker([lat, lng], { icon: createAssetIcon(color) }).bindPopup(popupLines.join('<br>'));
            clusterGroup.addLayer(marker);
            markers.push(marker);
            markersBySerial[markerKey] = marker;
            if (!skipFit) {
                map.fitBounds(clusterGroup.getBounds(), { padding: [24, 24] });
            }
        }

    function upsertAssetData(asset) {
        const idx = assetsData.findIndex((a) => a.serial_number === asset.serial_number);
        if (idx >= 0) assetsData[idx] = asset;
        else assetsData.push(asset);
    }

    function upsertStaleAsset(asset) {
        if (!asset.serial_number) return;
        const idx = staleAssetsData.findIndex(a => a.serial_number === asset.serial_number);
        if (idx >= 0) staleAssetsData[idx] = asset;
        else staleAssetsData.unshift(asset);
        // Ordena por last_visit_at (mais antigo primeiro)
        staleAssetsData.sort((a, b) => {
            const ta = a.last_visit_at ? Date.parse(a.last_visit_at) : 0;
            const tb = b.last_visit_at ? Date.parse(b.last_visit_at) : 0;
            return ta - tb;
        });
        renderStaleGrid();
    }

    function formatLocalDate(isoString) {
        if (!isoString) return null;
        const d = new Date(isoString);
        if (Number.isNaN(d.getTime())) return isoString;
        return d.toLocaleString(undefined, {
            timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,
            hour12: false
        });
    }

    function renderStaleGrid(list = staleAssetsData) {
        if (!staleGridEl) return;
        staleGridEl.innerHTML = '';
        (list || []).slice(0, 10).forEach(asset => {
            const card = document.createElement('div');
            card.className = 'stale-card';

            const header = document.createElement('div');
            header.className = 'stale-header';
            const serialDiv = document.createElement('div');
            serialDiv.className = 'stale-serial';
            serialDiv.textContent = asset.serial_number;
            const outletDiv = document.createElement('div');
            outletDiv.className = 'stale-outlet';
            outletDiv.textContent = asset.outlet_name || 'Sem outlet';
            header.appendChild(serialDiv);
            header.appendChild(outletDiv);

            const meta1 = document.createElement('div');
            meta1.className = 'stale-meta';
            const lbl1 = document.createElement('span'); lbl1.className = 'label'; lbl1.textContent = 'Última visita:';
            const val1 = document.createElement('span'); val1.className = 'value'; val1.textContent = formatLocalDate(asset.last_visit_at) || 'Sem registro';
            meta1.appendChild(lbl1); meta1.appendChild(val1);

            const meta2 = document.createElement('div');
            meta2.className = 'stale-meta';
            const lbl2 = document.createElement('span'); lbl2.className = 'label'; lbl2.textContent = 'Lat/Lng:';
            const val2 = document.createElement('span'); val2.className = 'value'; val2.textContent = `${asset.last_latitude || '-'}, ${asset.last_longitude || '-'}`;
            meta2.appendChild(lbl2); meta2.appendChild(val2);

            card.appendChild(header);
            card.appendChild(meta1);
            card.appendChild(meta2);
            staleGridEl.appendChild(card);
        });
    }

    function buildOutletOptions() {
        if (!filterOutlet) return;
        const currentValue = filterOutlet.value;
        const outlets = new Set();
        assetsData.forEach(asset => {
            const key = (asset.outlet_name || 'Sem outlet').trim() || 'Sem outlet';
            outlets.add(key);
        });
        filterOutlet.innerHTML = '<option value="all">Todos</option>';
        Array.from(outlets).sort().forEach(outlet => {
            const opt = document.createElement('option');
            opt.value = outlet;
            opt.textContent = outlet;
            filterOutlet.appendChild(opt);
        });
        if (currentValue && [...filterOutlet.options].some(o => o.value === currentValue)) {
            filterOutlet.value = currentValue;
        }
    }

    function computeDistanceKm(lat1, lon1, lat2, lon2) {
        if (![lat1, lon1, lat2, lon2].every(Number.isFinite)) return null;
        const R = 6371; // km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    function sortAssets(list, order = 'oldest') {
        const copy = [...list];
        copy.sort((a, b) => {
            const ta = a.last_visit_at ? Date.parse(a.last_visit_at) : 0;
            const tb = b.last_visit_at ? Date.parse(b.last_visit_at) : 0;
            if (order === 'newest') return tb - ta;
            return ta - tb;
        });
        return copy;
    }

        function renderMarkers(assetList) {
            if (!map || !clusterGroup) return;
            // limpa somente assets (mantém localização atual)
            clusterGroup.clearLayers();
            markers = [];
            Object.keys(markersBySerial).forEach(key => {
                delete markersBySerial[key];
            });
            Object.keys(outletColorMap).forEach(key => delete outletColorMap[key]);

        if (!mapStatusEl) {
            mapStatusEl = document.createElement('div');
            mapStatusEl.className = 'map-status';
            mapContainer.appendChild(mapStatusEl);
        }

        if (!assetList || !assetList.length) {
            mapStatusEl.innerText = 'Nenhum asset para exibir com os filtros atuais.';
            mapStatusEl.style.display = 'flex';
            updateLegend();
            return;
        } else {
            mapStatusEl.style.display = 'none';
        }

            assetList.forEach(asset => addAssetMarker(asset, { skipFit: true }));
            if (markers.length) {
                map.fitBounds(clusterGroup.getBounds(), { padding: [24, 24] });
            }
            updateLegend();
        }

    function applyFilters() {
        const outletVal = filterOutlet?.value || 'all';
        const orderVal = filterOrder?.value || 'oldest';
        const radiusVal = parseFloat(filterRadius?.value);
        const radiusEnabled = Number.isFinite(radiusVal) && radiusVal > 0;
        const canUseRadius = radiusEnabled && userLat !== null && userLng !== null;

        if (radiusEnabled && !canUseRadius && locationStatus) {
            locationStatus.textContent = 'Ative ou permita a localização para filtrar por raio.';
        }

        const filtered = assetsData.filter(asset => {
            const outletKey = (asset.outlet_name || 'Sem outlet').trim() || 'Sem outlet';
            if (outletVal !== 'all' && outletKey !== outletVal) return false;

            if (radiusEnabled && canUseRadius) {
                const lat = parseFloat(asset.last_latitude);
                const lng = parseFloat(asset.last_longitude);
                const dist = computeDistanceKm(userLat, userLng, lat, lng);
                if (dist === null || dist > radiusVal) return false;
            }

            return true;
        });

        const ordered = sortAssets(filtered, orderVal);
        renderMarkers(ordered);
        renderStaleGrid(ordered);
    }

    function createAssetIcon(color) {
        const html = `<div class="asset-marker-wrapper"><div class="asset-marker-icon" style="--color:${color};"></div></div>`;
        return L.divIcon({
            className: 'asset-marker-container',
            html,
            iconSize: [18, 18],
            iconAnchor: [9, 12],
            popupAnchor: [0, -10]
        });
    }

    function getOutletColor(outlet) {
        if (outletColorMap[outlet]) return outletColorMap[outlet];
        const idx = Object.keys(outletColorMap).length % outletColorPalette.length;
        outletColorMap[outlet] = outletColorPalette[idx];
        return outletColorMap[outlet];
    }

    function updateLegend() {
        if (!legendContainer) return;
        legendContainer.innerHTML = '<strong>Mapa</strong><div style="height: 6px"></div>';

        // Localização atual
        const meItem = document.createElement('div');
        meItem.className = 'legend-item';
        const meSwatch = document.createElement('div');
        meSwatch.className = 'legend-swatch current';
        const meLabel = document.createElement('span');
        meLabel.textContent = 'Sua localização';
        meItem.appendChild(meSwatch);
        meItem.appendChild(meLabel);
        legendContainer.appendChild(meItem);

        const divider = document.createElement('div');
        divider.style.height = '6px';
        legendContainer.appendChild(divider);
        const title = document.createElement('div');
        title.style.marginBottom = '4px';
        title.textContent = 'Outlets';
        legendContainer.appendChild(title);

        Object.keys(outletColorMap).forEach(outlet => {
            const item = document.createElement('div');
            item.className = 'legend-item';
            const swatch = document.createElement('div');
            swatch.className = 'legend-swatch asset';
            swatch.style.setProperty('--color', outletColorMap[outlet]);
            const label = document.createElement('span');
            label.textContent = outlet;
            item.appendChild(swatch);
            item.appendChild(label);
            legendContainer.appendChild(item);
        });
    }

    function setCurrentLocation(lat, lng) {
        userLat = lat;
        userLng = lng;
        if (fieldLat) fieldLat.value = lat;
        if (fieldLng) fieldLng.value = lng;

        if (!map || !window.L) return;

        if (currentLocationMarker) {
            map.removeLayer(currentLocationMarker);
        }

        currentLocationMarker = L.marker([lat, lng], { icon: currentIcon }).addTo(map).bindPopup('Sua localização atual');

        map.panTo([lat, lng]);
        const radiusVal = parseFloat(filterRadius?.value);
        if (Number.isFinite(radiusVal) && radiusVal > 0) applyFilters();
    }

    function requestCurrentLocation() {
        if (!navigator.geolocation) {
            if (locationStatus) locationStatus.textContent = 'Geolocalização não suportada neste dispositivo.';
            return;
        }

        if (locationStatus) locationStatus.textContent = 'Obtendo sua localização...';

        const opts = {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 0
        };

        const onSuccess = (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            setCurrentLocation(lat, lng);
            if (locationStatus) locationStatus.textContent = 'Localização obtida.';
            if (geoWatchId !== null) navigator.geolocation.clearWatch(geoWatchId);
            geoWatchId = null;
        };

        const onError = (err) => {
            console.warn('Geolocation error', err);
            if (locationStatus) locationStatus.textContent = 'Não foi possível obter a localização.';
            if (geoWatchId !== null) navigator.geolocation.clearWatch(geoWatchId);
            geoWatchId = null;
        };

        geoWatchId = navigator.geolocation.watchPosition(onSuccess, onError, opts);
    }

    function parseQrText(rawText) {
        const data = {};
        const cleaned = rawText.replace(/^Raw text:\s*/i, '').trim();
        cleaned.split(/\r?\n/).forEach(line => {
            const [key, ...rest] = line.split(':');
            if (!key || !rest.length) return;
            const value = rest.join(':').trim();
            const normalized = key.trim().toLowerCase();
            if (normalized === 'type') data.asset_type = value;
            if (normalized === 'material') data.material = value;
            if (normalized === 'sn') data.serial_number = value;
        });
        if (!data.serial_number && !data.asset_type && !data.material && cleaned) {
            // fallback: assume texto inteiro é o serial
            data.serial_number = cleaned;
        }
        return data;
    }

    function openForm(prefill = {}) {
        resetForm();
        if (prefill.serial_number) fieldSerial.value = prefill.serial_number;
        if (prefill.asset_type) fieldType.value = prefill.asset_type;
        if (prefill.material) fieldMaterial.value = prefill.material;
        fillLocationFields(prefill);
        setModal(formModal, true);
    }

    // Contadores para sugerir melhorias de foco/iluminação ao usuário
    let qrErrorCount = 0;
    let qrDecodeCount = 0;

    function setQrStatus(message) {
        if (qrInfoText) qrInfoText.textContent = message || defaultQrMessage;
        else statusText.textContent = message || '';
    }

    const qrZoomControls = document.querySelector('#qr-modal .qr-zoom-controls');
    const qrZoomSlider = document.getElementById('qr-zoom-slider');
    let qrZoomInitialized = false;

    async function initQrZoomControls() {
        if (!qrScanner || !qrZoomSlider || qrZoomInitialized) return;
        if (typeof qrScanner.applyVideoConstraints !== 'function') {
            if (qrZoomControls) qrZoomControls.style.display = 'none';
            return;
        }

        try {
            let caps = null;
            if (typeof qrScanner.getRunningTrackCapabilities === 'function') {
                caps = qrScanner.getRunningTrackCapabilities();
            }

            const zoomCaps = caps && typeof caps.zoom === 'object' ? caps.zoom : null;
            if (!zoomCaps || typeof zoomCaps.min !== 'number' || typeof zoomCaps.max !== 'number') {
                if (qrZoomControls) qrZoomControls.style.display = 'none';
                return;
            }

            qrZoomInitialized = true;
            const min = zoomCaps.min;
            const max = zoomCaps.max;
            const step = zoomCaps.step || 0.1;
            const initial = zoomCaps.default ?? Math.min(Math.max(1, min), max);

            qrZoomSlider.min = String(min);
            qrZoomSlider.max = String(max);
            qrZoomSlider.step = String(step);
            qrZoomSlider.value = String(initial);

            if (qrZoomControls) qrZoomControls.style.display = 'block';

            qrZoomSlider.addEventListener('input', async (event) => {
                const value = Number(event.target.value);
                if (!Number.isFinite(value)) return;
                try {
                    await qrScanner.applyVideoConstraints({
                        advanced: [{ zoom: value }]
                    });
                } catch (e) {
                    // Se der erro, mantém slider mas não quebra leitura
                }
            });

            // aplica valor inicial
            try {
                await qrScanner.applyVideoConstraints({
                    advanced: [{ zoom: initial }]
                });
            } catch (_e) { }
        } catch (_err) {
            if (qrZoomControls) qrZoomControls.style.display = 'none';
        }
    }

    async function startQrScanner() {
        if (!isSecureForCamera()) {
            setQrStatus('No celular, habilite HTTPS ou acesse via localhost para usar a câmera.');
            return;
        }
        qrErrorCount = 0;
        qrDecodeCount = 0;
        qrZoomInitialized = false;
        if (qrZoomControls) qrZoomControls.style.display = 'none';
        setQrStatus('Abrindo câmera...');
        if (qrScanner) {
            safeStopQrScanner();
        }

        const qrLoaded = await loadScriptIfNeeded(
            () => window.Html5Qrcode,
            'https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js',
            'https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js'
        );

        if (!qrLoaded || !window.Html5Qrcode) {
            setQrStatus('Biblioteca de QR não carregou.');
            return;
        }
        const qrRegionId = 'qr-reader';
        const qrElement = document.getElementById(qrRegionId);
        if (!qrElement) {
            setQrStatus('Área de leitura não encontrada.');
            return;
        }

        const qrBoxSize = computeQrBoxSize(qrElement);
        qrElement.style.minHeight = `${qrBoxSize + 40}px`;

        // Tenta forçar uso da câmera traseira
        let cameraConfig = { facingMode: { exact: 'environment' } };
        try {
            const cameras = await Html5Qrcode.getCameras();
            if (cameras && cameras.length) {
                const backCam = cameras.find(c => /back|traseira|rear/i.test(c.label));
                let chosen = backCam;
                if (!chosen) {
                    // Se não conseguir identificar pelo nome, em muitos aparelhos
                    // a última câmera tende a ser a traseira
                    chosen = cameras.length > 1 ? cameras[cameras.length - 1] : cameras[0];
                }
                cameraConfig = { deviceId: { exact: chosen.id } };
            }
        } catch (err) {
            // mantém fallback
        }

        const config = {
            fps: 10,
            qrbox: { width: qrBoxSize, height: qrBoxSize },
            aspectRatio: 1,
            disableFlip: false,
            rememberLastUsedCamera: true,
            // aumenta resolução do vídeo para melhorar leitura
            videoConstraints: {
                width: { ideal: 1280 },
                height: { ideal: 720 },
                facingMode: { ideal: 'environment' }
            }
        };
        qrScanner = new Html5Qrcode(qrRegionId, {
            experimentalFeatures: { useBarCodeDetectorIfSupported: true }
        });

        try {
            await qrScanner.start(
                cameraConfig,
                config,
                (decodedText) => {
                    qrDecodeCount += 1;
                    qrErrorCount = 0;
                    setQrStatus('QR lido, preenchendo formulário...');
                    safeStopQrScanner();
                    setModal(qrModal, false);
                    const parsed = parseQrText(decodedText);
                    openForm(parsed);
                },
                () => {
                    // Erros de leitura contínuos: após algumas tentativas, orienta usuário
                    qrErrorCount += 1;
                    if (qrErrorCount === 10 && qrDecodeCount === 0) {
                        setQrStatus('Dica: aproxime mais o QR Code, mantenha-o centralizado na caixa e melhore a iluminação do ambiente.');
                    }
                }
            );
            // inicializa zoom se o dispositivo suportar
            initQrZoomControls();
            setQrStatus(defaultQrMessage);
        } catch (err) {
            safeStopQrScanner();
            setQrStatus('Não foi possível iniciar a câmera. Verifique permissões/HTTPS e tente novamente.');
        }
    }

    function safeStopQrScanner() {
        if (!qrScanner) return;
        qrScanner.stop().then(() => qrScanner.clear()).catch(() => { }).finally(() => {
            qrScanner = null;
        });
    }

    function stopQrScanner() {
        safeStopQrScanner();
        setQrStatus(defaultQrMessage);
    }

    const openScan = () => setModal(methodModal, true);
    if (openScanBtn) openScanBtn.addEventListener('click', openScan);

    const params = new URLSearchParams(window.location.search);
    if (params.get('open') === 'add' && methodModal) {
        setModal(methodModal, true);
    }

    const chooseManual = document.getElementById('choose-manual');
    if (chooseManual) {
        chooseManual.addEventListener('click', async () => {
            const serial = (serialInput?.value || '').trim();
            if (!serial) {
                if (methodStatus) methodStatus.textContent = 'Informe o Serial Number antes de continuar.';
                return;
            }
            if (methodStatus) methodStatus.textContent = 'Verificando asset...';

            const prefillLoc = {};
            if (userLat !== null && userLng !== null) {
                prefillLoc.last_latitude = userLat;
                prefillLoc.last_longitude = userLng;
            }

            try {
                const checkUrl = `${window.location.origin}/inventory/operation/check/${encodeURIComponent(serial)}`;
                const checkResp = await fetch(checkUrl, { credentials: 'same-origin' });
                if (checkResp.ok) {
                    const payload = {
                        serial_number: serial,
                        last_latitude: prefillLoc.last_latitude,
                        last_longitude: prefillLoc.last_longitude
                    };
                    await saveAsset(payload, { skipFormClose: false });
                    setModal(methodModal, false);
                    if (methodStatus) methodStatus.textContent = '';
                    return;
                }
            } catch (err) {
                // segue fluxo padrão
            }

            if (methodStatus) methodStatus.textContent = '';
            setModal(methodModal, false);
            openForm({ serial_number: serial, ...prefillLoc });
        });
    }

    const chooseQr = document.getElementById('choose-qr');
    if (chooseQr) {
        chooseQr.addEventListener('click', () => {
            if (serialInput) serialInput.value = serialInput.value.trim();
            setModal(methodModal, false);
            setModal(qrModal, true);
            startQrScanner();
        });
    }

    if (filterOutlet) filterOutlet.addEventListener('change', applyFilters);
    if (filterOrder) filterOrder.addEventListener('change', applyFilters);
    if (filterRadius) filterRadius.addEventListener('change', applyFilters);

    document.querySelectorAll('[data-close-modal]').forEach(btn => {
        btn.addEventListener('click', () => {
            const target = btn.getAttribute('data-close-modal');
            const modal = document.getElementById(target);
            if (modal) setModal(modal, false);
            if (target === 'qr-modal') stopQrScanner();
        });
    });

    async function saveAsset(payload, { skipFormClose = false } = {}) {
        statusText.textContent = 'Enviando...';
        try {
            const response = await fetch('{{ url_for('inventory.create_inventory_asset') }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            if (!response.ok) {
                statusText.textContent = result.error || 'Erro ao salvar asset.';
                return { ok: false };
            }

            statusText.textContent = 'Asset salvo com sucesso!';
            if (!skipFormClose) setModal(formModal, false);

            if (result.asset) {
                upsertAssetData(result.asset);
                // Atualiza mini cards de visitas
                const stalePayload = { ...result.asset };
                if (!stalePayload.last_visit_at) {
                    stalePayload.last_visit_at = new Date().toISOString();
                }
                upsertStaleAsset(stalePayload);
                buildOutletOptions();
                applyFilters();
            }

            if (toastEl) {
                const lines = [];
                lines.push(result.updated ? 'Asset atualizado' : 'Asset criado');

                if (result.asset) {
                    const distVal = result.asset.last_visit_distance_m;
                    const latVal = result.asset.last_latitude;
                    const lngVal = result.asset.last_longitude;
                    if (distVal !== undefined && distVal !== null && !Number.isNaN(Number(distVal))) {
                        lines.push(`Movimentação: ${Number(distVal).toFixed(2)} m`);
                    } else if (latVal !== undefined && lngVal !== undefined) {
                        lines.push(`Lat/Lng atualizados: ${latVal}, ${lngVal}`);
                    }
                }

                toastEl.innerHTML = lines.join('<br>');
                toastEl.classList.add('show');
                setTimeout(() => toastEl.classList.remove('show'), 4000);
            }
            return { ok: true };
        } catch (err) {
            statusText.textContent = 'Erro de rede ao salvar asset.';
            return { ok: false };
        }
    }

    formElement.addEventListener('submit', async (event) => {
        event.preventDefault();
        const payload = {
            serial_number: fieldSerial.value.trim(),
            asset_type: fieldType.value.trim(),
            material: fieldMaterial.value.trim(),
            outlet_name: fieldOutlet.value.trim(),
            street: fieldStreet.value.trim(),
            city: fieldCity.value.trim(),
            last_latitude: fieldLat.value.trim(),
            last_longitude: fieldLng.value.trim(),
            notes: fieldNotes.value.trim(),
        };
        await saveAsset(payload);
    });

    buildOutletOptions();
    applyFilters();
    initMap();
    });
</script>
{% endblock %}

<div class="toast" id="scan-toast"></div>

{% block sidebar %}
<!-- Inventory sidebar with Operação link -->
<aside class="sidebar" id="sidebar">
    <div class="sidebar-logo">
        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="VivaAI Logo">
    </div>
    <div class="sidebar-header">
        <a href="{{ url_for('inventory.render_inventory_list') }}" class="sidebar-title">
            <span>Inventário Viva<sup>AI</sup></span>
        </a>
    </div>
    <nav class="sidebar-nav">
        <div class="sidebar-nav-section">
            <div class="sidebar-nav-title">Principal</div>
            <a href="{{ url_for('inventory.render_inventory_list') }}"
                class="sidebar-nav-link {% if request.path.startswith('/inventory/list') or request.path == '/inventory/' or request.path == '/inventory' %}active{% endif %}">
                <i class="fas fa-boxes"></i>
                <span>Inventário</span>
            </a>
            <a href="{{ url_for('inventory.render_inventory_operation') }}"
                class="sidebar-nav-link {% if request.path.startswith('/inventory/operation') %}active{% endif %}">
                <i class="fas fa-cogs"></i>
                <span>Operação</span>
            </a>
            <a href="{{ url_for('inventory.render_inventory_visits') }}"
                class="sidebar-nav-link {% if request.path.startswith('/inventory/visits') %}active{% endif %}">
                <i class="fas fa-route"></i>
                <span>Visitas</span>
            </a>
        </div>
    </nav>
    <div class="sidebar-footer">
        <div class="sidebar-user">
            <div class="sidebar-user-avatar">
                {{ user_name[0:2].upper() if user_name else 'US' }}
            </div>
            <div class="sidebar-user-info">
                <span class="sidebar-user-name">{{ user_name or 'Usuário' }}</span>
                <span class="sidebar-user-role">{{ user_email or '' }}</span>
            </div>
        </div>
        <form action="{{ url_for('logout') }}" method="post" style="margin: 0;">
            <button type="submit" class="btn-logout" title="Sair do sistema">
                <i class="fas fa-sign-out-alt"></i>
                <span>Sair</span>
            </button>
        </form>
    </div>
</aside>
{% endblock %}
